<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8"/>
        <title>The Flowers Are Still Standing</title>
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <meta name="description" content="" />
        <meta name="author" content="Jonathan Pearlin" />
        <meta name="keywords" content="" />
        <meta name="generator" content="JBake" />

        <!-- Le styles -->
        <link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css">
        <link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap-theme.min.css">
        <link href="/blog/css/asciidoctor.css" rel="stylesheet">
        <link href="/blog/css/base.css" rel="stylesheet">
        <link href="//netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.css" rel="stylesheet">
        <link href='http://fonts.googleapis.com/css?family=Droid+Sans' rel='stylesheet' type='text/css'>
        <link href='/blog/css/octicons.min.css' rel='stylesheet' type='text/css'>

        <!-- HTML5 shim, for IE6-8 support of HTML5 elements -->
        <!--[if lt IE 9]>
              <script src="/blog/js/html5shiv.js"></script>
        <![endif]-->

        <!-- Fav and touch icons -->
        <!--
        <link rel="apple-touch-icon-precomposed" sizes="144x144" href="../assets/ico/apple-touch-icon-144-precomposed.png" />
        <link rel="apple-touch-icon-precomposed" sizes="114x114" href="../assets/ico/apple-touch-icon-114-precomposed.png" />
        <link rel="apple-touch-icon-precomposed" sizes="72x72" href="../assets/ico/apple-touch-icon-72-precomposed.png" />
        <link rel="apple-touch-icon-precomposed" href="../assets/ico/apple-touch-icon-57-precomposed.png" />
        -->
        <link rel="shortcut icon" href="/blog/favicon.ico" />
    </head>
    <body>
        <div id="wrap">
            <!-- Fixed navbar -->
            <div class="navbar navbar-default navbar-fixed-top" role="navigation">
            <a href="https://github.com/jdpgrailsdev" target="_blank"><img style="position: absolute; top: 0; right: 0; border: 0;" src="https://camo.githubusercontent.com/a6677b08c955af8400f44c6298f40e7d19cc5b2d/68747470733a2f2f73332e616d617a6f6e6177732e636f6d2f6769746875622f726962626f6e732f666f726b6d655f72696768745f677261795f3664366436642e706e67" alt="Fork me on GitHub" data-canonical-src="https://s3.amazonaws.com/github/ribbons/forkme_right_gray_6d6d6d.png"></a>
                <div class="container">
                    <div class="navbar-header">
                        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                            <span class="icon-bar"></span>
                            <span class="icon-bar"></span>
                            <span class="icon-bar"></span>
                        </button>
                        <a class="navbar-brand" href="/blog/index.html">Jonathan Pearlin's Blog</a>
                    </div>
                    <div class="navbar-collapse collapse">
                        <ul class="nav navbar-nav">
                            <li><a href="/blog/about.html">About</a></li>
                            <li><a href="/blog/resume.html">Résumé</a></li>
                            <li><a href="/blog/friends.html">Friends</a></li>
                            <li class="dropdown">
                                <a data-toggle="dropdown" href="#">Tags<b class="caret"></b></a>
                                <ul class="dropdown-menu" role="menu">
                                    <li><a href="/blog/tags/docker.html">Docker</a></li>
                                    <li><a href="/blog/tags/gradle.html">Gradle</a></li>
                                    <li><a href="/blog/tags/grails.html">Grails</a></li>
                                    <li><a href="/blog/tags/groovy.html">Groovy</a></li>
                                    <li><a href="/blog/tags/java.html">Java</a></li>
                                    <li><a href="/blog/tags/maven.html">Maven</a></li>
                                    <li><a href="/blog/tags/spring.html">Spring</a></li>
                                    <li><a href="/blog/tags/zookeeper.html">ZooKeeper</a></li>
                                </ul>
                            </li>
                            <li><a href="/blog/feed.xml">Feed</a></li>
                        </ul>
                        <ul class="nav navbar-nav navbar-right">
                            <li><a href="https://github.com/jdpgrailsdev" target="_blank"><i class="fa fa-github"></i></a></li>
                            <li><a href="http://www.linkedin.com/pub/jonathan-pearlin/4/946/9a0" style="text-decoration:none;" target="_blank"><i class="fa fa-linkedin-square"></i></a></li>
                        </ul>
                    </div>
                </div>
            </div>
            <div id="activity" class="pull-left">
                <div class="panel panel-primary">
                      <!-- Default panel contents -->
                      <div class="panel-heading"><a target="_blank" href="http://github.com/jdpgrailsdev?tab=activity"><i class="fa fa-github"></i> My Recent GitHub Activity</a></div>
                      <div class="panel-body">
                          <i class='icon-spinner icon-spin icon-large'></i> Loading...
                      </div>
                      <!-- List group -->
                      <ul class="list-group">
                      </ul>
                </div>
            </div>
            <div class="container">
                <div class="page-header">
                    <h1>The Flowers Are Still Standing</h1>
                </div>

                   <a href="/blog/2015/01/20/spring_transactions_rollback.html"><h1>Rollbacks with Spring Transactions</h1></a>
                   <p>20 January 2015</p>
                <p><em>Tags: </em>
                <a href="/blog/tags/spring.html">spring</a>
        
                <a href="/blog/tags/java.html">java</a>
        </p>

                <div class="g-plusone" data-size="medium" data-href="http://jdpgrailsdev.github.io/blog/2015/01/20/spring_transactions_rollback.html"></div>
                <script type="IN/Share" data-url="http://jdpgrailsdev.github.io/blog/2015/01/20/spring_transactions_rollback.html" data-counter="right"></script>
                <div class="fb-like" data-href="http://jdpgrailsdev.github.io/blog/2015/01/20/spring_transactions_rollback.html" data-layout="button_count" data-action="like" data-show-faces="false" data-share="true"></div>

                   <p><div class="paragraph">
<p>By default, no rollback handling rules are defined if you simply add <code>@Transactional</code> to your method.  In order for the rollback to actually be executed upon failure,
you must define one or more exceptions that you want to trigger a rollback via the <code>rollbackFor</code> or <code>rollbackForClassName</code> attributes of the annotation:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">@Transactional(rollbackForClassName={"Exception"})
public void save(final Book book) {
    Author author = new Author(book.getAuthorName());
    authorRepository.saveAndFlush(author);
    bookRepository.saveAndFlush(book);
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>In the example above, the <code>@Transactional</code> annotation makes use of the <code>rollbackForClassName</code> attribute value to force
a database rollback if any exception of type <code>java.lang.Exception</code> is thrown by the method (e.g. if any exception happens,
roll both save operations back).  The <code>rollbackForClassName</code> attribute actually provides a little more flexibility than the
<code>rollbackFor</code> attribute value.  From the <code>@Transactional</code> JavaDoc:</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>Consider carefully how specific the pattern is, and whether
to include package information (which isn&#8217;t mandatory). For example,
"Exception" will match nearly anything, and will probably hide other rules.
"java.lang.Exception" would be correct if "Exception" was meant to define
a rule for all checked exceptions. With more unusual java.lang.Exception
names such as "BaseBusinessException" there is no need to use a FQN.</p>
</div>
</blockquote>
<div class="attribution">
&#8212; org.springframework.transaction.annotation.Transactional#rollbackForClassName() JavaDoc
</div>
</div>
<div class="paragraph">
<p>As you can see, it gives you the ability to provide rules to match certain sub-strings of exception
types to better control your rollback logic.</p>
</div></p>
                <p><a href="/blog2015/01/20/spring_transactions_rollback.html#disqus_thread">Comments</a></p>
                   <a href="/blog/2015/01/13/jenkins_check_job_status.html"><h1>Check Jenkins Job Status via REST API</h1></a>
                   <p>07 January 2015</p>
                <p><em>Tags: </em>
                <a href="/blog/tags/jenkins.html">jenkins</a>
        </p>

                <div class="g-plusone" data-size="medium" data-href="http://jdpgrailsdev.github.io/blog/2015/01/13/jenkins_check_job_status.html"></div>
                <script type="IN/Share" data-url="http://jdpgrailsdev.github.io/blog/2015/01/13/jenkins_check_job_status.html" data-counter="right"></script>
                <div class="fb-like" data-href="http://jdpgrailsdev.github.io/blog/2015/01/13/jenkins_check_job_status.html" data-layout="button_count" data-action="like" data-show-faces="false" data-share="true"></div>

                   <p><div class="paragraph">
<p>There are a ton of <a href="http://jenkins-ci.org/" target="_blank">Jenkins</a> plugins out there that let you control when a job should run based on the status of
other builds.  However, plugins typically become out of date pretty quickly.  If you don&#8217;t want to have to play
the plugin update game, you can use a little bash magic to leverage the <a href="http://jenkins-ci.org/" target="_blank">Jenkins</a> REST API to check the status
of other jobs before running your builds.  Let&#8217;s assume that you have a job named <code>other-job</code> that must be in
a success state in order for another job to execute.  You can check the status of the <code>other-job</code> by using
the <a href="http://jenkins-ci.org/" target="_blank">Jenkins</a> REST API as part of an executed shell in the job&#8217;s configuration:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-shell" data-lang="shell">job_status=`curl https://jenkins/view/job/other-job/lastBuild/api/json | grep "\"result\":\"SUCCESS\""`

if [ -n "$job_status" ]
then
    # Run your script commands here
else
  echo "BUILD FAILURE: Other build is unsuccessful or status could not be obtained."
  exit 1
fi</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>then</code> block of this other job could even do something like invoke another build that has a parameterized configuration to run your
actual build via the REST API.  This would allow you to have the job with the configuration above check the status of <code>other-job</code> first
and then kick of a third job that actual performs the build, but only if the first job is successful, all without
installing any additional plugins.</p>
</div></p>
                <p><a href="/blog2015/01/13/jenkins_check_job_status.html#disqus_thread">Comments</a></p>
                   <a href="/blog/2015/01/06/email_inline_style_jsoup_cssparser.html"><h1>Using CSS Parser and JSoup to Inline Styles for Web Mail</h1></a>
                   <p>06 January 2015</p>
                <p><em>Tags: </em>
                <a href="/blog/tags/java.html">java</a>
        
                <a href="/blog/tags/spring.html">spring</a>
        </p>

                <div class="g-plusone" data-size="medium" data-href="http://jdpgrailsdev.github.io/blog/2015/01/06/email_inline_style_jsoup_cssparser.html"></div>
                <script type="IN/Share" data-url="http://jdpgrailsdev.github.io/blog/2015/01/06/email_inline_style_jsoup_cssparser.html" data-counter="right"></script>
                <div class="fb-like" data-href="http://jdpgrailsdev.github.io/blog/2015/01/06/email_inline_style_jsoup_cssparser.html" data-layout="button_count" data-action="like" data-show-faces="false" data-share="true"></div>

                   <p><div class="paragraph">
<p>As part of an on-going project, we had a requirement to send pretty (CSS-ified) e-mails to communicate status.  Sending HTML-based e-mails from Java is pretty easy.  There
are a ton of templating engines out there that can be used to generate HTML.  However, what most people fail to realize is that most web mail providers (e.g. Gmail, Yahoo!, etc) handle a limited
subset of standard CSS.  You can find out what is supported by looking at <a href="https://www.campaignmonitor.com/css/" target="_blank">Campaign Monitor CSS Support</a>.  The first thing you might notice is that almost all of the web mail providers
do not support CSS classes.  They do, however, support inline style declarations.  Being a good developer, you know that you want to keep all of your CSS in style sheets so
that you do not have to find and replace styles in multiple templates/files.  This poses a problem if the clients can only support inline styles.  The solution?  A combination
of <a href="http://jsoup.org/" target="_blank">JSoup</a> and <a href="http://cssparser.sourceforge.net/" target="_blank">CSS Parser</a> to load and convert a style sheet into inline style declarations.  The solution in this blog post uses <a href="http://cssparser.sourceforge.net/" target="_blank">CSS Parser</a> to parse a CSS style sheet file
loaded from the classpath into a set of <code>CSSSytleRule</code> objects.  It then uses <a href="http://jsoup.org/" target="_blank">JSoup</a> to walk the DOM in the HTML and find elements that match the rules present in the parsed style sheet.  To start, you
need to include the <a href="http://cssparser.sourceforge.net/" target="_blank">CSS Parser</a> and <a href="http://jsoup.org/" target="_blank">JSoup</a> dependencies:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">compile 'org.jsoup:jsoup:1.8.1'
compile 'net.sourceforge.cssparser:cssparser:0.9.14'</code></pre>
</div>
</div>
<div class="paragraph">
<p>Next, create the <code>CSSOMParser</code> used to parse the CSS style sheet and load the style sheet from the classpath:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">import com.steadystate.css.parser.CSSOMParser;

import org.w3c.dom.css.CSSStyleSheet;

...

CSSOMParser parser = new CSSOMParser();
CSSStyleSheet stylesheet = parser.parseStyleSheet(new InputSource(new InputStreamReader(getClass().getResourceAsStream("/css/styles.css"))), null, null);</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now that we have our style sheet loaded and parsed, we can use the following code to walk the DOM and add inline style declarations
to elements that match the rules contained in the style sheet:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">final Document document = Jsoup.parse(originalHtml);
final CSSRuleList rules = stylesheet.getCssRules();
final Map&lt;Element, Map&lt;String, String&gt;&gt; elementStyles = new HashMap&lt;&gt;();

/*
 * For each rule in the style sheet, find all HTML elements that match
 * based on its selector and store the style attributes in the map with
 * the selected element as the key.
 */
for (int i = 0; i &lt; rules.getLength(); i++) {
    final CSSRule rule = rules.item(i);
    if (rule instanceof CSSStyleRule) {
        final CSSStyleRule styleRule = (CSSStyleRule) rule;
        final String selector = styleRule.getSelectorText();

        // Ignore pseudo classes, as JSoup's selector cannot handle
        // them.
        if (!selector.contains(":")) {
            final Elements selectedElements = document.select(selector);
            for (final Element selected : selectedElements) {
                if (!elementStyles.containsKey(selected)) {
                    elementStyles.put(selected, new LinkedHashMap&lt;String, String&gt;());
                }

                final CSSStyleDeclaration styleDeclaration = styleRule.getStyle();

                for (int j = 0; j &lt; styleDeclaration.getLength(); j++) {
                    final String propertyName = styleDeclaration.item(j);
                    final String propertyValue = styleDeclaration.getPropertyValue(propertyName);
                    final Map&lt;String, String&gt; elementStyle = elementStyles.get(selected);
                    elementStyle.put(propertyName, propertyValue);
                }

            }
        }
    }
}

/*
 * Apply the style attributes to each element and remove the "class"
 * attribute.
 */
for (final Map.Entry&lt;Element, Map&lt;String, String&gt;&gt; elementEntry : elementStyles.entrySet()) {
    final Element element = elementEntry.getKey();
    final StringBuilder builder = new StringBuilder();
    for (final Map.Entry&lt;String, String&gt; styleEntry : elementEntry.getValue().entrySet()) {
        builder.append(styleEntry.getKey()).append(":").append(styleEntry.getValue()).append(";");
    }
    builder.append(element.attr("style"));
    element.attr("style", builder.toString());
    element.removeAttr("class");
}

System.out.println(document.html());</code></pre>
</div>
</div>
<div class="paragraph">
<p>One important thing to note in the code above is that <a href="http://jsoup.org/" target="_blank">JSoup</a> cannot handle pseudo classes in selectors.  Therefore, any
selector that contains a colon (":") is ignored.  Otherwise, each selector contained in the parsed sytle sheet is applied
to the HTML.  Inline styles are appended to each other, so ordering in your CSS stylesheet matters!  The output of the
code above is the modified HTML with all styles that could be applied converted to inline style declarations.  Now, when
this HTML is interpreted in a web mail client, it will look as it was intended to look by the developer.</p>
</div></p>
                <p><a href="/blog2015/01/06/email_inline_style_jsoup_cssparser.html#disqus_thread">Comments</a></p>
                   <a href="/blog/2014/12/30/groovy_script_spring_boot_yaml.html"><h1>Leverage Spring Boot&#8217;s YAML Configuration Files in Groovy Scripts</h1></a>
                   <p>30 December 2014</p>
                <p><em>Tags: </em>
                <a href="/blog/tags/spring.html">spring</a>
        
                <a href="/blog/tags/groovy.html">groovy</a>
        </p>

                <div class="g-plusone" data-size="medium" data-href="http://jdpgrailsdev.github.io/blog/2014/12/30/groovy_script_spring_boot_yaml.html"></div>
                <script type="IN/Share" data-url="http://jdpgrailsdev.github.io/blog/2014/12/30/groovy_script_spring_boot_yaml.html" data-counter="right"></script>
                <div class="fb-like" data-href="http://jdpgrailsdev.github.io/blog/2014/12/30/groovy_script_spring_boot_yaml.html" data-layout="button_count" data-action="like" data-show-faces="false" data-share="true"></div>

                   <p><div class="paragraph">
<p>In a <a href="http://jdpgrailsdev.github.io/blog/2014/12/16/spring_context_groovy_script.html" target="_blank">previous</a> blog post, I discussed how to load
an application&#8217;s <a href="http://projects.spring.io/spring-framework/" target="_blank">Spring Framework</a> configuration in a <a href="http://groovy.codehaus.org/" target="_blank">Groovy</a> script.  This is a great way to test portions of your application without running the
entire application.  However, this approach has limits.  When trying this with a <a href="http://projects.spring.io/spring-boot/" target="_blank">Spring Boot</a> application, you miss out on a bunch of the magical
auto-enabling done by <a href="http://projects.spring.io/spring-boot/" target="_blank">Spring Boot</a>.  This includes the ability of <a href="http://projects.spring.io/spring-boot/" target="_blank">Spring Boot</a> to find certain properties and configuration files and load their
contents for use by <a href="http://projects.spring.io/spring-framework/" target="_blank">Spring Framework</a>'s property placeholder mechanism.  In this post, I&#8217;ll discuss how to include a little extra <a href="http://groovy.codehaus.org/" target="_blank">Groovy</a> sauce to get the
<a href="http://projects.spring.io/spring-framework/" target="_blank">Spring Framework</a> context to load a YAML file from the classpath and use its values for property placeholder replacement.  Let&#8217;s start by looking at how
to tell the <a href="http://projects.spring.io/spring-framework/" target="_blank">Spring Framework</a> context how to load the YAML file:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">class YamlMapPropertySourceLoader extends YamlPropertySourceLoader {

    @Override
    public PropertySource load(String name, Resource resource, String profile) throws IOException {
        if (ClassUtils.isPresent(Yaml.class.name, null)) {
            final YamlMapFactoryBean bean = new YamlMapFactoryBean();
            YamlMapFactoryBean factory = new YamlMapFactoryBean()
            factory.setDocumentMatchers(new DefaultProfileDocumentMatcher(), new SpringProfileDocumentMatcher(profile))
            factory.setResolutionMethod(ResolutionMethod.OVERRIDE)
            factory.setResources([resource] as Resource[])
            return new MapPropertySource(name, factory.getObject())
        }
        null
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The code above defines a new <code>PropertySourceLoader</code> class that produces a <code>PropertySource</code> wrapping the loaded YAML file.  This bean is responsible for reading
in the contents of the <code>Resource</code> that contains the YAML file loaded from the classpath and converting those values to a <code>Map</code> that can be used
by the property placeholder resolver.  You may notice that it checks to see the <a href="https://code.google.com/p/snakeyaml/" target="_blank">Snakeyaml</a> library is on the classpath.  This code is a copy of
the code found in the <a href="http://projects.spring.io/spring-boot/" target="_blank">Spring Boot</a> <code>YamlPropertySourceLoader</code>, with a small tweak to use the <code>YamlMapFactoryBean</code> instead of the <code>YamlPropertiesFactoryBean</code>
(more on this in a bit).  The next step is to create a new Java-based configuration class to register the new <code>YamlMapPropertySourceLoader</code> with the <a href="http://projects.spring.io/spring-framework/" target="_blank">Spring Framework</a>
context:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">@Configuration
@Order(Ordered.HIGHEST_PRECEDENCE)
class YamlConfiguration {

    @Bean
    public static EnvironmentAwarePropertySourcesPlaceholderConfigurer propertySourcesPlaceholderConfigurer(PropertySource yamlPropertySourceLoader) {
        MutablePropertySources propertySources = new MutablePropertySources()
        propertySources.addFirst(yamlPropertySourceLoader)

        EnvironmentAwarePropertySourcesPlaceholderConfigurer configurer = new EnvironmentAwarePropertySourcesPlaceholderConfigurer()
        configurer.propertySources = propertySources
        configurer
    }

    @Bean
    public PropertySource yamlPropertySourceLoader() throws IOException {
      YamlMapPropertySourceLoader loader = new YamlMapPropertySourceLoader()
      PropertySource applicationYamlPropertySource = loader.load('application.yml', new ClassPathResource('application.yml', getClass()), 'integration')
      applicationYamlPropertySource
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The configuration above creates two beans:  one to enable the resolving of property placeholders based on the active profile and another to
actually find and load the YAML configuration file from the classpath.  The special <code>PropertySourcePlaceholderConfiguration</code> is necessary to make
sure that the configuration loaded from the classpath is added to the <a href="http://projects.spring.io/spring-framework/" target="_blank">Spring Framework</a> framework context.  Otherwise, simply provided the loader is not
enough to expose the loaded data to the context.  This custom class provides a mechanism to merge the newly found and created property source with those
provided by <a href="http://projects.spring.io/spring-framework/" target="_blank">Spring Framework</a>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">class EnvironmentAwarePropertySourcesPlaceholderConfigurer extends PropertySourcesPlaceholderConfigurer implements EnvironmentAware, InitializingBean {

    MutablePropertySources propertySources
    Environment environment

    @Override
    public void setEnvironment(Environment environment) {
        this.environment = environment
        super.setEnvironment(environment)
    }

    @Override
    public void afterPropertiesSet() throws Exception {
        def envPropertySources = environment.getPropertySources()
        propertySources.each { propertySource -&gt;
            envPropertySources.addFirst(propertySource)
        }
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The custom configurer uses the loaded YAML property source and the configured <code>Environment</code> to create a combined set of property sources that can be used for property placeholder replacement.
Once you have this new configuration class in place, you need to register it with the <a href="http://projects.spring.io/spring-framework/" target="_blank">Spring Framework</a> context:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">...
ctx.register(YamlConfiguration)
ctx.refresh()</code></pre>
</div>
</div>
<div class="paragraph">
<p>After wiring all of this together and running the <a href="http://groovy.codehaus.org/" target="_blank">Groovy</a> script, I noticed that the script was upset with some, but not all, of the property placeholders.  After some digging around, I noticed
that it was having issues with finding nested values in the YAML configuration.  For instance, let&#8217;s say you have the following YAML configuration file:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-yaml" data-lang="yaml">service:
    host.url: 'localhost'
settings:
    timeout: 30
    connection.timeout = 100
debug: false</code></pre>
</div>
</div>
<div class="paragraph">
<p>You would expect to be able to do something like this using the <a href="http://projects.spring.io/spring-framework/" target="_blank">Spring Framework</a> <code>Value</code> annotation:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">@Value("${service.host.url}")
private String hostUrl;</code></pre>
</div>
</div>
<div class="paragraph">
<p>However, because the <a href="https://code.google.com/p/snakeyaml/" target="_blank">Snakeyaml</a> library that backs the <code>YamlMapFactoryBean</code> does a literal translation of the configuration to map, separating keys wherever it finds a '.' character, the resolver
cannot find the key <code>service.host.url</code> (it could find <code>service</code> and <code>host</code> under <code>service</code>, etc).  One way to resolve this is to flatten out the map after loading it, but before returning it from the
property source:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">class YamlMapPropertySourceLoader extends YamlPropertySourceLoader {

    @Override
    public PropertySource load(String name, Resource resource, String profile) throws IOException {
        if (ClassUtils.isPresent(Yaml.class.name, null)) {
            final YamlMapFactoryBean bean = new YamlMapFactoryBean();
            YamlMapFactoryBean factory = new YamlMapFactoryBean()
            factory.setDocumentMatchers(new DefaultProfileDocumentMatcher(), new SpringProfileDocumentMatcher(profile))
            factory.setResolutionMethod(ResolutionMethod.OVERRIDE)
            factory.setResources([resource] as Resource[])
            return new MapPropertySource(name, flattenMap(factory.getObject()))
        }
        null
    }

        private Map flattenMap(Map aMap, prefix=null) {
        aMap.inject([:]) { map, entry -&gt;
            if(entry.value instanceof Map) {
                map += flattenMap(entry.value, createKey(prefix, entry.key))
            } else {
                map."${createKey(prefix, entry.key)}" = entry.value
            }
            map
        }
    }

    private String createKey(prefix, key) {
        (prefix?.length() &gt; 0) ? "${prefix}.${key}" : key
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>In this updated version of the <code>YamlMapPropertySourceLoader</code>, we use some <a href="http://groovy.codehaus.org/" target="_blank">Groovy</a>-foo to flatten out the map so that the keys will match the strings provided to the <code>Value</code> annotation.  Now, when this is combined
together and executed, you can run:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">ctx.getEnvironment().getProperty('service.host.url')</code></pre>
</div>
</div>
<div class="paragraph">
<p>to resolve a property placeholder value retrieved from a YAML configuration file in your <a href="http://groovy.codehaus.org/" target="_blank">Groovy</a> script!</p>
</div></p>
                <p><a href="/blog2014/12/30/groovy_script_spring_boot_yaml.html#disqus_thread">Comments</a></p>

                <hr />

                <p>Older posts are available in the <a href="/blog/archive.html">archive</a>.</p>

            </div>
            <div id="push"></div>
        </div>

        <div id="footer">
              <div class="container">
                <p class="muted credit">&copy; 2014 | Mixed with <a href="http://getbootstrap.com/">Bootstrap v3.1.1</a> | Baked with <a href="http://jbake.org">JBake v2.3.2</a> | Comments powered by <a href="http://disqus.com">Disqus</a></p>
              </div>
        </div>

        <!-- Le javascript
        ================================================== -->
        <!-- Placed at the end of the document so the pages load faster -->
        <script src="https://code.jquery.com/jquery.js" type="text/javascript"></script>
        <script src="//netdna.bootstrapcdn.com/bootstrap/3.1.1/js/bootstrap.min.js" type="text/javascript"></script>
        <script src="/blog/js/run_prettify.js" type="text/javascript"></script>
        <script src="/blog/js/github_activity.js" type="text/javascript"></script>
        <script type="text/javascript">
            /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
            var disqus_shortname = 'jdpearlin'; // required: replace example with your forum shortname

            /* * * DON'T EDIT BELOW THIS LINE * * */
            (function() {
                var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
                dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
                (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
            })();
        </script>
        <script type="text/javascript">
              window.___gcfg = {lang: 'en'};

              (function() {
                var po = document.createElement('script'); po.type = 'text/javascript'; po.async = true;
                po.src = 'https://apis.google.com/js/plusone.js';
                var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(po, s);
              })();
        </script>
        <script type="text/javascript">
            (function(d, s, id) {
                  var js, fjs = d.getElementsByTagName(s)[0];
                  if (d.getElementById(id)) return;
                  js = d.createElement(s); js.id = id;
                  js.src = "//connect.facebook.net/en_US/all.js#xfbml=1";
                  fjs.parentNode.insertBefore(js, fjs);
            }(document, 'script', 'facebook-jssdk'));
        </script>
        <script src="//platform.linkedin.com/in.js" type="text/javascript"></script>
        <script type="text/javascript">
          (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
          (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
          m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
          })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

          ga('create', 'UA-47885115-1', 'jdpgrailsdev.github.io');
          ga('send', 'pageview');
        </script>
    </body>
</html>
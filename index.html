<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8"/>
        <title>The Flowers Are Still Standing</title>
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <meta name="description" content="" />
        <meta name="author" content="Jonathan Pearlin" />
        <meta name="keywords" content="" />
        <meta name="generator" content="JBake" />

        <!-- Le styles -->
        <link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css">
        <link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap-theme.min.css">
        <link href="/blog/css/asciidoctor.css" rel="stylesheet">
        <link href="/blog/css/base.css" rel="stylesheet">
        <link href="//netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.css" rel="stylesheet">
        <link href='http://fonts.googleapis.com/css?family=Droid+Sans' rel='stylesheet' type='text/css'>
        <link href='/blog/css/octicons.min.css' rel='stylesheet' type='text/css'>

        <!-- HTML5 shim, for IE6-8 support of HTML5 elements -->
        <!--[if lt IE 9]>
              <script src="/blog/js/html5shiv.js"></script>
        <![endif]-->

        <!-- Fav and touch icons -->
        <!--
        <link rel="apple-touch-icon-precomposed" sizes="144x144" href="../assets/ico/apple-touch-icon-144-precomposed.png" />
        <link rel="apple-touch-icon-precomposed" sizes="114x114" href="../assets/ico/apple-touch-icon-114-precomposed.png" />
        <link rel="apple-touch-icon-precomposed" sizes="72x72" href="../assets/ico/apple-touch-icon-72-precomposed.png" />
        <link rel="apple-touch-icon-precomposed" href="../assets/ico/apple-touch-icon-57-precomposed.png" />
        -->
        <link rel="shortcut icon" href="/blog/favicon.ico" />
    </head>
    <body>
        <div id="wrap">
            <!-- Fixed navbar -->
            <div class="navbar navbar-default navbar-fixed-top" role="navigation">
            <a href="https://github.com/jdpgrailsdev" target="_blank"><img style="position: absolute; top: 0; right: 0; border: 0;" src="https://camo.githubusercontent.com/a6677b08c955af8400f44c6298f40e7d19cc5b2d/68747470733a2f2f73332e616d617a6f6e6177732e636f6d2f6769746875622f726962626f6e732f666f726b6d655f72696768745f677261795f3664366436642e706e67" alt="Fork me on GitHub" data-canonical-src="https://s3.amazonaws.com/github/ribbons/forkme_right_gray_6d6d6d.png"></a>
                <div class="container">
                    <div class="navbar-header">
                        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                            <span class="icon-bar"></span>
                            <span class="icon-bar"></span>
                            <span class="icon-bar"></span>
                        </button>
                        <a class="navbar-brand" href="/blog/index.html">Jonathan Pearlin's Blog</a>
                    </div>
                    <div class="navbar-collapse collapse">
                        <ul class="nav navbar-nav">
                            <li><a href="/blog/about.html">About</a></li>
                            <li><a href="/blog/resume.html">Résumé</a></li>
                            <li><a href="/blog/friends.html">Friends</a></li>
                            <li class="dropdown">
                                <a data-toggle="dropdown" href="#">Tags<b class="caret"></b></a>
                                <ul class="dropdown-menu" role="menu">
                                    <li><a href="/blog/tags/docker.html">Docker</a></li>
                                    <li><a href="/blog/tags/gradle.html">Gradle</a></li>
                                    <li><a href="/blog/tags/grails.html">Grails</a></li>
                                    <li><a href="/blog/tags/groovy.html">Groovy</a></li>
                                    <li><a href="/blog/tags/java.html">Java</a></li>
                                    <li><a href="/blog/tags/maven.html">Maven</a></li>
                                    <li><a href="/blog/tags/spring.html">Spring</a></li>
                                    <li><a href="/blog/tags/zookeeper.html">ZooKeeper</a></li>
                                </ul>
                            </li>
                            <li><a href="/blog/feed.xml">Feed</a></li>
                        </ul>
                        <ul class="nav navbar-nav navbar-right">
                            <li><a href="https://github.com/jdpgrailsdev" target="_blank"><i class="fa fa-github"></i></a></li>
                            <li><a href="http://www.linkedin.com/pub/jonathan-pearlin/4/946/9a0" style="text-decoration:none;" target="_blank"><i class="fa fa-linkedin-square"></i></a></li>
                        </ul>
                    </div>
                </div>
            </div>
            <div id="activity" class="pull-left">
                <div class="panel panel-primary">
                      <!-- Default panel contents -->
                      <div class="panel-heading"><a target="_blank" href="http://github.com/jdpgrailsdev?tab=activity"><i class="fa fa-github"></i> My Recent GitHub Activity</a></div>
                      <div class="panel-body">
                          <i class='icon-spinner icon-spin icon-large'></i> Loading...
                      </div>
                      <!-- List group -->
                      <ul class="list-group">
                      </ul>
                </div>
            </div>
            <div class="container">
                <div class="page-header">
                    <h1>The Flowers Are Still Standing</h1>
                </div>

                   <a href="/blog2014/09/02/gradle_subtask_dependson.html"><h1>Ensure Order of Task Execution between Gradle Sub-Projects</h1></a>
                   <p>02 September 2014</p>
                <p><em>Tags: </em>
                <a href="/blog/tags/gradle.html">gradle</a>
        </p>

                <div class="g-plusone" data-size="medium" data-href="http://jdpgrailsdev.github.io/blog2014/09/02/gradle_subtask_dependson.html"></div>
                <script type="IN/Share" data-url="http://jdpgrailsdev.github.io/blog2014/09/02/gradle_subtask_dependson.html" data-counter="right"></script>
                <div class="fb-like" data-href="http://jdpgrailsdev.github.io/blog2014/09/02/gradle_subtask_dependson.html" data-layout="button_count" data-action="like" data-show-faces="false" data-share="true"></div>

                   <p><div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>One of the great things (IMHO) about <a href="http://gradle.org" target="_blank">Gradle</a> is that it does a pretty good job of choosing sane conventions.  That being said, one place that seems to not always
be a great choice is <a href="http://gradle.org" target="_blank">Gradle</a>'s convention to visit sub-projects in alpha-numerical order.  Let&#8217;s say that you have the following project structure:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>root
 |_ A
 |_ B
    |_ C
    |_ D
 |_ E</pre>
</div>
</div>
<div class="paragraph">
<p>Based on the alpha-numerical ordering, you would probably expect <a href="http://gradle.org" target="_blank">Gradle</a> to visit the projects in the following order:  A, B, B:C, B:D, E.  However, this is not the case.
<a href="http://gradle.org" target="_blank">Gradle</a> will visit the sub-projects in alpha-numerical order, within each level.  What you end up with is:  A, B, E, B:C, B:D.  Normally, this probably isn&#8217;t a big deal.
This does become a big deal when one of those sub-projects builds a distribution that needs to include output from all of the other sub-projects.  Such is the case when
building a fully-repackaged, executable JAR file with <a href="http://projects.spring.io/spring-boot/" target="_blank">Spring Boot</a>.  The repackaged JAR built by the
<a href="http://docs.spring.io/spring-boot/docs/current/reference/html/build-tool-plugins-gradle-plugin.html" target="_blank">Spring Boot Gradle Plugin</a> includes all dependency JAR files
required to execute the application.  Let&#8217;s suppose in our example above, the sub-project E&#8217;s <code>build.gradle</code> script includes the following dependency block:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint groovy language-groovy"><code>dependencies {
    compile module(':A')
    compile module(':B:C')
    compile module(':B:D')
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>What we would like to happen is that when we build project "E", the JAR file should include the JAR&#8217;s produced by building "A", "B:C", and "B:D".  What actually happens is
that only "A"'s JAR gets included, because of the ordering outlined earlier in this post.  The way to correct this behavior and to ensure that all other sub-projects build
their JAR files prior to "E"'s JAR task executing is to add the following to "E"'s <code>build.gradle</code> script:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint groovy language-groovy"><code>// Ensure that all other JARs are built before the service is packaged.
project.tasks.jar.dependsOn(rootProject.getSubprojects().findAll { subproject -&gt; subproject.name != project.name }.collect { subproject -&gt; "${subproject.getPath()}:build" })</code></pre>
</div>
</div>
<div class="paragraph">
<p>The logic above finds every other sub-project in the project and adds that sub-project&#8217;s "build" task as a dependency that first must execute before the current project&#8217;s
JAR task can execute.  This ensures that all other projects have built their JAR files before <a href="http://projects.spring.io/spring-boot/" target="_blank">Spring Boot</a> can create the re-packaged JAR.  You can apply this same trick to
any other scenario where the execution of tasks in other sub-projects (regardless of depth) must occur before a certain sub-project&#8217;s task(s).</p>
</div>
</div>
</div></p>
                <p><a href="/blog2014/09/02/gradle_subtask_dependson.html#disqus_thread">Comments</a></p>
                   <a href="/blog2014/08/26/gradle_dependent_tasks.html"><h1>Execute Gradle Tasks Based on Other Tasks</h1></a>
                   <p>26 August 2014</p>
                <p><em>Tags: </em>
                <a href="/blog/tags/gradle.html">gradle</a>
        </p>

                <div class="g-plusone" data-size="medium" data-href="http://jdpgrailsdev.github.io/blog2014/08/26/gradle_dependent_tasks.html"></div>
                <script type="IN/Share" data-url="http://jdpgrailsdev.github.io/blog2014/08/26/gradle_dependent_tasks.html" data-counter="right"></script>
                <div class="fb-like" data-href="http://jdpgrailsdev.github.io/blog2014/08/26/gradle_dependent_tasks.html" data-layout="button_count" data-action="like" data-show-faces="false" data-share="true"></div>

                   <p><div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>As discussed in a previous post, <a href="http://gradle.org" target="_blank">Gradle</a> supports multiple ways to perform incremental builds, such as caching based on task inputs, the use of the
<a href="http://www.gradle.org/docs/current/javadoc/org/gradle/api/tasks/TaskOutputs.html#upToDateWhen(groovy.lang.Closure)" target="_blank">upToDateWhen</a> closure on a
task&#8217;s outputs or the use of the task&#8217;s <code>onlyIf()</code> method to control execution, to name a few.  Sometimes, however, you want a task to only execute if another
cachable task has executed.  For instance, maybe you want to create an archive of some generated source, but only if the source has been updated/re-generated.
One such way to do this is to make use of the <a href="http://www.gradle.org/docs/current/groovydoc/org/gradle/api/Task.html#getDidWork()" target="_blank">getDidWork()</a>
method of the task to determine if the task actually executed or was skipped/up-to-date:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint groovy language-groovy"><code>class CustomTask extends DefaultTask {

    @TaskAction
    void doSomething() {
        if(project.tasks.getByName('otherTask').getDidWork()) {
            // Do this task's work here!
        }
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>By using the <code>getDidWork</code> method on the other task to determine if it executed, we can avoid having to rely upon the input/output of the task to determine if
the downstream task should execute, thus giving us better control over what triggers the tasks in our project.</p>
</div>
</div>
</div></p>
                <p><a href="/blog2014/08/26/gradle_dependent_tasks.html#disqus_thread">Comments</a></p>
                   <a href="/blog2014/08/19/gradle_tests_jenkins.html"><h1>Gradle, Task Caching, Tests and Jenkins</h1></a>
                   <p>19 August 2014</p>
                <p><em>Tags: </em>
                <a href="/blog/tags/gradle.html">gradle</a>
        
                <a href="/blog/tags/jenkins.html">jenkins</a>
        </p>

                <div class="g-plusone" data-size="medium" data-href="http://jdpgrailsdev.github.io/blog2014/08/19/gradle_tests_jenkins.html"></div>
                <script type="IN/Share" data-url="http://jdpgrailsdev.github.io/blog2014/08/19/gradle_tests_jenkins.html" data-counter="right"></script>
                <div class="fb-like" data-href="http://jdpgrailsdev.github.io/blog2014/08/19/gradle_tests_jenkins.html" data-layout="button_count" data-action="like" data-show-faces="false" data-share="true"></div>

                   <p><div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>One of the nice features of <a href="http://gradle.org" target="_blank">Gradle</a> is the task execution caching, which prevent tasks whose inputs/outputs have not changed since the last successful execution from
executing in order to speed up build times.  Sometimes, however this causes issues when integrating your <a href="http://gradle.org" target="_blank">Gradle</a> build into other systems.  I ran into one such issue
when building a <a href="http://gradle.org" target="_blank">Gradle</a> application from <a href="http://jenkins-ci.org/" target="_blank">Jenkins</a>.  The <a href="http://jenkins-ci.org/" target="_blank">Jenkins</a> build job is configured to publish the results of the <code>test</code> task (the test reports output by <a href="http://gradle.org" target="_blank">Gradle</a>).
It did not occur to me that if I did not invoke the <code>clean</code> task and let <a href="http://gradle.org" target="_blank">Gradle</a> only re-generate the test reports if any of the compiled code had changed (other file changes
to the project would trigger the CI build) that <a href="http://jenkins-ci.org/" target="_blank">Jenkins</a> would fail the build due to stale test reports.  However, that is exactly what happened:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code>BUILD SUCCESSFUL

Total time: 15.323 secs
Build step 'Invoke Gradle script' changed build result to SUCCESS
Test reports were found but none of them are new. Did tests run?
For example, /var/jenkins/jobs/test-job/workspace/build/test-results/TEST-com.example.TestSpec.xml is 12 hours 15 minutes old

Build step 'Publish JUnit test result report' changed build result to FAILURE
Finished: FAILURE</code></pre>
</div>
</div>
<div class="paragraph">
<p>By not cleaning out the previously compiled code, the caching mechanism for the <code>test</code> task kicked in and left the previous test results in place, as it properly detected that
nothing had changed and therefore is no need to re-run the tests.  However, Jenkins apparently bases its ability to publish the results of the tests based on a timestamp and not
just the presence of the tests results in the directory specified in the job&#8217;s configuration.  One easy fix is to always run the <code>clean</code> task, but that eliminates a lot of <a href="http://gradle.org" target="_blank">Gradle</a>'s
performance enhancements around only running task incrementally, based on their inputs/outputs.  Another option is to add the <code>--rerun-tasks</code> option, which effectively does the same
thing as the <code>clean</code> task, except it doesn&#8217;t remove any artifacts&#8201;&#8212;&#8201;it just simply forces <a href="http://gradle.org" target="_blank">Gradle</a> to run each task regardless of the caching status.  Neither of these options really
get us what we want.  One other alternative is to make use of the <code>upToDateWhen</code> configuration closure on a tasks declared outputs to control caching on a per-task basis:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint groovy language-groovy"><code>    // Always execute the tests -- needed for Jenkins to be happy
    test.outputs.upToDateWhen { false }</code></pre>
</div>
</div>
<div class="paragraph">
<p>The example above directs <a href="http://gradle.org" target="_blank">Gradle</a> to always run the <code>test</code> task regardless of what the task cache tells <a href="http://gradle.org" target="_blank">Gradle</a> about it.  This gives us fine grained control over which tasks
that we want to take advantage of caching and which ones we want to always run.  By adding the one line above to my project&#8217;s <code>build.gradle</code> script, I was able to make <a href="http://jenkins-ci.org/" target="_blank">Jenkins</a>
happy with always providing up-to-date unit tests results, regardless of which files (source or otherwise) have changed in my project.  This also means that <a href="http://gradle.org" target="_blank">Gradle</a> will take
advantage of task caching for other tasks in the project (such as compilation, packaging, etc), which helps to reduce build time.</p>
</div>
</div>
</div></p>
                <p><a href="/blog2014/08/19/gradle_tests_jenkins.html#disqus_thread">Comments</a></p>
                   <a href="/blog2014/08/12/gradle_javaexec_classpath.html"><h1>Dynamically Build JavaExec Classpath from BuildScript Dependencies in Gradle</h1></a>
                   <p>12 August 2014</p>
                <p><em>Tags: </em>
                <a href="/blog/tags/gradle.html">gradle</a>
        
                <a href="/blog/tags/java.html">java</a>
        </p>

                <div class="g-plusone" data-size="medium" data-href="http://jdpgrailsdev.github.io/blog2014/08/12/gradle_javaexec_classpath.html"></div>
                <script type="IN/Share" data-url="http://jdpgrailsdev.github.io/blog2014/08/12/gradle_javaexec_classpath.html" data-counter="right"></script>
                <div class="fb-like" data-href="http://jdpgrailsdev.github.io/blog2014/08/12/gradle_javaexec_classpath.html" data-layout="button_count" data-action="like" data-show-faces="false" data-share="true"></div>

                   <p><div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>Recently, I have been working on a few <a href="http://gradle.org" target="_blank">Gradle</a> plugins that use the <a href="http://www.gradle.org/docs/current/dsl/org.gradle.api.tasks.JavaExec.html" target="_blank">Gradle JavaExec Task</a>
to execute a Java main class from within the plugin.  This is pretty straightforward and not at all interesting.  However, in testing the plugin, I realized that I did not
want to expose the required dependencies needed to run the main class outside of the plugin.  If I did, I would require each project that applies my plugin to list the
dependencies in its <code>dependencies</code> block.  This is obviously a leaky abstraction, so I decided to see if I could programmatically set the classpath of the <a href="http://www.gradle.org/docs/current/dsl/org.gradle.api.tasks.JavaExec.html" target="_blank">Gradle JavaExec Task</a>
to us use the plugin&#8217;s dependencies:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint groovy language-groovy"><code>task generate(type: JavaExec) {
    main = 'com.example.Generator'
    args = ['arg1', 'arg2']
    classpath = buildscript.configurations.classpath
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>In the example above, the task&#8217;s classpath is set to the classpath created by the <code>buildscript</code> DSL, which includes my plugin dependency and all of its transitive dependencies (unless
you disable transitive resolution when you define the plugin dependency).  This worked great until I used my plugin as part of a multi-module project, where the plugin dependency
is declared and applied in the root project, but the task is executed on the sub-project.  What happened is that the above example only loaded the build script classpath for
the current project (the sub-project), which did not have the plugin dependency on its classpath (apparently, the build script classpath is not additive/transitive).  I addressed
this by writing a little recursive function to traverse up the project tree and add the dependencies from each build script:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint groovy language-groovy"><code>task generate(type: JavaExec) {
    main = 'com.example.Generator'
    args = ['arg1', 'arg2']
    classpath = files(getClasspath(project))
}

private List&lt;File&gt; getClasspath(project, classpath=[]) {
    if(project == null || project == project.rootProject) {
        classpath
    } else {
        classpath.addAll(project.buildscript.configurations.classpath.getFiles())
        getClasspath(project.rootProject, classpath)
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The above example starts with the current project, adds its build script dependencies to the classpath and then recursively looks at the project&#8217;s root project.  This continues
until the project does not have a root project or the root project is the project itself.  The result is then converted to a <code>FileCollection</code> and the classpath is set, ensuring
that the <a href="http://www.gradle.org/docs/current/dsl/org.gradle.api.tasks.JavaExec.html" target="_blank">Gradle JavaExec Task</a> has the dependencies provided by the custom plugin.</p>
</div>
</div>
</div></p>
                <p><a href="/blog2014/08/12/gradle_javaexec_classpath.html#disqus_thread">Comments</a></p>

                <hr />

                <p>Older posts are available in the <a href="/blog/archive.html">archive</a>.</p>

            </div>
            <div id="push"></div>
        </div>

        <div id="footer">
              <div class="container">
                <p class="muted credit">&copy; 2014 | Mixed with <a href="http://getbootstrap.com/">Bootstrap v3.1.1</a> | Baked with <a href="http://jbake.org">JBake v2.3.0</a> | Comments powered by <a href="http://disqus.com">Disqus</a></p>
              </div>
        </div>

        <!-- Le javascript
        ================================================== -->
        <!-- Placed at the end of the document so the pages load faster -->
        <script src="https://code.jquery.com/jquery.js" type="text/javascript"></script>
        <script src="//netdna.bootstrapcdn.com/bootstrap/3.1.1/js/bootstrap.min.js" type="text/javascript"></script>
        <script src="/blog/js/run_prettify.js" type="text/javascript"></script>
        <script src="/blog/js/github_activity.js" type="text/javascript"></script>
        <script type="text/javascript">
            /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
            var disqus_shortname = 'jdpearlin'; // required: replace example with your forum shortname

            /* * * DON'T EDIT BELOW THIS LINE * * */
            (function() {
                var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
                dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
                (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
            })();
        </script>
        <script type="text/javascript">
              window.___gcfg = {lang: 'en'};

              (function() {
                var po = document.createElement('script'); po.type = 'text/javascript'; po.async = true;
                po.src = 'https://apis.google.com/js/plusone.js';
                var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(po, s);
              })();
        </script>
        <script type="text/javascript">
            (function(d, s, id) {
                  var js, fjs = d.getElementsByTagName(s)[0];
                  if (d.getElementById(id)) return;
                  js = d.createElement(s); js.id = id;
                  js.src = "//connect.facebook.net/en_US/all.js#xfbml=1";
                  fjs.parentNode.insertBefore(js, fjs);
            }(document, 'script', 'facebook-jssdk'));
        </script>
        <script src="//platform.linkedin.com/in.js" type="text/javascript"></script>
        <script type="text/javascript">
          (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
          (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
          m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
          })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

          ga('create', 'UA-47885115-1', 'jdpgrailsdev.github.io');
          ga('send', 'pageview');
        </script>
    </body>
</html>
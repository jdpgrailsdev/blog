<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8"/>
        <title>The Flowers Are Still Standing</title>
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <meta name="description" content="" />
        <meta name="author" content="Jonathan Pearlin" />
        <meta name="keywords" content="" />
        <meta name="generator" content="JBake" />

        <!-- Le styles -->
        <link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css">
        <link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap-theme.min.css">
        <link href="/blog/css/asciidoctor.css" rel="stylesheet">
        <link href="/blog/css/base.css" rel="stylesheet">
        <link href="//netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.css" rel="stylesheet">
        <link href='http://fonts.googleapis.com/css?family=Droid+Sans' rel='stylesheet' type='text/css'>
        <link href='/blog/css/octicons.min.css' rel='stylesheet' type='text/css'>

        <!-- HTML5 shim, for IE6-8 support of HTML5 elements -->
        <!--[if lt IE 9]>
              <script src="/blog/js/html5shiv.js"></script>
        <![endif]-->

        <!-- Fav and touch icons -->
        <!--
        <link rel="apple-touch-icon-precomposed" sizes="144x144" href="../assets/ico/apple-touch-icon-144-precomposed.png" />
        <link rel="apple-touch-icon-precomposed" sizes="114x114" href="../assets/ico/apple-touch-icon-114-precomposed.png" />
        <link rel="apple-touch-icon-precomposed" sizes="72x72" href="../assets/ico/apple-touch-icon-72-precomposed.png" />
        <link rel="apple-touch-icon-precomposed" href="../assets/ico/apple-touch-icon-57-precomposed.png" />
        -->
        <link rel="shortcut icon" href="/blog/favicon.ico" />
    </head>
    <body>
        <div id="wrap">
            <!-- Fixed navbar -->
            <div class="navbar navbar-default navbar-fixed-top" role="navigation">
            <a href="https://github.com/jdpgrailsdev" target="_blank"><img style="position: absolute; top: 0; right: 0; border: 0;" src="https://camo.githubusercontent.com/a6677b08c955af8400f44c6298f40e7d19cc5b2d/68747470733a2f2f73332e616d617a6f6e6177732e636f6d2f6769746875622f726962626f6e732f666f726b6d655f72696768745f677261795f3664366436642e706e67" alt="Fork me on GitHub" data-canonical-src="https://s3.amazonaws.com/github/ribbons/forkme_right_gray_6d6d6d.png"></a>
                <div class="container">
                    <div class="navbar-header">
                        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                            <span class="icon-bar"></span>
                            <span class="icon-bar"></span>
                            <span class="icon-bar"></span>
                        </button>
                        <a class="navbar-brand" href="/blog/index.html">Jonathan Pearlin's Blog</a>
                    </div>
                    <div class="navbar-collapse collapse">
                        <ul class="nav navbar-nav">
                            <li><a href="/blog/about.html">About</a></li>
                            <li><a href="/blog/resume.html">Résumé</a></li>
                            <li><a href="/blog/friends.html">Friends</a></li>
                            <li class="dropdown">
                                <a data-toggle="dropdown" href="#">Tags<b class="caret"></b></a>
                                <ul class="dropdown-menu" role="menu">
                                    <li><a href="/blog/tags/docker.html">Docker</a></li>
                                    <li><a href="/blog/tags/gradle.html">Gradle</a></li>
                                    <li><a href="/blog/tags/grails.html">Grails</a></li>
                                    <li><a href="/blog/tags/groovy.html">Groovy</a></li>
                                    <li><a href="/blog/tags/java.html">Java</a></li>
                                    <li><a href="/blog/tags/maven.html">Maven</a></li>
                                    <li><a href="/blog/tags/spring.html">Spring</a></li>
                                    <li><a href="/blog/tags/zookeeper.html">ZooKeeper</a></li>
                                </ul>
                            </li>
                            <li><a href="/blog/feed.xml">Feed</a></li>
                        </ul>
                        <ul class="nav navbar-nav navbar-right">
                            <li><a href="https://github.com/jdpgrailsdev" target="_blank"><i class="fa fa-github"></i></a></li>
                            <li><a href="http://www.linkedin.com/pub/jonathan-pearlin/4/946/9a0" style="text-decoration:none;" target="_blank"><i class="fa fa-linkedin-square"></i></a></li>
                        </ul>
                    </div>
                </div>
            </div>
            <div id="activity" class="pull-left">
                <div class="panel panel-primary">
                      <!-- Default panel contents -->
                      <div class="panel-heading"><a target="_blank" href="http://github.com/jdpgrailsdev?tab=activity"><i class="fa fa-github"></i> My Recent GitHub Activity</a></div>
                      <div class="panel-body">
                          <i class='icon-spinner icon-spin icon-large'></i> Loading...
                      </div>
                      <!-- List group -->
                      <ul class="list-group">
                      </ul>
                </div>
            </div>
            <div class="container">
                <div class="page-header">
                    <h1>The Flowers Are Still Standing</h1>
                </div>

                   <a href="/blog2014/09/30/spring_boot_jetty_jmx.html"><h1>Expose Jetty MBeans via JMX in a Spring Boot Application</h1></a>
                   <p>30 September 2014</p>
                <p><em>Tags: </em>
                <a href="/blog/tags/spring.html">spring</a>
        </p>

                <div class="g-plusone" data-size="medium" data-href="http://jdpgrailsdev.github.io/blog2014/09/30/spring_boot_jetty_jmx.html"></div>
                <script type="IN/Share" data-url="http://jdpgrailsdev.github.io/blog2014/09/30/spring_boot_jetty_jmx.html" data-counter="right"></script>
                <div class="fb-like" data-href="http://jdpgrailsdev.github.io/blog2014/09/30/spring_boot_jetty_jmx.html" data-layout="button_count" data-action="like" data-show-faces="false" data-share="true"></div>

                   <p><div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p><a href="http://projects.spring.io/spring-boot/" target="_blank">Spring Boot</a> provides monitoring and management over JMX <a href="http://docs.spring.io/spring-boot/docs/current/reference/html/production-ready-jmx.html" target="_blank">out of the box</a>.  If you include a library
that exposes <a href="http://docs.oracle.com/javase/tutorial/jmx/mbeans/" target="_blank">MBeans</a>, they will automatically be registered and exposed with the MBean server provided by <a href="http://projects.spring.io/spring-boot/" target="_blank">Spring Boot</a>.  However, some packages don&#8217;t enable their MBeans by default.  Jetty is one of those
libraries.  If you are using Jetty instead of Tomcat (Tomcat is the default option in <a href="http://projects.spring.io/spring-boot/" target="_blank">Spring Boot</a>), you can enable Jetty&#8217;s MBeans by adding a <code>customizer</code> to a custom override of the <code>JettyEmbeddedServletContainerFactory</code>
bean:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint java language-java"><code>@Bean
public JettyEmbeddedServletContainerFactory jettyEmbeddedServletContainerFactory(@Value("${server.port:8080}") final String port) {
    final JettyEmbeddedServletContainerFactory factory =  new JettyEmbeddedServletContainerFactory(Integer.valueOf(port));
    factory.addServerCustomizers(new JettyServerCustomizer() {
        @Override
        public void customize(final Server server) {
            // Expose Jetty managed beans to the JMX platform server provided by Spring
            final MBeanContainer mbContainer = new MBeanContainer(ManagementFactory.getPlatformMBeanServer());
            server.addBean(mbContainer);
        }
    });
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The code sample above will register Jetty&#8217;s MBeans with the default platform MBean server (which is provided by <a href="http://projects.spring.io/spring-boot/" target="_blank">Spring Boot</a>).  This will allow you to see things like the number of threads in use in Jetty&#8217;s
connection pool and other fun facts that can be very useful when debugging Jetty or configuring it for better performance.  It is also worth noting that you will need to include the following dependencies
in order to expose the Jetty MBeans:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint groovy language-groovy"><code>ext {
    jettyVersion = '9.0.3.v20130506'
}

dependencies {
  ...

  compile "org.eclipse.jetty:jetty-jmx:$jettyVersion"
  compile "org.eclipse.jetty:jetty-server:$jettyVersion"
  compile "org.eclipse.jetty:jetty-util:$jettyVersion"

  ...
}</code></pre>
</div>
</div>
</div>
</div></p>
                <p><a href="/blog2014/09/30/spring_boot_jetty_jmx.html#disqus_thread">Comments</a></p>
                   <a href="/blog2014/09/23/spring_jruby_autodetect_deps.html"><h1>Use Spring to Autodetect and Load JRuby Gem Dependencies</h1></a>
                   <p>23 September 2014</p>
                <p><em>Tags: </em>
                <a href="/blog/tags/gradle.html">gradle</a>
        
                <a href="/blog/tags/spring.html"> spring</a>
        
                <a href="/blog/tags/jruby.html"> jruby</a>
        </p>

                <div class="g-plusone" data-size="medium" data-href="http://jdpgrailsdev.github.io/blog2014/09/23/spring_jruby_autodetect_deps.html"></div>
                <script type="IN/Share" data-url="http://jdpgrailsdev.github.io/blog2014/09/23/spring_jruby_autodetect_deps.html" data-counter="right"></script>
                <div class="fb-like" data-href="http://jdpgrailsdev.github.io/blog2014/09/23/spring_jruby_autodetect_deps.html" data-layout="button_count" data-action="like" data-show-faces="false" data-share="true"></div>

                   <p><div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>I decided recently to try to use <a href="http://jruby.org/" target="_blank">JRuby</a> to help me use Ruby-based libraries as plugins in a Java application.  This is pretty easy to do if your Ruby code makes use
of the stock modules included in <a href="http://jruby.org/" target="_blank">JRuby</a>.  However, what happens if the Ruby scripts need to access other libraries that typically would be found in external
<a href="https://rubygems.org/" target="_blank">Ruby Gems</a>?  One answer is to use <a href="http://gradle.org" target="_blank">Gradle</a>, <a href="http://jruby.org/" target="_blank">JRuby</a> and the <a href="http://spring.io" target="_blank">Spring Framework</a> to automatically download, package and discover these dependencies at build and runtime.
Another way to put it is that we have three distinct operations that we need to perform in order to get all of this playing nicely together:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Use <a href="http://bundler.io/" target="_blank">Bundler</a> to find, download and install all required Ruby modules at build time (<a href="http://gradle.org" target="_blank">Gradle</a> + <a href="http://jruby.org/" target="_blank">JRuby</a>)</p>
</li>
<li>
<p>Package Ruby modules with Ruby script(s) in JAR file (<a href="http://gradle.org" target="_blank">Gradle</a>)</p>
</li>
<li>
<p>Auto-discover packaged Ruby modules at runtime and add them to the "load path" of the script that is to be executed (<a href="http://jruby.org/" target="_blank">JRuby</a> + <a href="http://spring.io" target="_blank">Spring Framework</a>)</p>
</li>
<li>
<p>Execute the script (<a href="http://jruby.org/" target="_blank">JRuby</a>)</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Let&#8217;s start with the first task:  Use <a href="http://bundler.io/" target="_blank">Bundler</a> to find, download and install all required Ruby modules at build time.  To accomplish this, I decided to
use custom tasks in a <a href="http://gradle.org" target="_blank">Gradle</a> script to first install <a href="http://bundler.io/" target="_blank">Bundler</a> and then use <a href="http://bundler.io/" target="_blank">Bundler</a> to install any required Ruby modules found in the project&#8217;s <code>Gemfile</code>.
This <a href="http://gradle.org" target="_blank">Gradle</a> script also needed to be able to copy the installed <a href="https://rubygems.org/" target="_blank">Ruby Gems</a> to a directory that would ensure their inclusion in the packaged JAR file.  Below
is the script:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint groovy language-groovy"><code>import groovy.util.AntBuilder

buildscript {
    dependencies {
        classpath 'org.jruby:jruby-complete:1.7.13'
    }
}

jar {
    from ("${project.projectDir}/src/main/ruby")
}

dependencies {
    runtime project(':shared')
}

sourceSets {
    main {
       java {
          srcDir file("${project.projectDir}/src/main/ruby")
       }
    }
}

/*
 * Installs Bundler to the project's build directory.  Bundler is used to
 * install any Gems required by this plugin.
 */
task installBundler(type:JavaExec, description:'Installs Bundler') {
    args = "--2.0 -S gem install -i ${project.buildDir}/bundler --no-rdoc --no-ri bundler".tokenize()
    classpath = project.buildscript.configurations.classpath
    jvmArgs("-Xmx800M")
    main = 'org.jruby.Main'
    environment = [HOME:System.getProperty('user.home'),
                    PATH:['/usr/local/bin', '/usr/bin','/bin','/usr/sbin','/sbin'].join(File.pathSeparator)]
    workingDir = project.projectDir
}

/*
 * Installs the Gems required by this plugin to the project's build directory.
 * This task uses Bundler to perform the Gem installations.
 */
task installGems(type:JavaExec, description:'Installs all required Gems via Bundle.', dependsOn:'installBundler') {
    args = "--2.0 -S bundle install --path ${project.buildDir}".tokenize()
    classpath = project.buildscript.configurations.classpath
    main = 'org.jruby.Main'
    environment = [GEM_PATH: "${project.buildDir}/bundler",
                    HOME:System.getProperty('user.home'),
                    PATH:["${project.buildDir}/bundler/bin", '/usr/local/bin', '/usr/bin','/bin','/usr/sbin','/sbin'].join(File.pathSeparator)]
    workingDir = project.projectDir
}

/*
 * Moves the installed Gem files from the project's build directory to src/main/resources
 * so that they will be included in the packaged JAR.
 */
task packageGems(dependsOn:'installGems') {
    doLast {
        Properties props = new Properties()
        props.load(new File("${project.projectDir}/src/main/resources/META-INF/notification/${project.name}.plugin").newDataInputStream())
        File parent = new File("${project.projectDir}/src/main/resources/${props.getProperty('plugin-name')}/gems")
        parent.deleteDir()
        parent.mkdirs()

        // Normalize each installed gem directory name and move it to src/main/resources
        new File("${project.buildDir}/jruby/1.9/gems").listFiles().each { file -&gt;
            processSourceFiles(parent, new File(file, 'lib'))
            File vendorGems = new File(file, 'vendor/gems')
            if(vendorGems.exists()) {
                vendorGems.listFiles().each { vendorFile -&gt;
                    processSourceFiles(parent, new File(vendorFile, 'lib'))
                }
            }
        }
    }
}

project.tasks.installGems.inputs.file("${project.projectDir}/Gemfile")
project.tasks.installGems.outputs.dir("${project.buildDir}/jruby")
project.tasks.installBundler.outputs.upToDateWhen { new File("${project.buildDir}/bundler").exists() }
project.tasks.jar.dependsOn(['packageGems'])

def processSourceFiles(File newParent, File rootDir) {
    File newRootDir = new File(newParent, rootDir.getParentFile().getName())
    new AntBuilder().copy(todir : newRootDir.getAbsolutePath(), quiet:true) {
        fileset(dir: rootDir.getAbsolutePath())
    }
    newRootDir.eachFileRecurse { rubyFile -&gt;
        if(rubyFile.isFile() &amp;&amp; rubyFile.text.contains('require_relative')) {
            def builder = new StringBuilder()
            rubyFile.eachLine { line -&gt;
                line = line.replaceAll('require_relative\\s+\'\\.\\/(.+)\'', 'require_relative \'$1\'')
                def matcher = line =~ /require_relative\s+'((\.\.\/)+).+'/
                if(matcher.find()) {
                    def numberOfParentDirs = matcher[0][1].split('/').length
                    def actualParent = rubyFile.getParentFile()
                    numberOfParentDirs.times { actualParent = actualParent.getParentFile() }
                    actualParent = actualParent.getAbsolutePath().minus("${newRootDir.getAbsolutePath()}/")
                    line = line.replaceAll('require_relative\\s+\'(?:\\.\\.\\/)+(.+)\'', "require '${actualParent ? "${actualParent}/" : actualParent}\$1'")
                }
                builder.append(line.trim())
                builder.append('\n')
            }
            rubyFile.write(builder.toString())
        }
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>A couple of things to point out.  First, the script uses <a href="http://jruby.org/" target="_blank">JRuby</a> in custom <a href="http://gradle.org" target="_blank">Gradle</a> tasks to execute the Ruby-based commands.  Second, the script recursively
walks through each of the installed <a href="https://rubygems.org/" target="_blank">Ruby Gems</a> to properly normalize any <code>require_relative</code> statements into absolute paths.  This is necessary as <a href="http://jruby.org/" target="_blank">JRuby</a> does
not handle relative paths in included <a href="https://rubygems.org/" target="_blank">Ruby Gems</a> very well (or at all).</p>
</div>
<div class="paragraph">
<p>At this point, running <code>./gradlew build</code> on this project will produce a JAR file containing any Ruby scripts found in <code>src/main/ruby</code>, as well as any required
<a href="https://rubygems.org/" target="_blank">Ruby Gems</a> installed by the script.  The next step to use a Ruby-based plugin in a Java application is to use <a href="http://jruby.org/" target="_blank">JRuby</a> to execute the script.  I&#8217;m not going
to go into all of the details about wiring that up, as the <a href="http://jruby.org/" target="_blank">JRuby</a> tutorials cover this pretty well.  Instead, I am going to focus on how to extract the
required <a href="https://rubygems.org/" target="_blank">Ruby Gems</a> that we included in the JAR and make sure that they are available to our Ruby script(s) when <a href="http://jruby.org/" target="_blank">JRuby</a> executes them.  To accomplish this,
I decided to make use of the <a href="http://spring.io" target="_blank">Spring Framework</a>'s <code>PathMatchingResourcePatternResolver</code> to auto-discover the included <a href="https://rubygems.org/" target="_blank">Ruby Gems</a> and add them to <a href="http://jruby.org/" target="_blank">JRuby</a>'s load path:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint java language-java"><code>import java.util.HashSet;
import java.util.Set;
import java.util.regex.Matcher;
import java.util.regex.Pattern;


import org.jruby.embed.ScriptingContainer;
import org.springframework.core.io.Resource;
import org.springframework.core.io.support.PathMatchingResourcePatternResolver;

...

final String pluginName = "test-plugin";

final PathMatchingResourcePatternResolver patternResolver = new PathMatchingResourcePatternResolver();

final Resource[] dependencyGemResources  = patternResolver.getResources(String.format("classpath*:/%s/gems/**/*.rb", pluginName));

final Pattern dependencyGemPattern = Pattern.compile(String.format("^classpath:\\/%s\\/gems\\/([a-zA-Z\\-\\.0-9_]+)/.*$", pluginName));

final ScriptingContainer container = new ScriptingContainer();

final Set&lt;String&gt; loadPaths = new HashSet&lt;String&gt;();

// Add the JRuby-provided Ruby 2.0 modules to the load path
loadPaths.add("classpath:/META-INF/jruby.home/lib/ruby/2.0");

// Add any required dependency Gems for this plugin to the load path.
for(final Resource resource : dependencyGemResources) {
    final Matcher matcher = dependencyGemPattern.matcher(resource.getURI().toString().replaceAll("^jar:file:\\/.*\\.jar!(.*)$", "classpath:$1"));
    if(matcher.find()) {
        final String resourceName = String.format("classpath:/%s/gems/%s", pluginName, matcher.group(1));
        if(!loadPaths.contains(resourceName)) {
            loadPaths.add(resourceName);
        }
    }
}

container.setLoadPaths(loadPaths);</code></pre>
</div>
</div>
<div class="paragraph">
<p>The snippet of Java code above makes use of the <code>PathMatchingResourcePatternResolver</code> from the <a href="http://spring.io" target="_blank">Spring Framework</a> to scan the classpath and find all <code>.rb</code> files under the
<code>/&lt;plugin name&gt;/gems</code> path.  From this list, the URI of each (which is relative to the JAR file) is converted into a classpath-friendly string that <a href="http://jruby.org/" target="_blank">JRuby</a>
understands and then added to the list of paths for <a href="http://jruby.org/" target="_blank">JRuby</a> to load prior to execution of the script.  At this point, if a Ruby script is executed via the
<code>ScriptingContainer</code> with the properly configured load paths, any references to required modules that are packaged in the plugin&#8217;s JAR file will be found and
the script will execute just as if it were run via Ruby.</p>
</div>
</div>
</div></p>
                <p><a href="/blog2014/09/23/spring_jruby_autodetect_deps.html#disqus_thread">Comments</a></p>
                   <a href="/blog2014/09/09/spring_data_hibernate_join.html"><h1>Avoid Hibernate N+1 Problem with Joins in Spring-Data/JPA</h1></a>
                   <p>09 September 2014</p>
                <p><em>Tags: </em>
                <a href="/blog/tags/spring.html">spring</a>
        
                <a href="/blog/tags/java.html"> java</a>
        </p>

                <div class="g-plusone" data-size="medium" data-href="http://jdpgrailsdev.github.io/blog2014/09/09/spring_data_hibernate_join.html"></div>
                <script type="IN/Share" data-url="http://jdpgrailsdev.github.io/blog2014/09/09/spring_data_hibernate_join.html" data-counter="right"></script>
                <div class="fb-like" data-href="http://jdpgrailsdev.github.io/blog2014/09/09/spring_data_hibernate_join.html" data-layout="button_count" data-action="like" data-show-faces="false" data-share="true"></div>

                   <p><div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>If you have used <a href="http://hibernate.org" target="_blank">Hibernate</a> as your ORM for any length of time, you have inevitably run into the
<a href="http://docs.jboss.org/hibernate/orm/3.3/reference/en-US/html/performance.html#performance-fetching-custom" target="_blank">N+1 problem</a>.  This occurs when
<a href="http://hibernate.org" target="_blank">Hibernate</a> queries an entity that has a collection of children entities that does not use a <code>JOIN</code> fetch mode to retrieve the children.  The simple solution
when using <a href="http://hibernate.org" target="_blank">Hibernate</a> directly is to set the <code>FetchMode</code> to <code>JOIN</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint java language-java"><code>User user = (User) session.createCriteria(User.class)
                .setFetchMode("permissions", FetchMode.JOIN)
                .add( Restrictions.idEq(userId) )
                .uniqueResult();</code></pre>
</div>
</div>
<div class="paragraph">
<p>However, if you are using <a href="http://www.oracle.com/technetwork/java/javaee/tech/persistence-jsp-140049.html" target="_blank">JPA</a> on top of <a href="http://hibernate.org" target="_blank">Hibernate</a>, there is no way to set the <code>FetchMode</code> used by <a href="http://hibernate.org" target="_blank">Hibernate</a> to <code>JOIN</code>.  In fact, <a href="http://www.oracle.com/technetwork/java/javaee/tech/persistence-jsp-140049.html" target="_blank">JPA</a> only
supports two types of fetching:  <code>EAGER</code> and <code>LAZY</code>.  Luckily, there is another <a href="http://www.oracle.com/technetwork/java/javaee/tech/persistence-jsp-140049.html" target="_blank">JPA</a> API that can be used to address this problem:  <a href="http://projects.spring.io/spring-data-jpa/" target="_blank">Spring Data JPA</a>.  The
<a href="http://projects.spring.io/spring-data-jpa/" target="_blank">Spring Data JPA</a> library provides a <a href="http://spring.io/blog/2011/04/26/advanced-spring-data-jpa-specifications-and-querydsl/" target="_blank">Domain Driven Design Specifications</a>
API that allows you to control the behavior of the generated query.  This will allow you to tweak things such as the fetch mode to ensure the proper instruction
is passed to <a href="http://hibernate.org" target="_blank">Hibernate</a> to address the N+1 problem.  I&#8217;m not going to go into a bunch of details on how to use the <code>JpaSpecificationExecutor</code>, as the <a href="http://projects.spring.io/spring-data-jpa/" target="_blank">Spring Data JPA</a>
documentation does a pretty good job of covering it.  What is more important is how to control the fetch mode using it:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint java language-java"><code>final long userId = 1;

final Specification&lt;User&gt; spec = new Specification&lt;User&gt;() {
    @Override
    public Predicate toPredicate(final Root&lt;User&gt; root, final CriteriaQuery&lt;?&gt; query, final CriteriaBuilder cb) {
        query.distinct(true);
        root.fetch("permissions", JoinType.LEFT);
        return cb.equal(root.get("id"), userId);
     }
};

List&lt;User&gt; users = userRepository.findAll(spec);</code></pre>
</div>
</div>
<div class="paragraph">
<p>There are two important pieces of the example above.  The first is the setting of the <code>distinct</code> flag on the query to ensure that the proper (unique) results are returned as
a result of the join.  The second is the addition of a <code>fetch</code> hint to the root entity, telling the specification to perform a left join of the root to the entity mapped
by the "permissions" field of the root entity.  This ensures that <a href="http://hibernate.org" target="_blank">Hibernate</a> will now perform a join instead of N+1 queries to fetch the root entity and its associated
children.</p>
</div>
</div>
</div></p>
                <p><a href="/blog2014/09/09/spring_data_hibernate_join.html#disqus_thread">Comments</a></p>
                   <a href="/blog2014/09/02/gradle_subtask_dependson.html"><h1>Ensure Order of Task Execution between Gradle Sub-Projects</h1></a>
                   <p>02 September 2014</p>
                <p><em>Tags: </em>
                <a href="/blog/tags/gradle.html">gradle</a>
        </p>

                <div class="g-plusone" data-size="medium" data-href="http://jdpgrailsdev.github.io/blog2014/09/02/gradle_subtask_dependson.html"></div>
                <script type="IN/Share" data-url="http://jdpgrailsdev.github.io/blog2014/09/02/gradle_subtask_dependson.html" data-counter="right"></script>
                <div class="fb-like" data-href="http://jdpgrailsdev.github.io/blog2014/09/02/gradle_subtask_dependson.html" data-layout="button_count" data-action="like" data-show-faces="false" data-share="true"></div>

                   <p><div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>One of the great things (IMHO) about <a href="http://gradle.org" target="_blank">Gradle</a> is that it does a pretty good job of choosing sane conventions.  That being said, one place that seems to not always
be a great choice is <a href="http://gradle.org" target="_blank">Gradle</a>'s convention to visit sub-projects in alpha-numerical order.  Let&#8217;s say that you have the following project structure:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>root
 |_ A
 |_ B
    |_ C
    |_ D
 |_ E</pre>
</div>
</div>
<div class="paragraph">
<p>Based on the alpha-numerical ordering, you would probably expect <a href="http://gradle.org" target="_blank">Gradle</a> to visit the projects in the following order:  A, B, B:C, B:D, E.  However, this is not the case.
<a href="http://gradle.org" target="_blank">Gradle</a> will visit the sub-projects in alpha-numerical order, within each level.  What you end up with is:  A, B, E, B:C, B:D.  Normally, this probably isn&#8217;t a big deal.
This does become a big deal when one of those sub-projects builds a distribution that needs to include output from all of the other sub-projects.  Such is the case when
building a fully-repackaged, executable JAR file with <a href="http://projects.spring.io/spring-boot/" target="_blank">Spring Boot</a>.  The repackaged JAR built by the
<a href="http://docs.spring.io/spring-boot/docs/current/reference/html/build-tool-plugins-gradle-plugin.html" target="_blank">Spring Boot Gradle Plugin</a> includes all dependency JAR files
required to execute the application.  Let&#8217;s suppose in our example above, the sub-project E&#8217;s <code>build.gradle</code> script includes the following dependency block:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint groovy language-groovy"><code>dependencies {
    compile module(':A')
    compile module(':B:C')
    compile module(':B:D')
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>What we would like to happen is that when we build project "E", the JAR file should include the JAR&#8217;s produced by building "A", "B:C", and "B:D".  What actually happens is
that only "A"'s JAR gets included, because of the ordering outlined earlier in this post.  The way to correct this behavior and to ensure that all other sub-projects build
their JAR files prior to "E"'s JAR task executing is to add the following to "E"'s <code>build.gradle</code> script:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint groovy language-groovy"><code>// Ensure that all other JARs are built before the service is packaged.
project.tasks.jar.dependsOn(rootProject.getSubprojects().findAll { subproject -&gt; subproject.name != project.name }.collect { subproject -&gt; "${subproject.getPath()}:build" })</code></pre>
</div>
</div>
<div class="paragraph">
<p>The logic above finds every other sub-project in the project and adds that sub-project&#8217;s "build" task as a dependency that first must execute before the current project&#8217;s
JAR task can execute.  This ensures that all other projects have built their JAR files before <a href="http://projects.spring.io/spring-boot/" target="_blank">Spring Boot</a> can create the re-packaged JAR.  You can apply this same trick to
any other scenario where the execution of tasks in other sub-projects (regardless of depth) must occur before a certain sub-project&#8217;s task(s).</p>
</div>
</div>
</div></p>
                <p><a href="/blog2014/09/02/gradle_subtask_dependson.html#disqus_thread">Comments</a></p>

                <hr />

                <p>Older posts are available in the <a href="/blog/archive.html">archive</a>.</p>

            </div>
            <div id="push"></div>
        </div>

        <div id="footer">
              <div class="container">
                <p class="muted credit">&copy; 2014 | Mixed with <a href="http://getbootstrap.com/">Bootstrap v3.1.1</a> | Baked with <a href="http://jbake.org">JBake v2.3.0</a> | Comments powered by <a href="http://disqus.com">Disqus</a></p>
              </div>
        </div>

        <!-- Le javascript
        ================================================== -->
        <!-- Placed at the end of the document so the pages load faster -->
        <script src="https://code.jquery.com/jquery.js" type="text/javascript"></script>
        <script src="//netdna.bootstrapcdn.com/bootstrap/3.1.1/js/bootstrap.min.js" type="text/javascript"></script>
        <script src="/blog/js/run_prettify.js" type="text/javascript"></script>
        <script src="/blog/js/github_activity.js" type="text/javascript"></script>
        <script type="text/javascript">
            /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
            var disqus_shortname = 'jdpearlin'; // required: replace example with your forum shortname

            /* * * DON'T EDIT BELOW THIS LINE * * */
            (function() {
                var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
                dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
                (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
            })();
        </script>
        <script type="text/javascript">
              window.___gcfg = {lang: 'en'};

              (function() {
                var po = document.createElement('script'); po.type = 'text/javascript'; po.async = true;
                po.src = 'https://apis.google.com/js/plusone.js';
                var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(po, s);
              })();
        </script>
        <script type="text/javascript">
            (function(d, s, id) {
                  var js, fjs = d.getElementsByTagName(s)[0];
                  if (d.getElementById(id)) return;
                  js = d.createElement(s); js.id = id;
                  js.src = "//connect.facebook.net/en_US/all.js#xfbml=1";
                  fjs.parentNode.insertBefore(js, fjs);
            }(document, 'script', 'facebook-jssdk'));
        </script>
        <script src="//platform.linkedin.com/in.js" type="text/javascript"></script>
        <script type="text/javascript">
          (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
          (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
          m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
          })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

          ga('create', 'UA-47885115-1', 'jdpgrailsdev.github.io');
          ga('send', 'pageview');
        </script>
    </body>
</html>
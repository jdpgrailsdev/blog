<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8"/>
        <title>The Flowers Are Still Standing</title>
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <meta name="description" content="" />
        <meta name="author" content="Jonathan Pearlin" />
        <meta name="keywords" content="" />
        <meta name="generator" content="JBake" />

        <!-- Le styles -->
        <link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css">
        <link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap-theme.min.css">
        <link href="/blog/css/asciidoctor.css" rel="stylesheet">
        <link href="/blog/css/base.css" rel="stylesheet">
        <link href="//netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.css" rel="stylesheet">
        <link href='http://fonts.googleapis.com/css?family=Droid+Sans' rel='stylesheet' type='text/css'>
        <link href='/blog/css/octicons.min.css' rel='stylesheet' type='text/css'>

        <!-- HTML5 shim, for IE6-8 support of HTML5 elements -->
        <!--[if lt IE 9]>
              <script src="/blog/js/html5shiv.js"></script>
        <![endif]-->

        <!-- Fav and touch icons -->
        <!--
        <link rel="apple-touch-icon-precomposed" sizes="144x144" href="../assets/ico/apple-touch-icon-144-precomposed.png" />
        <link rel="apple-touch-icon-precomposed" sizes="114x114" href="../assets/ico/apple-touch-icon-114-precomposed.png" />
        <link rel="apple-touch-icon-precomposed" sizes="72x72" href="../assets/ico/apple-touch-icon-72-precomposed.png" />
        <link rel="apple-touch-icon-precomposed" href="../assets/ico/apple-touch-icon-57-precomposed.png" />
        -->
        <link rel="shortcut icon" href="/blog/favicon.ico" />
    </head>
    <body>
        <div id="wrap">
            <!-- Fixed navbar -->
            <div class="navbar navbar-default navbar-fixed-top" role="navigation">
            <a href="https://github.com/jdpgrailsdev" target="_blank"><img style="position: absolute; top: 0; right: 0; border: 0;" src="https://camo.githubusercontent.com/a6677b08c955af8400f44c6298f40e7d19cc5b2d/68747470733a2f2f73332e616d617a6f6e6177732e636f6d2f6769746875622f726962626f6e732f666f726b6d655f72696768745f677261795f3664366436642e706e67" alt="Fork me on GitHub" data-canonical-src="https://s3.amazonaws.com/github/ribbons/forkme_right_gray_6d6d6d.png"></a>
                <div class="container">
                    <div class="navbar-header">
                        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                            <span class="icon-bar"></span>
                            <span class="icon-bar"></span>
                            <span class="icon-bar"></span>
                        </button>
                        <a class="navbar-brand" href="/blog/index.html">Jonathan Pearlin's Blog</a>
                    </div>
                    <div class="navbar-collapse collapse">
                        <ul class="nav navbar-nav">
                            <li><a href="/blog/about.html">About</a></li>
                            <li><a href="/blog/resume.html">Résumé</a></li>
                            <li><a href="/blog/friends.html">Friends</a></li>
                            <li class="dropdown">
                                <a data-toggle="dropdown" href="#">Tags<b class="caret"></b></a>
                                <ul class="dropdown-menu" role="menu">
                                    <li><a href="/blog/tags/docker.html">Docker</a></li>
                                    <li><a href="/blog/tags/gradle.html">Gradle</a></li>
                                    <li><a href="/blog/tags/grails.html">Grails</a></li>
                                    <li><a href="/blog/tags/groovy.html">Groovy</a></li>
                                    <li><a href="/blog/tags/java.html">Java</a></li>
                                    <li><a href="/blog/tags/maven.html">Maven</a></li>
                                    <li><a href="/blog/tags/spring.html">Spring</a></li>
                                    <li><a href="/blog/tags/zookeeper.html">ZooKeeper</a></li>
                                </ul>
                            </li>
                            <li><a href="/blog/feed.xml">Feed</a></li>
                        </ul>
                        <ul class="nav navbar-nav navbar-right">
                            <li><a href="https://github.com/jdpgrailsdev" target="_blank"><i class="fa fa-github"></i></a></li>
                            <li><a href="http://www.linkedin.com/pub/jonathan-pearlin/4/946/9a0" style="text-decoration:none;" target="_blank"><i class="fa fa-linkedin-square"></i></a></li>
                        </ul>
                    </div>
                </div>
            </div>
            <div id="activity" class="pull-left">
                <div class="panel panel-primary">
                      <!-- Default panel contents -->
                      <div class="panel-heading"><a target="_blank" href="http://github.com/jdpgrailsdev?tab=activity"><i class="fa fa-github"></i> My Recent GitHub Activity</a></div>
                      <div class="panel-body">
                          <i class='icon-spinner icon-spin icon-large'></i> Loading...
                      </div>
                      <!-- List group -->
                      <ul class="list-group">
                      </ul>
                </div>
            </div>
            <div class="container">
                <div class="page-header">
                    <h1>The Flowers Are Still Standing</h1>
                </div>

                   <a href="/blog/2015/03/03/thrift_json_rest_spring_boot_ii.html"><h1>Using Thrift Generated Classes with a JSON REST API in Spring Boot - Part II</h1></a>
                   <p>03 March 2015</p>
                <p><em>Tags: </em>
                <a href="/blog/tags/spring.html">spring</a>
        
                <a href="/blog/tags/thrift.html">thrift</a>
        </p>

                <div class="g-plusone" data-size="medium" data-href="http://jdpgrailsdev.github.io/blog/2015/03/03/thrift_json_rest_spring_boot_ii.html"></div>
                <script type="IN/Share" data-url="http://jdpgrailsdev.github.io/blog/2015/03/03/thrift_json_rest_spring_boot_ii.html" data-counter="right"></script>
                <div class="fb-like" data-href="http://jdpgrailsdev.github.io/blog/2015/03/03/thrift_json_rest_spring_boot_ii.html" data-layout="button_count" data-action="like" data-show-faces="false" data-share="true"></div>

                   <p><div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>In my <a href="http://jonathanpearlin.com/blog/2015/02/24/thrift_json_rest_spring_boot_part_i.html" target="_blank">previous post</a>, I discussed how
to create a custom <a href="https://github.com/FasterXML/jackson" target="_blank">Jackson 2</a> serializer to handle the conversion of JSON into <a href="https://thrift.apache.org/" target="_blank">Apache Thrift</a> objects within a <a href="http://projects.spring.io/spring-boot/" target="_blank">Spring Boot</a> application that uses
<a href="https://spring.io/guides/gs/rest-service/" target="_blank">Spring&#8217;s REST support</a>.  In this post, I am going to tackle the other side of the coin:  de-serialization, or converting an <a href="https://thrift.apache.org/" target="_blank">Apache Thrift</a> object from JSON.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_custom_de_serializer">Custom De-serializer</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Much like the previous example, we need to create a custom <a href="https://github.com/FasterXML/jackson" target="_blank">Jackson 2</a> de-serializer to handle the conversion of <a href="https://thrift.apache.org/" target="_blank">Apache Thrift</a>-based objects from JSON:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">package com.example.json;

import java.io.IOException;
import java.lang.reflect.Field;
import java.lang.reflect.ParameterizedType;
import java.util.Iterator;
import java.util.Map;

import org.apache.thrift.TBase;
import org.apache.thrift.TException;
import org.apache.thrift.TFieldIdEnum;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import com.fasterxml.jackson.core.JsonParser;
import com.fasterxml.jackson.core.JsonProcessingException;
import com.fasterxml.jackson.databind.DeserializationContext;
import com.fasterxml.jackson.databind.JavaType;
import com.fasterxml.jackson.databind.JsonDeserializer;
import com.fasterxml.jackson.databind.JsonNode;
import com.fasterxml.jackson.databind.ObjectMapper;
import com.fasterxml.jackson.databind.node.JsonNodeType;
import com.fasterxml.jackson.databind.node.ObjectNode;
import com.fasterxml.jackson.databind.type.TypeFactory;
import com.google.common.base.CaseFormat;

/**
 * This abstract class represents a generic de-serializer for converting JSON to Thrift-based entities.
 *
 * @param &lt;E&gt; An implementation of the {@link TFieldIdEnum} interface.
 * @param &lt;T&gt; An implementation of the {@link TBase} interface.
 */
public abstract class AbstractThriftDeserializer&lt;E extends TFieldIdEnum, T extends TBase&lt;T, E&gt;&gt; extends JsonDeserializer&lt;T&gt; {

    private static Logger log = LoggerFactory.getLogger(AbstractThriftDeserializer.class);

    @Override
    public T deserialize(final JsonParser jp, final DeserializationContext ctxt) throws IOException, JsonProcessingException {
        final T instance = newInstance();
        final ObjectMapper mapper = (ObjectMapper)jp.getCodec();
        final ObjectNode rootNode = (ObjectNode)mapper.readTree(jp);
        final Iterator&lt;Map.Entry&lt;String, JsonNode&gt;&gt; iterator = rootNode.fields();

        while(iterator.hasNext()) {
            final Map.Entry&lt;String, JsonNode&gt; currentField = iterator.next();
            try {
                /*
                 * If the current node is not a null value, process it.  Otherwise,
                 * skip it.  Jackson will treat the null as a 0 for primitive
                 * number types, which in turn will make Thrift think the field
                 * has been set.
                 */
                if(currentField.getValue().getNodeType() != JsonNodeType.NULL) {
                    final E field = getField(CaseFormat.LOWER_UNDERSCORE.to(CaseFormat.UPPER_UNDERSCORE, currentField.getKey()));
                    final JsonParser parser = currentField.getValue().traverse();
                    parser.setCodec(mapper);
                    final Object value = mapper.readValue(parser, generateValueType(instance, field));
                    if(value != null) {
                        log.debug("Field {} produced value {} of type {}.", currentField.getKey(), value, value.getClass().getName());
                        instance.setFieldValue(field, value);
                    } else {
                        log.debug("Field {} contains a null value.  Skipping...", currentField.getKey());
                    }
                } else {
                    log.debug("Field {} contains a null value.  Skipping...", currentField.getKey());
                }
            } catch (final NoSuchFieldException | IllegalArgumentException e) {
                log.error("Unable to de-serialize field '{}'.", currentField.getKey(), e);
                ctxt.mappingException(e.getMessage());
            }
        }

        try {
            // Validate that the instance contains all required fields.
            validate(instance);
        } catch (final TException e) {
            log.error("Unable to deserialize JSON '{}' to type '{}'.", jp.getValueAsString(), instance.getClass().getName(), e);
            NewRelic.noticeError(e);
            ctxt.mappingException(e.getMessage());
        }

        return instance;
    }

    /**
     * Returns the {@code &lt;E&gt;} enumerated value that represents the target
     * field in the Thrift entity referenced in the JSON document.
     * @param fieldName The name of the Thrift entity target field.
     * @return The {@code &lt;E&gt;} enumerated value that represents the target
     *   field in the Thrift entity referenced in the JSON document.
     */
    protected abstract E getField(String fieldName);

    /**
     * Creates a new instance of the Thrift entity class represented by this deserializer.
     * @return A new instance of the Thrift entity class represented by this deserializer.
     */
    protected abstract T newInstance();

    /**
     * Validates that the Thrift entity instance contains all required fields after deserialization.
     * @param instance A Thrift entity instance.
     * @throws TException if unable to validate the instance.
     */
    protected abstract void validate(T instance) throws TException;

    /**
     * Generates a {@link JavaType} that matches the target Thrift field represented by the provided
     * {@code &lt;E&gt;} enumerated value.  If the field's type includes generics, the generics will
     * be added to the generated {@link JavaType} to support proper conversion.
     * @param thriftInstance The Thrift-generated class instance that will be converted to/from JSON.
     * @param field A {@code &lt;E&gt;} enumerated value that represents a field in a Thrift-based entity.
     * @return The {@link JavaType} representation of the type associated with the field.
     * @throws NoSuchFieldException if unable to determine the field's type.
     * @throws SecurityException if unable to determine the field's type.
     */
    protected JavaType generateValueType(final T thriftInstance, final E field) throws NoSuchFieldException, SecurityException {
        final TypeFactory typeFactory = TypeFactory.defaultInstance();

        final Field declaredField = thriftInstance.getClass().getDeclaredField(field.getFieldName());
        if(declaredField.getType().equals(declaredField.getGenericType())) {
            log.debug("Generating JavaType for type '{}'.", declaredField.getType());
            return typeFactory.constructType(declaredField.getType());
        } else {
            final ParameterizedType type = (ParameterizedType)declaredField.getGenericType();
            final Class&lt;?&gt;[] parameterizedTypes = new Class&lt;?&gt;[type.getActualTypeArguments().length];
            for(int i=0; i&lt;type.getActualTypeArguments().length; i++) {
                parameterizedTypes[i] = (Class&lt;?&gt;)type.getActualTypeArguments()[i];
            }
            log.debug("Generating JavaType for type '{}' with generics '{}'", declaredField.getType(), parameterizedTypes);
            return typeFactory.constructParametricType(declaredField.getType(), parameterizedTypes);
        }
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>This approach uses the <code>TFieldIdEnum</code> enumeration present in each <a href="https://thrift.apache.org/" target="_blank">Apache Thrift</a> object that defines the available fields in the object
to determine the mapping of the current JSON field into the <a href="https://thrift.apache.org/" target="_blank">Apache Thrift</a> object.  In order to ensure proper type coercion, an additional
method (<code>generateValueType</code>) is provided to handle cases where <a href="https://github.com/FasterXML/jackson" target="_blank">Jackson 2</a> needs to be instructed about possible generic types.  Finally,
the generated <a href="https://thrift.apache.org/" target="_blank">Apache Thrift</a> object is validated to ensure all required fields are present in the JSON.</p>
</div>
<div class="paragraph">
<p>In order to make this solution re-usable, three <code>abstract</code> methods are provided so that this common logic for de-serialization can be re-used
by more than one <a href="https://thrift.apache.org/" target="_blank">Apache Thrift</a> object:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">package com.example.json;

import org.apache.thrift.TException;

import com.example.v2.Book;

public class BookDeserializer extends AbstractThriftDeserializer&lt;Book._Fields, Book&gt; {

    @Override
    protected Book._Fields getField(final String fieldName) {
        return Book._Fields.valueOf(fieldName);
    }

    @Override
    protected Book newInstance() {
        return new Book();
    }

    @Override
    protected void validate(final Book instance) throws TException{
        instance.validate();
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The final step is to register our custom de-serializer with {spring} in our controller, just like we did for the custom serializer:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">import org.springframework.beans.factory.InitializingBean;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.http.HttpStatus;
import org.springframework.http.MediaType;
import org.springframework.http.ResponseEntity;
import org.springframework.http.converter.json.MappingJackson2HttpMessageConverter;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestMethod;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.bind.annotation.RestController;

import com.example.v1.Book;
import com.example.json.BookDeserializer;
import com.example.json.BookSerializer;
import com.fasterxml.jackson.core.Version;
import com.fasterxml.jackson.databind.ObjectMapper;
import com.fasterxml.jackson.databind.module.SimpleModule;

@RestController
@RequestMapping("/api/v1/books")
public class BookController implements InitializingBean {

    @Autowired
    private BookRepository bookRepository;

    @Autowired
    private MappingJackson2HttpMessageConverter mappingJackson2HttpMessageConverter;

    @Override
    public void afterPropertiesSet() throws Exception {
        // Register the custom Thrift &lt;&gt; JSON deserializers/serializers.
        final ObjectMapper mapper = mappingJackson2HttpMessageConverter.getObjectMapper();
        final SimpleModule bookModule = new SimpleModule("Book", new Version(1,0,0,null,null,null));
        bookModule.addSerializer(new BookSerializer());
        bookModule.addDeserializer(new BookDeserializer());
        mapper.registerModule(bookModule);
    }

    ....

    @RequestMapping(method=RequestMethod.POST, produces = {MediaType.APPLICATION_JSON_VALUE}, consumes = {MediaType.ALL_VALUE})
    public ResponseEntity&lt;Book&gt; createBook(@RequestParam(@RequestBody final Book book) {
        if(book != null) {
            // Save the book!
        } else {
            return new ResponseEntity&lt;Book&gt;(HttpStatus.BAD_REQUEST);
        }
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now, whenever a JSON payload is provided to the <code>createBook</code> method via an HTTP POST, <a href="https://github.com/FasterXML/jackson" target="_blank">Jackson 2</a> will handle the conversion of the JSON
into our <a href="https://thrift.apache.org/" target="_blank">Apache Thrift</a> <code>Book</code> object!  By combining both the serialization and de-serialization code, you can now re-use your <a href="https://thrift.apache.org/" target="_blank">Apache Thrift</a> model
as your DTO&#8217;s for an additional RESTful interface.</p>
</div>
</div>
</div></p>
                <p><a href="/blog2015/03/03/thrift_json_rest_spring_boot_ii.html#disqus_thread">Comments</a></p>
                   <a href="/blog/2015/02/24/thrift_json_rest_spring_boot_part_i.html"><h1>Using Thrift Generated Classes with a JSON REST API in Spring Boot - Part I</h1></a>
                   <p>24 February 2015</p>
                <p><em>Tags: </em>
                <a href="/blog/tags/spring.html">spring</a>
        
                <a href="/blog/tags/thrift.html">thrift</a>
        </p>

                <div class="g-plusone" data-size="medium" data-href="http://jdpgrailsdev.github.io/blog/2015/02/24/thrift_json_rest_spring_boot_part_i.html"></div>
                <script type="IN/Share" data-url="http://jdpgrailsdev.github.io/blog/2015/02/24/thrift_json_rest_spring_boot_part_i.html" data-counter="right"></script>
                <div class="fb-like" data-href="http://jdpgrailsdev.github.io/blog/2015/02/24/thrift_json_rest_spring_boot_part_i.html" data-layout="button_count" data-action="like" data-show-faces="false" data-share="true"></div>

                   <p><div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>If you use <a href="https://thrift.apache.org/" target="_blank">Apache Thrift</a> in your project, sometimes you may run into situations where you would like to be able interact with your service using
JSON and REST instead of the binary <a href="https://thrift.apache.org/" target="_blank">Apache Thrift</a> protocol.  If you try to simply serialize/deserialize your <a href="https://thrift.apache.org/" target="_blank">Apache Thrift</a> objects to/from JSON, you
will notice that a lot of additional cruft is included (such as the <code>isSet</code> fields, etc).  Furthermore, you don&#8217;t have any control over
include/excluding fields that have not yet been set, as most JSON libraries will happily include every field present in the class by default.
Luckily, you can tackle all of these issues by using some custom <a href="https://github.com/FasterXML/jackson" target="_blank">Jackson 2</a> code in combination with <a href="http://projects.spring.io/spring-boot/" target="_blank">Spring Boot</a> and <a href="https://spring.io/guides/gs/rest-service/" target="_blank">Spring&#8217;s REST support</a>.  In part
one of this series, I will show how to handle the serialization of <a href="https://thrift.apache.org/" target="_blank">Apache Thrift</a> objects into JSON.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_simple_rest_controller">Simple Rest Controller</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This first thing that you will need to create is a <code>RestController</code> to expose access to your <a href="https://thrift.apache.org/" target="_blank">Apache Thrift</a> objects.  Let&#8217;s assume that you have
the following <a href="https://thrift.apache.org/" target="_blank">Apache Thrift</a> object defined in your <a href="https://thrift.apache.org/" target="_blank">Apache Thrift</a> definition file:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-thrift" data-lang="thrift">namespace java com.example.v1

enum BookFormat {
    ELECTRONIC,
    HARDCOVER,
    PAPERBACK
}

struct Book {
    10:required string      author
    20:required string      title
    30:required string      isbn10
    40:required string      isbn13
    50:required BookFormat  format
    60:required i64         publishDate
    70:optional string      language
    80:optional i64         pages
    90:optional i64         edition
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>To provide a way to get a <code>Book</code> by title, you would create the following:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">import com.example.v1.Book;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.http.HttpStatus;
import org.springframework.http.MediaType;
import org.springframework.http.ResponseEntity;

import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestMethod;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.bind.annotation.RestController;

@RestController
@RequestMapping("/api/v1/books")
public class BookController {

    @Autowired
    private BookRepository bookRepository;

    @RequestMapping(method=RequestMethod.GET, produces = {MediaType.APPLICATION_JSON_VALUE}, consumes = {MediaType.ALL_VALUE})
    public ResponseEntity&lt;Book&gt; getBookByTitle(@RequestParam(value="title", required=true) final String title) {
        Book book = convertToThrift(bookRepository.findByTitle(title));
        if(book != null) {
            return new ResponseEntity&lt;Book&gt;(book, HttpStatus.OK);
        } else {
            return new ResponseEntity&lt;Book&gt;(HttpStatus.NOT_FOUND);
        }
    }

    private Book converToThrift(BookEntity bookEntity) {
        // Let's assume this method handles the creation of a Thrift-based Book from the JPA entity
        ...
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>When an HTTP GET is made to <a href="http://&lt;server&gt;:&lt;port&gt;/api/v1/books" class="bare">http://&lt;server&gt;:&lt;port&gt;/api/v1/books</a> with the query string <code>?title=&lt;some title&gt;</code> that matches a known book, the book will be
returned in JSON format.  As mentioned earlier, this will work with <a href="https://thrift.apache.org/" target="_blank">Apache Thrift</a> objects out of the box, as <a href="http://projects.spring.io/spring-boot/" target="_blank">Spring Boot</a> includes <a href="https://github.com/FasterXML/jackson" target="_blank">Jackson 2</a> support for
controllers annotated with the <code>RestController</code> annotation, but will included unwanted fields.  To address this, the next step is to add a custom
<a href="https://github.com/FasterXML/jackson" target="_blank">Jackson 2</a> serializer.  In this example, the code has been extracted to an abstract class to make it easier to add additional serializers and/or for
cases where composition is used in the <a href="https://thrift.apache.org/" target="_blank">Apache Thrift</a> definition file:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">package com.example.json;

import java.io.IOException;
import java.util.Collection;

import org.apache.thrift.TBase;
import org.apache.thrift.TFieldIdEnum;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import com.fasterxml.jackson.core.JsonGenerator;
import com.fasterxml.jackson.core.JsonProcessingException;
import com.fasterxml.jackson.databind.JsonSerializer;
import com.fasterxml.jackson.databind.SerializerProvider;
import com.google.common.base.CaseFormat;

/**
 * This abstract class represents a generic serializer for converting Thrift-based entities to JSON.
 *
 * @param &lt;E&gt; An implementation of the {@link TFieldIdEnum} interface.
 * @param &lt;T&gt; An implementation of the {@link TBase} interface.
 */
public abstract class AbstractThriftSerializer&lt;E extends TFieldIdEnum, T extends TBase&lt;T, E&gt;&gt; extends JsonSerializer&lt;T&gt; {

    private static final Logger log = LoggerFactory.getLogger(AbstractThriftSerializer.class);

    @Override
    public Class&lt;T&gt; handledType() {
        return getThriftClass();
    }

    @Override
    public void serialize(final T value, final JsonGenerator jgen, final SerializerProvider provider) throws IOException, JsonProcessingException {
        jgen.writeStartObject();
        for(final E field : getFieldValues()) {
            if(value.isSet(field)) {
                final Object fieldValue = value.getFieldValue(field);
                if(fieldValue != null) {
                    log.debug("Adding field {} to the JSON string...", CaseFormat.UPPER_CAMEL.to(CaseFormat.LOWER_UNDERSCORE,field.getFieldName()));
                    jgen.writeFieldName(CaseFormat.UPPER_CAMEL.to(CaseFormat.LOWER_UNDERSCORE,field.getFieldName()));
                    if(fieldValue instanceof Short) {
                        jgen.writeNumber((Short)fieldValue);
                    } else if(fieldValue instanceof Integer) {
                        jgen.writeNumber((Integer)fieldValue);
                    } else if(fieldValue instanceof Long) {
                        jgen.writeNumber((Long)fieldValue);
                    } else if(fieldValue instanceof Double) {
                        jgen.writeNumber((Double)fieldValue);
                    } else if(fieldValue instanceof Float) {
                        jgen.writeNumber((Float)fieldValue);
                    } else if(fieldValue instanceof Boolean) {
                        jgen.writeBoolean((Boolean)fieldValue);
                    } else if(fieldValue instanceof String) {
                        jgen.writeString(fieldValue.toString());
                    } else if(fieldValue instanceof Collection) {
                        log.debug("Array opened for field {}.", CaseFormat.UPPER_CAMEL.to(CaseFormat.LOWER_UNDERSCORE,field.getFieldName()));
                        jgen.writeStartArray();
                        for(final Object arrayObject : (Collection&lt;?&gt;)fieldValue) {
                            jgen.writeObject(arrayObject);
                        }
                        jgen.writeEndArray();
                        log.debug("Array closed for field {}.", CaseFormat.UPPER_CAMEL.to(CaseFormat.LOWER_UNDERSCORE,field.getFieldName()));
                    } else {
                        jgen.writeObject(fieldValue);
                    }
                } else {
                    log.debug("Skipping converting field {} to JSON:  value is null!", CaseFormat.UPPER_CAMEL.to(CaseFormat.LOWER_UNDERSCORE,field.getFieldName()));
                }
            } else {
                log.debug("Skipping converting field {} to JSON:  field has not been set!", CaseFormat.UPPER_CAMEL.to(CaseFormat.LOWER_UNDERSCORE,field.getFieldName()));
            }
        }
        jgen.writeEndObject();
    }

    /**
     * Returns an array of {@code &lt;E&gt;} enumerated values that represent the fields present in the
     * Thrift class associated with this serializer.
     * @return The array of {@code &lt;E&gt;} enumerated values that represent the fields present in the
     *   Thrift class.
     */
    protected abstract E[] getFieldValues();

    /**
     * Returns the {@code &lt;T&gt;} implementation class associated with this serializer.
     * @return The {@code &lt;T&gt;} implementation class
     */
    protected abstract Class&lt;T&gt; getThriftClass();
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>AbstractThriftSerializer</code> extends the <a href="https://github.com/FasterXML/jackson" target="_blank">Jackson 2</a> <code>JsonSerializer</code> to provide instructions to <a href="https://github.com/FasterXML/jackson" target="_blank">Jackson 2</a> on how to convert
a <a href="https://thrift.apache.org/" target="_blank">Apache Thrift</a> based object to JSON.  In particular, it uses the <code>TFieldIdEnum</code> enumeration found in each <a href="https://thrift.apache.org/" target="_blank">Apache Thrift</a> generated class
that provides metadata about each field in the class.  If a value has been set for the each field, the value is converted
to JSON based on the Java type associated with that field.  In addition, some additional logic was added to convert the
camel cased field names to lower case underscore format using <a href="https://github.com/google/guava" target="_blank">Google Guava</a>'s <code>CaseFormat</code> utility.  Implementations of this abstract
class simply need to provide access to the <code>TFieldIdEnum</code> enumeration declared within the class, as well as the specific type
for registration with <a href="https://github.com/FasterXML/jackson" target="_blank">Jackson 2</a>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">package com.example.json;

import com.example.v2.Book;
import com.example.v2.Book._Fields;

public class BookSerializer extends AbstractThriftSerializer&lt;Book._Fields, Book&gt; {

    @Override
    protected _Fields[] getFieldValues() {
        return Book._Fields.values();
    }

    @Override
    protected Class&lt;Book&gt; getThriftClass() {
        return Book.class;
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The final step is to register the custom serializer with <a href="http://projects.spring.io/spring-boot/" target="_blank">Spring Boot</a> so that the REST
controller will use it when converting our <code>Book</code> object to JSON.  Let&#8217;s re-visit the <code>BookController</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">import org.springframework.beans.factory.InitializingBean;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.http.HttpStatus;
import org.springframework.http.MediaType;
import org.springframework.http.ResponseEntity;
import org.springframework.http.converter.json.MappingJackson2HttpMessageConverter;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestMethod;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.bind.annotation.RestController;

import com.example.v1.Book;
import com.fasterxml.jackson.core.Version;
import com.fasterxml.jackson.databind.ObjectMapper;
import com.fasterxml.jackson.databind.module.SimpleModule;

@RestController
@RequestMapping("/api/v1/books")
public class BookController implements InitializingBean {

    @Autowired
    private BookRepository bookRepository;

    @Autowired
    private MappingJackson2HttpMessageConverter mappingJackson2HttpMessageConverter;

    @Override
    public void afterPropertiesSet() throws Exception {
        // Register the custom Thrift &lt;&gt; JSON deserializers/serializers.
        final ObjectMapper mapper = mappingJackson2HttpMessageConverter.getObjectMapper();
        final SimpleModule bookModule = new SimpleModule("Book", new Version(1,0,0,null,null,null));
        bookModule.addSerializer(new BookSerializer());
        mapper.registerModule(bookModule);
    }

    @RequestMapping(method=RequestMethod.GET, produces = {MediaType.APPLICATION_JSON_VALUE}, consumes = {MediaType.ALL_VALUE})
    public ResponseEntity&lt;Book&gt; getBookByTitle(@RequestParam(value="title", required=true) final String title) {
        Book book = convertToThrift(bookRepository.findByTitle(title));
        if(book != null) {
            return new ResponseEntity&lt;Book&gt;(book, HttpStatus.OK);
        } else {
            return new ResponseEntity&lt;Book&gt;(HttpStatus.NOT_FOUND);
        }
    }

    private Book converToThrift(BookEntity bookEntity) {
        // Let's assume this method handles the creation of a Thrift-based Book from the JPA entity
        ...
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>So, what did we add?  First, we modified the <code>BookController</code> to implement the <code>InitializingBean</code> interface so that we could handle the
<a href="https://github.com/FasterXML/jackson" target="_blank">Jackson 2</a> configuration at bean creation time.  Second, we injected the <code>MappingJackson2HttpMessageConverter</code>, which is provided by
{sprinb_boot} to handle the conversion of entities to JSON when a controller action is marked to produce JSON.  Finally, we implemented
the <code>afterPropertiesSet</code> method of the <code>InitializingBean</code> interface to register our <code>BookSerializer</code> with the <a href="https://github.com/FasterXML/jackson" target="_blank">Jackson 2</a> <code>ObjectMapper</code>
used by the <code>MappingJackson2HttpMessageConverter</code>.  Now, when we perform an HTTP GET against our endpoint for a book title that matches
an existing book, we will see the following JSON response:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-json" data-lang="json">{
    "author" : "Rob Friesel",
    "title" : "PhamtomJS Cookbook",
    "isbn_10" : "178398192X",
    "isbn_13" : "978-1783981922",
    "format" : "PAPERBACK",
    "publish_date" : 1402531200000,
    "language" : "English",
    "pages" : 276,
    "edition" : 1
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>So, what did we accomplish.  First, we were able to customize how <a href="https://github.com/FasterXML/jackson" target="_blank">Jackson 2</a> converts an object to JSON.  Second, we were able to convert our
<a href="https://thrift.apache.org/" target="_blank">Apache Thrift</a> objects to JSON in a manner of our choosing.  Third, we did all of this without having to create any new DTO&#8217;s or extend from our
generated <a href="https://thrift.apache.org/" target="_blank">Apache Thrift</a> objects.  In the next post, I will show how to handle the custom deserialization of JSON into <a href="https://thrift.apache.org/" target="_blank">Apache Thrift</a> based objects.</p>
</div>
</div>
</div></p>
                <p><a href="/blog2015/02/24/thrift_json_rest_spring_boot_part_i.html#disqus_thread">Comments</a></p>
                   <a href="/blog/2015/01/27/spring_jpa_postgresql_hstore.html"><h1>Custom PostgreSQL Hstore Data Type with Spring, JPA and Hibernate</h1></a>
                   <p>27 January 2015</p>
                <p><em>Tags: </em>
                <a href="/blog/tags/spring.html">spring</a>
        
                <a href="/blog/tags/java.html">java</a>
        
                <a href="/blog/tags/jpa.html">jpa</a>
        
                <a href="/blog/tags/postgresql.html">postgresql</a>
        </p>

                <div class="g-plusone" data-size="medium" data-href="http://jdpgrailsdev.github.io/blog/2015/01/27/spring_jpa_postgresql_hstore.html"></div>
                <script type="IN/Share" data-url="http://jdpgrailsdev.github.io/blog/2015/01/27/spring_jpa_postgresql_hstore.html" data-counter="right"></script>
                <div class="fb-like" data-href="http://jdpgrailsdev.github.io/blog/2015/01/27/spring_jpa_postgresql_hstore.html" data-layout="button_count" data-action="like" data-show-faces="false" data-share="true"></div>

                   <p><div class="paragraph">
<p>Starting <a href="http://www.postgresql.org" target="_blank">PostgreSQL</a> version 9.0, the <a href="http://www.postgresql.org/docs/9.4/static/hstore.html" target="_blank">PostgreSQL hstore datatype</a> data type was introduced, which allows for the storing of arbitrary sets of key/value pairs within a single column.  This
data type can be leveraged for a bunch of different situations, such as for storing custom/random attributes, semi-structured data or in any scenario where the number and
type of columns associated with an entity stored in a table varies.  As with most new/database vendor-specific features, support for the <a href="http://www.postgresql.org/docs/9.4/static/hstore.html" target="_blank">PostgreSQL hstore datatype</a> data type does not exist
as a first-level data type in the <a href="http://www.postgresql.org" target="_blank">PostgreSQL</a> dialect provided by <a href="https://hibernate.org" target="_blank">Hibernate</a>.  However, both JPA and <a href="https://hibernate.org" target="_blank">Hibernate</a> provide mechanisms that allow you to customize the
way in which data stored in an entity is prepared for insertion into a database table and vice-versa.  The <a href="http://en.wikibooks.org/wiki/Java_Persistence/Basic_Attributes#Converters_.28JPA_2.1.29" target="_blank">JPA Attribute Converter</a> specification allows you to provide
a custom <code>AttributeConverter</code> implementation that governs how data stored in a field of an entity gets converted for storage in the database and how to convert the column
data back into a Java type.  Normally, this would be how you would implement support for an un-supported data type.  However, due to an <a href="https://hibernate.atlassian.net/browse/HHH-8804" target="_blank">Hibernate issue with Converters and parameterized types</a>, this won&#8217;t work
for the <a href="http://www.postgresql.org/docs/9.4/static/hstore.html" target="_blank">PostgreSQL hstore datatype</a>, unless you want to map it to a Java <code>String</code> type instead of a Java <code>Map&lt;String,Object&gt;</code> type, which makes more sense for an arbitrary key/value store.
The solution?  Leverage <a href="https://docs.jboss.org/hibernate/orm/3.6/reference/en-US/html/types.html#types-custom-ut" target="_blank">Hibernate&#8217;s Custom Types</a> support!</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">package com.example.jpa.support;

import java.io.Serializable;
import java.sql.PreparedStatement;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.util.HashMap;
import java.util.Map;
import java.util.StringTokenizer;
import java.util.regex.Matcher;
import java.util.regex.Pattern;

import org.hibernate.HibernateException;
import org.hibernate.engine.spi.SessionImplementor;
import org.hibernate.usertype.UserType;

/**
 * Custom Hibernate {@link UserType} used to convert between a {@link Map}
 * and PostgreSQL {@code hstore} data type.
 */
public class HstoreUserType implements UserType {

    /**
     * PostgreSQL {@code hstore} field separator token.
     */
    private static final String HSTORE_SEPARATOR_TOKEN = "=&gt;";

    /**
     * {@link Pattern} used to find and split {@code hstore} entries.
     */
    private static final Pattern HSTORE_ENTRY_PATTERN = Pattern.compile(String.format("\"(.*)\"%s\"(.*)\"", HSTORE_SEPARATOR_TOKEN));

    /**
     * The PostgreSQL value for the {@code hstore} data type.
     */
    public static final int HSTORE_TYPE = 1111;

    @Override
    public int[] sqlTypes() {
        return new int[] { HSTORE_TYPE };
    }

    @SuppressWarnings("rawtypes")
    @Override
    public Class returnedClass() {
        return Map.class;
    }

    @Override
    public boolean equals(final Object x, final Object y) throws HibernateException {
        return x.equals(y);
    }

    @Override
    public int hashCode(final Object x) throws HibernateException {
        return x.hashCode();
    }

    @Override
    public Object nullSafeGet(final ResultSet rs, final String[] names,
            final SessionImplementor session, final Object owner)
            throws HibernateException, SQLException {
        return convertToEntityAttribute(rs.getString(names[0]));
    }

    @SuppressWarnings("unchecked")
    @Override
    public void nullSafeSet(final PreparedStatement st, final Object value, final int index,
            final SessionImplementor session) throws HibernateException, SQLException {
        st.setObject(index, convertToDatabaseColumn((Map&lt;String,Object&gt;)value), HSTORE_TYPE);

    }

    @SuppressWarnings("unchecked")
    @Override
    public Object deepCopy(final Object value) throws HibernateException {
        return new HashMap&lt;String,Object&gt;(((Map&lt;String,Object&gt;)value));
    }

    @Override
    public boolean isMutable() {
        return true;
    }

    @Override
    public Serializable disassemble(final Object value) throws HibernateException {
        return (Serializable) value;
    }

    @Override
    public Object assemble(final Serializable cached, final Object owner)
            throws HibernateException {
        return cached;
    }

    @Override
    public Object replace(final Object original, final Object target, final Object owner)
            throws HibernateException {
        return original;
    }


    private String convertToDatabaseColumn(final Map&lt;String, Object&gt; attribute) {
        final StringBuilder builder = new StringBuilder();
        for (final Map.Entry&lt;String, Object&gt; entry : attribute.entrySet()) {
            if(builder.length() &gt; 1) {
                builder.append(", ");
            }
            builder.append("\"");
            builder.append(entry.getKey());
            builder.append("\"");
            builder.append(HSTORE_SEPARATOR_TOKEN);
            builder.append("\"");
            builder.append(entry.getValue().toString());
            builder.append("\"");
        }
        return builder.toString();
    }

    private Map&lt;String, Object&gt; convertToEntityAttribute(final String dbData) {
        final Map&lt;String, Object&gt; data = new HashMap&lt;String, Object&gt;();
        final StringTokenizer tokenizer = new StringTokenizer(dbData, ",");

        while(tokenizer.hasMoreTokens()) {
            final Matcher matcher = HSTORE_ENTRY_PATTERN.matcher(tokenizer.nextToken().trim());
            if(matcher.find()) {
                data.put(matcher.group(1), matcher.group(2));
            }
        }

        return data;
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The example above implements the <a href="https://hibernate.org" target="_blank">Hibernate</a> <code>UserType</code> interface and provides methods (<code>nullSafeGet</code> and <code>nullSafeSet</code>) to handle the conversion.  It also provides the appropriate
data type value for the <a href="http://www.postgresql.org/docs/9.4/static/hstore.html" target="_blank">PostgreSQL hstore datatype</a> (1111).  Now that you have a custom <code>UserType</code> implementation for the <a href="http://www.postgresql.org/docs/9.4/static/hstore.html" target="_blank">PostgreSQL hstore datatype</a>, the next step is to annotate your entity class to instruct JPA to
use the custom type during mapping:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">package com.example.jpa.entity;

import javax.persistence.Column;
import javax.persistence.Entity;
import javax.persistence.Table;

import org.hibernate.annotations.GenericGenerator;
import org.hibernate.annotations.Type;
import org.hibernate.annotations.TypeDef;

import com.example.jpa.support.HstoreUserType;

@Entity
@Table(name = "books")
@TypeDef(name = "hstore", typeClass = HstoreUserType.class)
public class BookEntity {

    @Column(name="metadata")
    @Type(type="hstore")
    private Map&lt;String,Object&gt; metadata;

    ...
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>TypeDef</code> is given a name so that it can be referenced when applied to the field via the <code>Type</code> annotation.  Now, when data is persisted or retrieved, our custom <code>UserType</code> implementation
will be invoked to handle the data.  It is also worth noting that the <a href="http://www.postgresql.org" target="_blank">PostgreSQL</a> JDBC driver library does come with an <code>HStoreConverter</code> class with static methods that could be leveraged from
inside the custom <code>UserType</code> to handle the conversion to/from a <code>Map&lt;String,Object&gt;</code> to a <code>String</code> and vice versa.  However, I would not recommend an implementation that depends on an internal
class from the JDBC driver, as it may cause compatibility issues if you upgrade.</p>
</div></p>
                <p><a href="/blog2015/01/27/spring_jpa_postgresql_hstore.html#disqus_thread">Comments</a></p>
                   <a href="/blog/2015/01/20/spring_transactions_rollback.html"><h1>Rollbacks with Spring Transactions</h1></a>
                   <p>20 January 2015</p>
                <p><em>Tags: </em>
                <a href="/blog/tags/spring.html">spring</a>
        
                <a href="/blog/tags/java.html">java</a>
        </p>

                <div class="g-plusone" data-size="medium" data-href="http://jdpgrailsdev.github.io/blog/2015/01/20/spring_transactions_rollback.html"></div>
                <script type="IN/Share" data-url="http://jdpgrailsdev.github.io/blog/2015/01/20/spring_transactions_rollback.html" data-counter="right"></script>
                <div class="fb-like" data-href="http://jdpgrailsdev.github.io/blog/2015/01/20/spring_transactions_rollback.html" data-layout="button_count" data-action="like" data-show-faces="false" data-share="true"></div>

                   <p><div class="paragraph">
<p>By default, no rollback handling rules are defined if you simply add <code>@Transactional</code> to your method.  In order for the rollback to actually be executed upon failure,
you must define one or more exceptions that you want to trigger a rollback via the <code>rollbackFor</code> or <code>rollbackForClassName</code> attributes of the annotation:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">@Transactional(rollbackForClassName={"Exception"})
public void save(final Book book) {
    Author author = new Author(book.getAuthorName());
    authorRepository.saveAndFlush(author);
    bookRepository.saveAndFlush(book);
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>In the example above, the <code>@Transactional</code> annotation makes use of the <code>rollbackForClassName</code> attribute value to force
a database rollback if any exception of type <code>java.lang.Exception</code> is thrown by the method (e.g. if any exception happens,
roll both save operations back).  The <code>rollbackForClassName</code> attribute actually provides a little more flexibility than the
<code>rollbackFor</code> attribute value.  From the <code>@Transactional</code> JavaDoc:</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>Consider carefully how specific the pattern is, and whether
to include package information (which isn&#8217;t mandatory). For example,
"Exception" will match nearly anything, and will probably hide other rules.
"java.lang.Exception" would be correct if "Exception" was meant to define
a rule for all checked exceptions. With more unusual java.lang.Exception
names such as "BaseBusinessException" there is no need to use a FQN.</p>
</div>
</blockquote>
<div class="attribution">
&#8212; org.springframework.transaction.annotation.Transactional#rollbackForClassName() JavaDoc
</div>
</div>
<div class="paragraph">
<p>As you can see, it gives you the ability to provide rules to match certain sub-strings of exception
types to better control your rollback logic.</p>
</div></p>
                <p><a href="/blog2015/01/20/spring_transactions_rollback.html#disqus_thread">Comments</a></p>

                <hr />

                <p>Older posts are available in the <a href="/blog/archive.html">archive</a>.</p>

            </div>
            <div id="push"></div>
        </div>

        <div id="footer">
              <div class="container">
                <p class="muted credit">&copy; 2014 | Mixed with <a href="http://getbootstrap.com/">Bootstrap v3.1.1</a> | Baked with <a href="http://jbake.org">JBake v2.3.2</a> | Comments powered by <a href="http://disqus.com">Disqus</a></p>
              </div>
        </div>

        <!-- Le javascript
        ================================================== -->
        <!-- Placed at the end of the document so the pages load faster -->
        <script src="https://code.jquery.com/jquery.js" type="text/javascript"></script>
        <script src="//netdna.bootstrapcdn.com/bootstrap/3.1.1/js/bootstrap.min.js" type="text/javascript"></script>
        <script src="/blog/js/run_prettify.js" type="text/javascript"></script>
        <script src="/blog/js/github_activity.js" type="text/javascript"></script>
        <script type="text/javascript">
            /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
            var disqus_shortname = 'jdpearlin'; // required: replace example with your forum shortname

            /* * * DON'T EDIT BELOW THIS LINE * * */
            (function() {
                var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
                dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
                (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
            })();
        </script>
        <script type="text/javascript">
              window.___gcfg = {lang: 'en'};

              (function() {
                var po = document.createElement('script'); po.type = 'text/javascript'; po.async = true;
                po.src = 'https://apis.google.com/js/plusone.js';
                var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(po, s);
              })();
        </script>
        <script type="text/javascript">
            (function(d, s, id) {
                  var js, fjs = d.getElementsByTagName(s)[0];
                  if (d.getElementById(id)) return;
                  js = d.createElement(s); js.id = id;
                  js.src = "//connect.facebook.net/en_US/all.js#xfbml=1";
                  fjs.parentNode.insertBefore(js, fjs);
            }(document, 'script', 'facebook-jssdk'));
        </script>
        <script src="//platform.linkedin.com/in.js" type="text/javascript"></script>
        <script type="text/javascript">
          (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
          (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
          m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
          })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

          ga('create', 'UA-47885115-1', 'jdpgrailsdev.github.io');
          ga('send', 'pageview');
        </script>
    </body>
</html>
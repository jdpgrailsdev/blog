<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8"/>
        <title>The Flowers Are Still Standing :: Integrating JBoss tattletale with Grails</title>
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <meta name="description" content="" />
        <meta name="author" content="Jonathan Pearlin" />
        <meta name="keywords" content="" />
        <meta name="generator" content="JBake" />

        <!-- Le styles -->
        <link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.1.0/css/bootstrap.min.css">
        <link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.1.0/css/bootstrap-theme.min.css">
        <link href="/blog/css/asciidoctor.css" rel="stylesheet">
        <link href="/blog/css/base.css" rel="stylesheet">
        <link href="//netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.css" rel="stylesheet">
        <link href='http://fonts.googleapis.com/css?family=Droid+Sans' rel='stylesheet' type='text/css'>

        <!-- HTML5 shim, for IE6-8 support of HTML5 elements -->
        <!--[if lt IE 9]>
              <script src="/blog/js/html5shiv.js"></script>
        <![endif]-->

        <!-- Fav and touch icons -->
        <!--
        <link rel="apple-touch-icon-precomposed" sizes="144x144" href="../assets/ico/apple-touch-icon-144-precomposed.png" />
        <link rel="apple-touch-icon-precomposed" sizes="114x114" href="../assets/ico/apple-touch-icon-114-precomposed.png" />
        <link rel="apple-touch-icon-precomposed" sizes="72x72" href="../assets/ico/apple-touch-icon-72-precomposed.png" />
        <link rel="apple-touch-icon-precomposed" href="../assets/ico/apple-touch-icon-57-precomposed.png" />
        -->
        <link rel="shortcut icon" href="/blog/favicon.ico" />
    </head>
    <body>
        <div id="wrap">
            <!-- Fixed navbar -->
            <div class="navbar navbar-default navbar-fixed-top" role="navigation">
                <div class="container">
                    <div class="navbar-header">
                        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                            <span class="icon-bar"></span>
                            <span class="icon-bar"></span>
                            <span class="icon-bar"></span>
                        </button>
                        <a class="navbar-brand" href="/blog/index.html">Jonathan Pearlin's Blog</a>
                    </div>
                    <div class="navbar-collapse collapse">
                        <ul class="nav navbar-nav">
                            <li><a href="/blog/about.html">About</a></li>
                            <li><a href="/blog/resume.html">Résumé</a></li>
                            <li class="dropdown">
                                <a data-toggle="dropdown" href="#">Tags<b class="caret"></b></a>
                                <ul class="dropdown-menu" role="menu">
                                    <li><a href="/blog/tags/grails.html">Grails</a></li>
                                    <li><a href="/blog/tags/groovy.html">Groovy</a></li>
                                    <li><a href="/blog/tags/java.html">Java</a></li>
                                    <li><a href="/blog/tags/maven.html">Maven</a></li>
                                    <li><a href="/blog/tags/spring.html">Spring</a></li>
                                </ul>
                            </li>
                            <li><a href="/blog/feed.xml">Feed</a></li>
                        </ul>
                        <ul class="nav navbar-nav navbar-right">
                            <li><a href="https://github.com/jdpgrailsdev" target="_blank"><i class="fa fa-github"></i></a></li>
                            <li><a href="http://www.linkedin.com/pub/jonathan-pearlin/4/946/9a0" style="text-decoration:none;" target="_blank"><i class="fa fa-linkedin-square"></i></a></li>
                        </ul>
                    </div>
                </div>
            </div>
            <div class="container">
    <div class="page-header">
        <h1>Integrating JBoss tattletale with Grails</h1>
    </div>

    <p><em>04 March 2014</em></p>

    <div class="g-plusone" data-size="medium" data-href="http://jdpgrailsdev.github.io/blog//2014/03/04/grails_tattletale.html"></div>
    <script type="IN/Share" data-url="http://jdpgrailsdev.github.io/blog//2014/03/04/grails_tattletale.html" data-counter="right"></script>
    <div class="fb-like" data-href="http://jdpgrailsdev.github.io/blog//2014/03/04/grails_tattletale.html" data-layout="button_count" data-action="like" data-show-faces="false" data-share="true"></div>

    <p><div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>Prior to version 2.3 of the <a href="http://grails.org">Grails</a> Framework, it was difficult, if not impossible, to use <a href="http://maven.apache.org/">Maven</a> to build a <a href="http://grails.org">Grails</a>-based application or plugin.  Besides losing the obvious benefits of <a href="http://maven.apache.org/">Maven</a>-based builds,
such as dependency management and the rich ecosystem of existing plugins, one of the things that is lacking is an easy way to enforce environmental constraints, such as with the <a href="http://maven.apache.org/enforcer/maven-enforcer-plugin/">Maven Enforcer plugin</a>. The <a href="http://maven.apache.org/enforcer/maven-enforcer-plugin/">Maven Enforcer plugin</a>
includes the ability to <a href="http://mojo.codehaus.org/extra-enforcer-rules/banDuplicateClasses.html">fail a build when detecting multiple versions of the same class on the classpath</a>.  This is particularly handy when an
application depends on libraries that include classes from another library in order to reduce the number of required dependencies (this is particularly common with libraries that are not published to a <a href="http://maven.apache.org/">Maven</a>
repository or some other type of dependency management repository).  Since using the <a href="http://maven.apache.org/enforcer/maven-enforcer-plugin/">Maven Enforcer plugin</a> is not an option in applications using <a href="http://grails.org">Grails</a> &lt;2.3, I decided to look at other alternatives to provide the
duplicate class checking functionality.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_jboss_tattletale">JBoss tattletale</h3>
<div class="paragraph">
<p><a href="http://www.jboss.org/tattletale">JBoss tattletale</a> is a similar project to the <a href="http://maven.apache.org/enforcer/maven-enforcer-plugin/">Maven Enforcer plugin</a> in that it provides many of the same analytics with regards to the classes and dependencies that are part of a Java library/application.  In addition to its
feature set, <a href="http://www.jboss.org/tattletale">JBoss tattletale</a> also has the ability to be embedded/called programmatically, which is a must for integrating it into a <a href="http://grails.org">Grails</a> <a href="http://gant.codehaus.org/">Gant</a> script.  The first step to including a <a href="http://grails.org">Grails</a> command line target
that can perform the <a href="http://www.jboss.org/tattletale">JBoss tattletale</a> analysis is to include the <a href="http://www.jboss.org/tattletale">JBoss tattletale</a> dependency as a <code>build</code> scoped dependency:</p>
</div>
<div class="listingblock">
<div class="title">BuildConfig.groovy</div>
<div class="content">
<pre class="prettyprint groovy language-groovy"><code>grails.project.dependency.resolution = {

    ...

    dependencies {

        // Required to generate the TattleTale report by the TattleTale GANT script.
        build 'org.jboss.tattletale:tattletale:1.1.2.Final'

        ...
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>This makes the dependency available to the <a href="http://gant.codehaus.org/">Gant</a> script without exporting the dependency when the application or plugin is package (or in the case of a plugin, the dependency is not added to the classpath when it is
consumed by a <a href="http://grails.org">Grails</a> application).  The next step is to write a <a href="http://gant.codehaus.org/">Gant</a> script that performs the <a href="http://www.jboss.org/tattletale">JBoss tattletale</a> analysis.  Below is an example script that I wrote that expands the packaged application, runs the analysis
and then outputs the HTML report to the <code>target/tattletale-report</code> directory:</p>
</div>
<div class="listingblock">
<div class="title">scripts/TattleTale.groovy</div>
<div class="content">
<pre class="prettyprint groovy language-groovy"><code>import org.jboss.tattletale.Main

includeTargets &lt;&lt; grailsScript("_GrailsArgParsing")
includeTargets &lt;&lt; grailsScript("_GrailsSettings")
includeTargets &lt;&lt; grailsScript("_GrailsClasspath")

// Default list of comma separated report names to generate.
DEFAULT_REPORTS='multiplejars'

// Default list of comma separated JAR files to exclude.  These JARS are from the Grails global dependencies,
// so there is not a lot we can do about resolving duplicate classes from the JAR files.
DEFAULT_EXCLUDES='commons-beanutils-1.8.3.jar,commons-logging-1.1.1.jar,aspectjrt-1.6.10.jar,grails-plugin-controllers-2.0.3.jar'

/*
 * Target used to generated the TattleTale (http://www.jboss.org/tattletale/) report for the encapsulating Grails application.
 * The application's archive (WAR file) MUST be built prior to running this script to invoke the TattleTale report.  If
 * the WAR file is present, the following steps are performed:
 *
 *     1) The previous report is deleted.
 *     2) The archive is unzipped to the target directory of the application.
 *     3) The TattleTale report(s) are generated.
 *     4) The expanded archive is deleted.
 *
 * The TattleTale reports that are generated can be configured by running the script with the following option:
 *
 *     grails tattleTale --reports=mulitplelocations,multiplejars
 *
 * The files that are scanned by TattleTale can be configured by adding additional exclusions via an argument:
 *
 *     grails tattleTale --excludes=foo.jar,bar.jar
 *
 * See the TattleTale User's Guide for information about the available reports (http://docs.jboss.org/tattletale/userguide/1.1/html_single/#maven_report).
 */
target(tattleTale: "Called from build jobs on Hudson to perform a TattleTale analysis on the application's archive.") {
    parseArguments()

    def appName = metadata['app.name']
    def reports = argsMap.reports ?: DEFAULT_REPORTS
    def excludes = argsMap.excludes ? "${DEFAULT_EXCLUDES},${argsMap.excludes}" : DEFAULT_EXCLUDES
    def archiveFile = "target/${appName}.war"
    def expandedArchiveDir = "target/${appName}"
    def reportDir = 'target/tattletale-report'

    if(new File(archiveFile).exists()) {
        ant.delete(dir:reportDir, failonerror:"false", verbose:"true")
        grailsConsole.addStatus "************ Unzipping application archive '${archiveFile}'..."
        ant.unzip(src: archiveFile , dest:expandedArchiveDir, overwrite:"true")
        grailsConsole.addStatus "************ Running TattleTask report for '${appName}'..."
        executeTattleTale("${expandedArchiveDir}/WEB-INF/lib", reportDir, reports, excludes)
        grailsConsole.addStatus "************ Removing expanded archive for application '${appName}'..."
        ant.delete(dir:expandedArchiveDir, failonerror:"false", verbose:"true")
        grailsConsole.addStatus "************ Duplicate class check for application '${appName}' completed."
        grailsConsole.addStatus "************ TattleTale report available in '${new File(reportDir).absolutePath}/index.html'..."
    } else {
        grailsConsole.warn "Application archive file ${archiveFile} does NOT exist.  Nothing to report!  Please build the WAR file before running this script."
    }
}

/**
 * Executes the TattleTale report.
 * @param source The source directory containing JAR files.
 * @param destination The output destination directory for the generated report(s).
 * @param reports The comma separated string containing the names of the reports to generate.
 * @param excludes The comma separated string containing the names of directories or files to exludes
 */
private def executeTattleTale(def source, def destination, def reports, def excludes) {
    def tattleTale = new Main()
    tattleTale.source = source
    tattleTale.destination = destination
    tattleTale.reports = reports
    tattleTale.excludes = excludes
    tattleTale.profiles = 'spring30,java6'
    tattleTale.execute()
}

setDefaultTarget(tattleTale)</code></pre>
</div>
</div>
<div class="paragraph">
<p>Note that the script above requires the user to first run <code>grails war</code> or <code>grails package-plugin</code> prior to running the <code>grails tattletale</code> target command.  It is also possible to hook into the <a href="http://grails.org">Grails</a> events that get fired to perform the analysis after
compilation has been completed, which would avoid the need to expand the packaged WAR file.  Regardless of how you choose to implement the execution of <a href="http://www.jboss.org/tattletale">JBoss tattletale</a>, the end result is still valuable.</p>
</div>
</div></p>

    <div class="g-plusone" data-size="medium" data-href="http://jdpgrailsdev.github.io/blog/blog/2014/03/04/grails_tattletale.html"></div>
    <script type="IN/Share" data-url="http://jdpgrailsdev.github.io/blog//2014/03/04/grails_tattletale.html" data-counter="right"></script>
    <div class="fb-like" data-href="http://jdpgrailsdev.github.io/blog//2014/03/04/grails_tattletale.html" data-layout="button_count" data-action="like" data-show-faces="false" data-share="true"></div>

    <div id="disqus_thread"></div>
    <script type="text/javascript">
        var disqus_shortname = 'jdpgrailsdevblog';
        var disqus_identifier = '/2014/03/04/grails_tattletale.html';
        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

    <hr>

            </div>
            <div id="push"></div>
        </div>

        <div id="footer">
              <div class="container">
                <p class="muted credit">&copy; 2014 | Mixed with <a href="http://twitter.github.com/bootstrap/">Bootstrap v3.1.0</a> | Baked with <a href="http://jbake.org">JBake v2.3.0-SNAPSHOT</a> | Comments powered by <a href="http://disqus.com">Disqus</a></p>
              </div>
        </div>

        <!-- Le javascript
        ================================================== -->
        <!-- Placed at the end of the document so the pages load faster -->
        <script src="https://code.jquery.com/jquery.js"></script>
        <script src="//netdna.bootstrapcdn.com/bootstrap/3.1.0/js/bootstrap.min.js"></script>
        <script src="/blog/js/run_prettify.js"></script>
        <script type="text/javascript">
            /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
            var disqus_shortname = 'jdpearlin'; // required: replace example with your forum shortname

            /* * * DON'T EDIT BELOW THIS LINE * * */
            (function() {
                var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
                dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
                (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
            })();
        </script>
        <script type="text/javascript">
              window.___gcfg = {lang: 'en'};

              (function() {
                var po = document.createElement('script'); po.type = 'text/javascript'; po.async = true;
                po.src = 'https://apis.google.com/js/plusone.js';
                var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(po, s);
              })();
        </script>
        <script>
            (function(d, s, id) {
                  var js, fjs = d.getElementsByTagName(s)[0];
                  if (d.getElementById(id)) return;
                  js = d.createElement(s); js.id = id;
                  js.src = "//connect.facebook.net/en_US/all.js#xfbml=1";
                  fjs.parentNode.insertBefore(js, fjs);
            }(document, 'script', 'facebook-jssdk'));
        </script>
        <script src="//platform.linkedin.com/in.js" type="text/javascript"></script>
        <script>
          (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
          (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
          m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
          })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

          ga('create', 'UA-47885115-1', 'jdpgrailsdev.github.io');
          ga('send', 'pageview');
        </script>
    </body>
</html>
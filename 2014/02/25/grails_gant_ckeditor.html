<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8"/>
        <title>The Flowers Are Still Standing</title>
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <meta name="description" content="" />
        <meta name="author" content="Jonathan Pearlin" />
        <meta name="keywords" content="" />
        <meta name="generator" content="JBake" />

        <!-- Le styles -->
        <link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css">
		<link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap-theme.min.css">
        <link href="/blog/css/asciidoctor.css" rel="stylesheet">
        <link href="/blog/css/base.css" rel="stylesheet">
        <link href="//netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.css" rel="stylesheet">
        <link href='http://fonts.googleapis.com/css?family=Droid+Sans' rel='stylesheet' type='text/css'>
		<link href='/blog/css/octicons.min.css' rel='stylesheet' type='text/css'>

        <!-- HTML5 shim, for IE6-8 support of HTML5 elements -->
        <!--[if lt IE 9]>
              <script src="/blog/js/html5shiv.js"></script>
        <![endif]-->

        <!-- Fav and touch icons -->
        <!--
        <link rel="apple-touch-icon-precomposed" sizes="144x144" href="../assets/ico/apple-touch-icon-144-precomposed.png" />
        <link rel="apple-touch-icon-precomposed" sizes="114x114" href="../assets/ico/apple-touch-icon-114-precomposed.png" />
        <link rel="apple-touch-icon-precomposed" sizes="72x72" href="../assets/ico/apple-touch-icon-72-precomposed.png" />
        <link rel="apple-touch-icon-precomposed" href="../assets/ico/apple-touch-icon-57-precomposed.png" />
        -->
        <link rel="shortcut icon" href="/blog/favicon.ico" />
    </head>
    <body>
        <div id="wrap">
            <!-- Fixed navbar -->
            <div class="navbar navbar-default navbar-fixed-top" role="navigation">
                <div class="container">
                    <div class="navbar-header">
                        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                            <span class="icon-bar"></span>
                            <span class="icon-bar"></span>
                            <span class="icon-bar"></span>
                        </button>
                        <a class="navbar-brand" href="/blog/index.html">Jonathan Pearlin's Blog</a>
                    </div>
                    <div class="navbar-collapse collapse">
                        <ul class="nav navbar-nav">
                            <li><a href="/blog/about.html">About</a></li>
                            <li><a href="/blog/resume.html">Résumé</a></li>
                            <li><a href="/blog/friends.html">Friends</a></li>
                            <li class="dropdown">
                                <a data-toggle="dropdown" href="#">Tags<b class="caret"></b></a>
                                <ul class="dropdown-menu" role="menu">
                                    <li><a href="/blog/tags/gradle.html">Gradle</a></li>
                                    <li><a href="/blog/tags/grails.html">Grails</a></li>
                                    <li><a href="/blog/tags/groovy.html">Groovy</a></li>
                                    <li><a href="/blog/tags/java.html">Java</a></li>
                                    <li><a href="/blog/tags/maven.html">Maven</a></li>
                                    <li><a href="/blog/tags/spring.html">Spring</a></li>
                                    <li><a href="/blog/tags/zookeeper.html">ZooKeeper</a></li>
                                </ul>
                            </li>
                            <li><a href="/blog/feed.xml">Feed</a></li>
                        </ul>
                        <ul class="nav navbar-nav navbar-right">
                            <li><a href="https://github.com/jdpgrailsdev" target="_blank"><i class="fa fa-github"></i></a></li>
                            <li><a href="http://www.linkedin.com/pub/jonathan-pearlin/4/946/9a0" style="text-decoration:none;" target="_blank"><i class="fa fa-linkedin-square"></i></a></li>
                        </ul>
                    </div>
                </div>
            </div>
			<div id="activity" class="pull-left">
	            <div class="panel panel-primary">
	                  <!-- Default panel contents -->
	                  <div class="panel-heading"><a target="_blank" href="http://github.com/jdpgrailsdev?tab=activity"><i class="fa fa-github"></i> My Recent GitHub Activity</a></div>
					  <div class="panel-body">
					      <i class='icon-spinner icon-spin icon-large'></i> Loading...
					  </div>
	                  <!-- List group -->
                      <ul class="list-group">
	                  </ul>
	            </div>
			</div>
            <div class="container">
    <div class="page-header">
        <h1>Programmatically building CKEditor source in Grails</h1>
    </div>

    <p><em>25 February 2014</em></p>

    <div class="g-plusone" data-size="medium" data-href="http://jdpgrailsdev.github.io/blog/2014/02/25/grails_gant_ckeditor.html"></div>
    <script type="IN/Share" data-url="http://jdpgrailsdev.github.io/blog/2014/02/25/grails_gant_ckeditor.html" data-counter="right"></script>
    <div class="fb-like" data-href="http://jdpgrailsdev.github.io/blog/2014/02/25/grails_gant_ckeditor.html" data-layout="button_count" data-action="like" data-show-faces="false" data-share="true"></div>

    <p><div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>The <a href="http://grails.org" target="_blank">Grails</a> Framework has some interesting quirks, particular when it comes to dependency management and build/deploy.  With a <a href="http://grails.org" target="_blank">Grails</a> plugin, you can define dependencies in its <code>BuildConfig.groovy</code> source file or you can place Java JAR files in the <code>lib</code>
directory of the plugin.  Either will get included in the packaged plugin (and by extension, the packaged WAR of the application that includes the plugin) unless other special steps are taken to preclude them at package time.  This became an issue for me
recently when using the builder provided by <a href="http://ckeditor.com/" target="_blank">CKEditor</a> within a <a href="http://grails.org" target="_blank">Grails</a> plugin to compile from source the <a href="http://ckeditor.com/" target="_blank">CKEditor</a> JavaScript files.  We had originally put the <a href="http://ckeditor.com/" target="_blank">CKEditor</a> builder JAR in the <code>lib</code> folder of a plugin, as the <a href="http://ckeditor.com/" target="_blank">CKEditor</a> project does not
publish its artifacts to <a href="http://maven.apache.org/" target="_blank">Maven</a>.  This worked fine until we happened to update the version of <a href="http://code.google.com/p/guava-libraries/" target="_blank">Guava</a> that the plugin depended on.  The net result of this was a fun game of classpath roulette, as the builder JAR provided by <a href="http://ckeditor.com/" target="_blank">CKEditor</a> includes copies of
an older version of <a href="http://code.google.com/p/guava-libraries/" target="_blank">Guava</a> inside its JAR (don&#8217;t get me started on this).  I was able to determine this by using JBoss&#8217;s <a href="http://www.jboss.org/tattletale" target="_blank">Tattletale</a> library to check for duplicate classes on the classpath (In a future post,
I will talk about how I added JBoss&#8217;s <a href="http://www.jboss.org/tattletale" target="_blank">Tattletale</a> to our <a href="http://grails.org" target="_blank">Grails</a> builds to check for duplicate classes on the classpath, though it less important in <a href="http://grails.org" target="_blank">Grails</a> 2.3+, where you can use <a href="http://maven.apache.org/" target="_blank">Maven</a> POM files and the
enforcer plugin to do the same thing).  Because we had the JAR in the <code>lib</code> directory, it gets included on the classpath and packaged in the WAR, but does not get conflict resolved with any dependencies included in the <code>BuildConfig.groovy</code> file.  Obviously,
<a href="https://ant.apache.org/ivy/" target="_blank">Ivy</a> only knows about the dependencies declared in the closures in <code>BuildConfig.groovy</code>.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_build_scope_to_the_rescue">Build Scope to the rescue</h3>
<div class="paragraph">
<p>I decided that the best way to fix this was to make use of the <code>build</code> dependency scope supported by <a href="http://grails.org" target="_blank">Grails</a>/https://ant.apache.org/ivy/[Ivy, window="_blank"], which does not allow the dependency to be included in the packaged artifact.  This first meant pushing
the <a href="http://ckeditor.com/" target="_blank">CKEditor</a> builder JAR file into our <a href="http://maven.apache.org/" target="_blank">Maven</a> repository and then adding the following to the <code>dependencies</code> block in <code>BuildConfig.groovy</code>:</p>
</div>
<div class="listingblock">
<div class="title">BuildConfig.groovy</div>
<div class="content">
<pre class="prettyprint groovy language-groovy"><code>grails.project.dependency.resolution = {

    ...

    dependencies {
        // Required to build/package ckeditor
        build 'com.ckeditor:ckbuilder:1.6.1'

        ...
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The next step was to modify the <a href="http://gant.codehaus.org/" target="_blank">Gant</a> script that we wrote to perform the <a href="http://ckeditor.com/" target="_blank">CKEditor</a> compilation to programmatically invoke the <a href="http://ckeditor.com/" target="_blank">CKEditor</a> builder instead of executing a command:</p>
</div>
<div class="listingblock">
<div class="title">scripts/PackageCkeditor.groovy</div>
<div class="content">
<pre class="prettyprint groovy language-groovy"><code>import ckbuilder.ckbuilder

target(packageCkeditor: "Packages the CKEditor for inclusion as a dependency.") {
    String srcPath  = 'web-app/js/ckeditor-source'
    String destPath = 'web-app/js/ckeditor'
    String version  = '4.0.0'

    grailsConsole.addStatus "Compiling CKEditor from source..."
    ckbuilder.main(["--build", "${myPluginDir}/${srcPath}/", "${myPluginDir}/${destPath}", "--version=${version}",
            "--build-config", "${myPluginDir}/${srcPath}/dev/builder/ddc-build-config.js", "--overwrite", "--skip-omitted-in-build-config"] as String[])

    grailsConsole.updateStatus "Moving compiled CKEditor to target directory..."
    ant.move(file: "${myPluginDir}/${destPath}/ckeditor",
             tofile: "${myPluginDir}/${destPath}",
             overwrite: true)

    grailsConsole.updateStatus "Removing CKEditor archive artifacts..."
    ant.delete(file: "${myPluginDir}/${destPath}/ckeditor_${version.toLowerCase()}.zip")
    ant.delete(file: "${myPluginDir}/${destPath}/ckeditor_${version.toLowerCase()}.tar.gz")

    grailsConsole.updateStatus "CKEditor successfully compiled and ready to deploy."
}

setDefaultTarget(packageCkeditor)</code></pre>
</div>
</div>
<div class="paragraph">
<p>The example above makes use of the <code>main()</code> method of the <code>ckeditor</code> class provided by the builder to invoke the <a href="http://ckeditor.com/" target="_blank">CKEditor</a> compilation.  I tested it out and noticed that
none of my console statements after the call to <code>main()</code> were being executed.  I quickly realized that something in the <a href="http://ckeditor.com/" target="_blank">CKEditor</a> code was executing <code>System.exit()</code>, which in turn
ended up killing the <a href="http://grails.org" target="_blank">Grails</a> process.</p>
</div>
</div>
<div class="sect2">
<h3 id="_open_only_in_case_of_emergency">Open only in case of emergency</h3>
<div class="paragraph">
<p>To avoid this premature exit, I decided to add a temporary custom <code>SecurityManager</code> that does not allow exits to happen:</p>
</div>
<div class="listingblock">
<div class="title">scripts/PackageCkeditor.groovy</div>
<div class="content">
<pre class="prettyprint groovy language-groovy"><code>import ckbuilder.ckbuilder

target(packageCkeditor: "Packages the CKEditor for inclusion as a dependency.") {
    String srcPath  = 'web-app/js/ckeditor-source'
    String destPath = 'web-app/js/ckeditor'
    String version  = '4.0.0'

    grailsConsole.addStatus "Compiling CKEditor from source..."

    /*
     * The CKEditor builder calls System.exit().  Therefore,
     * we need a custom security manager to prevent it from
     * killing the Grails process too.  The code below
     * saves off the current security manager, sets the JVM
     * to use the custom no-exits-allowed manager and then
     * restores it after attempting to build CKEditor.
     */
    def defaultSecurityManager = System.getSecurityManager()
    System.setSecurityManager(new NoExitSecurityManager())

    try {
        ckbuilder.main(["--build", "${myPluginDir}/${srcPath}/", "${myPluginDir}/${destPath}", "--version=${version}",
            "--build-config", "${myPluginDir}/${srcPath}/dev/builder/ddc-build-config.js", "--overwrite", "--skip-omitted-in-build-config"] as String[])
    } catch (e) {
        if(!(e instanceof SecurityException)) {
            grailsConsole.addStatus("Failed to execute CKEditor build: ${e.getMessage()}")
        }
    } finally {
        // Restore the security manager
        System.setSecurityManager(defaultSecurityManager)
    }

    grailsConsole.updateStatus "Moving compiled CKEditor to target directory..."
    ant.move(file: "${myPluginDir}/${destPath}/ckeditor",
             tofile: "${myPluginDir}/${destPath}",
             overwrite: true)

    grailsConsole.updateStatus "Removing CKEditor archive artifacts..."
    ant.delete(file: "${myPluginDir}/${destPath}/ckeditor_${version.toLowerCase()}.zip")
    ant.delete(file: "${myPluginDir}/${destPath}/ckeditor_${version.toLowerCase()}.tar.gz")

    grailsConsole.updateStatus "CKEditor successfully compiled and ready to deploy."
}

setDefaultTarget(packageCkeditor)

/**
 * Custom "no exits allowed" security manager implementation.
 */
class NoExitSecurityManager extends SecurityManager {

    @Override
    public void checkExit(int status) {
        throw new SecurityException('Exit not allowed.')
    }

    @Override
    public void checkPermission(Permission perm) {
        // Allow all!
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The revamped code above now uses a custom <code>SecurityManager</code> that does not allow the exit to happen.  While this is not the cleanest approach (I would have liked to have modified the <a href="http://ckeditor.com/" target="_blank">CKEditor</a>
builder code, but they have not open sourced the builder&#8201;&#8212;&#8201;only the editor itself), it gets the job done.  Now, we can use the <a href="http://ckeditor.com/" target="_blank">CKEditor</a> programmatically and let <a href="https://ant.apache.org/ivy/" target="_blank">Ivy</a> manage the dependency
the dependency, ensure that it does not get included in the packaged artifact and still be able to compile the source as part of our builds.</p>
</div>
</div></p>

    <div class="g-plusone" data-size="medium" data-href="http://jdpgrailsdev.github.io/blog/blog2014/02/25/grails_gant_ckeditor.html"></div>
    <script type="IN/Share" data-url="http://jdpgrailsdev.github.io/blog/2014/02/25/grails_gant_ckeditor.html" data-counter="right"></script>
    <div class="fb-like" data-href="http://jdpgrailsdev.github.io/blog/2014/02/25/grails_gant_ckeditor.html" data-layout="button_count" data-action="like" data-show-faces="false" data-share="true"></div>

    <div id="disqus_thread"></div>
    <script type="text/javascript">
        var disqus_shortname = 'jdpgrailsdevblog';
        var disqus_identifier = '2014/02/25/grails_gant_ckeditor.html';
        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

    <hr>

            </div>
            <div id="push"></div>
        </div>

        <div id="footer">
              <div class="container">
                <p class="muted credit">&copy; 2014 | Mixed with <a href="http://getbootstrap.com/">Bootstrap v3.1.1</a> | Baked with <a href="http://jbake.org">JBake v2.3.0</a> | Comments powered by <a href="http://disqus.com">Disqus</a></p>
              </div>
        </div>

        <!-- Le javascript
        ================================================== -->
        <!-- Placed at the end of the document so the pages load faster -->
        <script src="https://code.jquery.com/jquery.js" type="text/javascript"></script>
        <script src="//netdna.bootstrapcdn.com/bootstrap/3.1.1/js/bootstrap.min.js" type="text/javascript"></script>
        <script src="/blog/js/run_prettify.js" type="text/javascript"></script>
        <script src="/blog/js/github_activity.js" type="text/javascript"></script>
        <script type="text/javascript">
            /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
            var disqus_shortname = 'jdpearlin'; // required: replace example with your forum shortname

            /* * * DON'T EDIT BELOW THIS LINE * * */
            (function() {
                var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
                dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
                (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
            })();
        </script>
        <script type="text/javascript">
              window.___gcfg = {lang: 'en'};

              (function() {
                var po = document.createElement('script'); po.type = 'text/javascript'; po.async = true;
                po.src = 'https://apis.google.com/js/plusone.js';
                var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(po, s);
              })();
        </script>
        <script type="text/javascript">
            (function(d, s, id) {
                  var js, fjs = d.getElementsByTagName(s)[0];
                  if (d.getElementById(id)) return;
                  js = d.createElement(s); js.id = id;
                  js.src = "//connect.facebook.net/en_US/all.js#xfbml=1";
                  fjs.parentNode.insertBefore(js, fjs);
            }(document, 'script', 'facebook-jssdk'));
        </script>
        <script src="//platform.linkedin.com/in.js" type="text/javascript"></script>
        <script type="text/javascript">
          (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
          (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
          m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
          })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

          ga('create', 'UA-47885115-1', 'jdpgrailsdev.github.io');
          ga('send', 'pageview');
        </script>
    </body>
</html>
<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8"/>
        <title>The Flowers Are Still Standing</title>
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <meta name="description" content="" />
        <meta name="author" content="Jonathan Pearlin" />
        <meta name="keywords" content="" />
        <meta name="generator" content="JBake" />

        <!-- Le styles -->
        <link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css">
        <link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap-theme.min.css">
        <link href="/blog/css/asciidoctor.css" rel="stylesheet">
        <link href="/blog/css/base.css" rel="stylesheet">
        <link href="//netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.css" rel="stylesheet">
        <link href='http://fonts.googleapis.com/css?family=Droid+Sans' rel='stylesheet' type='text/css'>
        <link href='/blog/css/octicons.min.css' rel='stylesheet' type='text/css'>

        <!-- HTML5 shim, for IE6-8 support of HTML5 elements -->
        <!--[if lt IE 9]>
              <script src="/blog/js/html5shiv.js"></script>
        <![endif]-->

        <!-- Fav and touch icons -->
        <!--
        <link rel="apple-touch-icon-precomposed" sizes="144x144" href="../assets/ico/apple-touch-icon-144-precomposed.png" />
        <link rel="apple-touch-icon-precomposed" sizes="114x114" href="../assets/ico/apple-touch-icon-114-precomposed.png" />
        <link rel="apple-touch-icon-precomposed" sizes="72x72" href="../assets/ico/apple-touch-icon-72-precomposed.png" />
        <link rel="apple-touch-icon-precomposed" href="../assets/ico/apple-touch-icon-57-precomposed.png" />
        -->
        <link rel="shortcut icon" href="/blog/favicon.ico" />
    </head>
    <body>
        <div id="wrap">
            <!-- Fixed navbar -->
            <div class="navbar navbar-default navbar-fixed-top" role="navigation">
            <a href="https://github.com/jdpgrailsdev" target="_blank"><img style="position: absolute; top: 0; right: 0; border: 0;" src="https://camo.githubusercontent.com/a6677b08c955af8400f44c6298f40e7d19cc5b2d/68747470733a2f2f73332e616d617a6f6e6177732e636f6d2f6769746875622f726962626f6e732f666f726b6d655f72696768745f677261795f3664366436642e706e67" alt="Fork me on GitHub" data-canonical-src="https://s3.amazonaws.com/github/ribbons/forkme_right_gray_6d6d6d.png"></a>
                <div class="container">
                    <div class="navbar-header">
                        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                            <span class="icon-bar"></span>
                            <span class="icon-bar"></span>
                            <span class="icon-bar"></span>
                        </button>
                        <a class="navbar-brand" href="/blog/index.html">Jonathan Pearlin's Blog</a>
                    </div>
                    <div class="navbar-collapse collapse">
                        <ul class="nav navbar-nav">
                            <li><a href="/blog/about.html">About</a></li>
                            <li><a href="/blog/resume.html">Résumé</a></li>
                            <li><a href="/blog/friends.html">Friends</a></li>
                            <li class="dropdown">
                                <a data-toggle="dropdown" href="#">Tags<b class="caret"></b></a>
                                <ul class="dropdown-menu" role="menu">
                                    <li><a href="/blog/tags/docker.html">Docker</a></li>
                                    <li><a href="/blog/tags/gradle.html">Gradle</a></li>
                                    <li><a href="/blog/tags/grails.html">Grails</a></li>
                                    <li><a href="/blog/tags/groovy.html">Groovy</a></li>
                                    <li><a href="/blog/tags/java.html">Java</a></li>
                                    <li><a href="/blog/tags/maven.html">Maven</a></li>
                                    <li><a href="/blog/tags/spring.html">Spring</a></li>
                                    <li><a href="/blog/tags/zookeeper.html">ZooKeeper</a></li>
                                </ul>
                            </li>
                            <li><a href="/blog/feed.xml">Feed</a></li>
                        </ul>
                        <ul class="nav navbar-nav navbar-right">
                            <li><a href="https://github.com/jdpgrailsdev" target="_blank"><i class="fa fa-github"></i></a></li>
                            <li><a href="http://www.linkedin.com/pub/jonathan-pearlin/4/946/9a0" style="text-decoration:none;" target="_blank"><i class="fa fa-linkedin-square"></i></a></li>
                        </ul>
                    </div>
                </div>
            </div>
            <div id="activity" class="pull-left">
                <div class="panel panel-primary">
                      <!-- Default panel contents -->
                      <div class="panel-heading"><a target="_blank" href="http://github.com/jdpgrailsdev?tab=activity"><i class="fa fa-github"></i> My Recent GitHub Activity</a></div>
                      <div class="panel-body">
                          <i class='icon-spinner icon-spin icon-large'></i> Loading...
                      </div>
                      <!-- List group -->
                      <ul class="list-group">
                      </ul>
                </div>
            </div>
            <div class="container">
    <div class="page-header">
        <h1>Use Spring to Autodetect and Load JRuby Gem Dependencies</h1>
    </div>

    <p><em>23 September 2014</em></p>

    <div class="g-plusone" data-size="medium" data-href="http://jdpgrailsdev.github.io/blog/2014/09/23/spring_jruby_autodetect_deps.html"></div>
    <script type="IN/Share" data-url="http://jdpgrailsdev.github.io/blog/2014/09/23/spring_jruby_autodetect_deps.html" data-counter="right"></script>
    <div class="fb-like" data-href="http://jdpgrailsdev.github.io/blog/2014/09/23/spring_jruby_autodetect_deps.html" data-layout="button_count" data-action="like" data-show-faces="false" data-share="true"></div>

    <p><div class="paragraph">
<p>I decided recently to try to use <a href="http://jruby.org/" target="_blank">JRuby</a> to help me use Ruby-based libraries as plugins in a Java application.  This is pretty easy to do if your Ruby code makes use
of the stock modules included in <a href="http://jruby.org/" target="_blank">JRuby</a>.  However, what happens if the Ruby scripts need to access other libraries that typically would be found in external
<a href="https://rubygems.org/" target="_blank">Ruby Gems</a>?  One answer is to use <a href="http://gradle.org" target="_blank">Gradle</a>, <a href="http://jruby.org/" target="_blank">JRuby</a> and the <a href="http://spring.io" target="_blank">Spring Framework</a> to automatically download, package and discover these dependencies at build and runtime.
Another way to put it is that we have three distinct operations that we need to perform in order to get all of this playing nicely together:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Use <a href="http://bundler.io/" target="_blank">Bundler</a> to find, download and install all required Ruby modules at build time (<a href="http://gradle.org" target="_blank">Gradle</a> + <a href="http://jruby.org/" target="_blank">JRuby</a>)</p>
</li>
<li>
<p>Package Ruby modules with Ruby script(s) in JAR file (<a href="http://gradle.org" target="_blank">Gradle</a>)</p>
</li>
<li>
<p>Auto-discover packaged Ruby modules at runtime and add them to the "load path" of the script that is to be executed (<a href="http://jruby.org/" target="_blank">JRuby</a> + <a href="http://spring.io" target="_blank">Spring Framework</a>)</p>
</li>
<li>
<p>Execute the script (<a href="http://jruby.org/" target="_blank">JRuby</a>)</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Let&#8217;s start with the first task:  Use <a href="http://bundler.io/" target="_blank">Bundler</a> to find, download and install all required Ruby modules at build time.  To accomplish this, I decided to
use custom tasks in a <a href="http://gradle.org" target="_blank">Gradle</a> script to first install <a href="http://bundler.io/" target="_blank">Bundler</a> and then use <a href="http://bundler.io/" target="_blank">Bundler</a> to install any required Ruby modules found in the project&#8217;s <code>Gemfile</code>.
This <a href="http://gradle.org" target="_blank">Gradle</a> script also needed to be able to copy the installed <a href="https://rubygems.org/" target="_blank">Ruby Gems</a> to a directory that would ensure their inclusion in the packaged JAR file.  Below
is the script:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">import groovy.util.AntBuilder

buildscript {
    dependencies {
        classpath 'org.jruby:jruby-complete:1.7.13'
    }
}

jar {
    from ("${project.projectDir}/src/main/ruby")
}

dependencies {
    runtime project(':shared')
}

sourceSets {
    main {
       java {
          srcDir file("${project.projectDir}/src/main/ruby")
       }
    }
}

/*
 * Installs Bundler to the project's build directory.  Bundler is used to
 * install any Gems required by this plugin.
 */
task installBundler(type:JavaExec, description:'Installs Bundler') {
    args = "--2.0 -S gem install -i ${project.buildDir}/bundler --no-rdoc --no-ri bundler".tokenize()
    classpath = project.buildscript.configurations.classpath
    jvmArgs("-Xmx800M")
    main = 'org.jruby.Main'
    environment = [HOME:System.getProperty('user.home'),
                    PATH:['/usr/local/bin', '/usr/bin','/bin','/usr/sbin','/sbin'].join(File.pathSeparator)]
    workingDir = project.projectDir
}

/*
 * Installs the Gems required by this plugin to the project's build directory.
 * This task uses Bundler to perform the Gem installations.
 */
task installGems(type:JavaExec, description:'Installs all required Gems via Bundle.', dependsOn:'installBundler') {
    args = "--2.0 -S bundle install --path ${project.buildDir}".tokenize()
    classpath = project.buildscript.configurations.classpath
    main = 'org.jruby.Main'
    environment = [GEM_PATH: "${project.buildDir}/bundler",
                    HOME:System.getProperty('user.home'),
                    PATH:["${project.buildDir}/bundler/bin", '/usr/local/bin', '/usr/bin','/bin','/usr/sbin','/sbin'].join(File.pathSeparator)]
    workingDir = project.projectDir
}

/*
 * Moves the installed Gem files from the project's build directory to src/main/resources
 * so that they will be included in the packaged JAR.
 */
task packageGems(dependsOn:'installGems') {
    doLast {
        Properties props = new Properties()
        props.load(new File("${project.projectDir}/src/main/resources/META-INF/notification/${project.name}.plugin").newDataInputStream())
        File parent = new File("${project.projectDir}/src/main/resources/${props.getProperty('plugin-name')}/gems")
        parent.deleteDir()
        parent.mkdirs()

        // Normalize each installed gem directory name and move it to src/main/resources
        new File("${project.buildDir}/jruby/1.9/gems").listFiles().each { file -&gt;
            processSourceFiles(parent, new File(file, 'lib'))
            File vendorGems = new File(file, 'vendor/gems')
            if(vendorGems.exists()) {
                vendorGems.listFiles().each { vendorFile -&gt;
                    processSourceFiles(parent, new File(vendorFile, 'lib'))
                }
            }
        }
    }
}

project.tasks.installGems.inputs.file("${project.projectDir}/Gemfile")
project.tasks.installGems.outputs.dir("${project.buildDir}/jruby")
project.tasks.installBundler.outputs.upToDateWhen { new File("${project.buildDir}/bundler").exists() }
project.tasks.jar.dependsOn(['packageGems'])

def processSourceFiles(File newParent, File rootDir) {
    File newRootDir = new File(newParent, rootDir.getParentFile().getName())
    new AntBuilder().copy(todir : newRootDir.getAbsolutePath(), quiet:true) {
        fileset(dir: rootDir.getAbsolutePath())
    }
    newRootDir.eachFileRecurse { rubyFile -&gt;
        if(rubyFile.isFile() &amp;&amp; rubyFile.text.contains('require_relative')) {
            def builder = new StringBuilder()
            rubyFile.eachLine { line -&gt;
                line = line.replaceAll('require_relative\\s+\'\\.\\/(.+)\'', 'require_relative \'$1\'')
                def matcher = line =~ /require_relative\s+'((\.\.\/)+).+'/
                if(matcher.find()) {
                    def numberOfParentDirs = matcher[0][1].split('/').length
                    def actualParent = rubyFile.getParentFile()
                    numberOfParentDirs.times { actualParent = actualParent.getParentFile() }
                    actualParent = actualParent.getAbsolutePath().minus("${newRootDir.getAbsolutePath()}/")
                    line = line.replaceAll('require_relative\\s+\'(?:\\.\\.\\/)+(.+)\'', "require '${actualParent ? "${actualParent}/" : actualParent}\$1'")
                }
                builder.append(line.trim())
                builder.append('\n')
            }
            rubyFile.write(builder.toString())
        }
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>A couple of things to point out.  First, the script uses <a href="http://jruby.org/" target="_blank">JRuby</a> in custom <a href="http://gradle.org" target="_blank">Gradle</a> tasks to execute the Ruby-based commands.  Second, the script recursively
walks through each of the installed <a href="https://rubygems.org/" target="_blank">Ruby Gems</a> to properly normalize any <code>require_relative</code> statements into absolute paths.  This is necessary as <a href="http://jruby.org/" target="_blank">JRuby</a> does
not handle relative paths in included <a href="https://rubygems.org/" target="_blank">Ruby Gems</a> very well (or at all).</p>
</div>
<div class="paragraph">
<p>At this point, running <code>./gradlew build</code> on this project will produce a JAR file containing any Ruby scripts found in <code>src/main/ruby</code>, as well as any required
<a href="https://rubygems.org/" target="_blank">Ruby Gems</a> installed by the script.  The next step to use a Ruby-based plugin in a Java application is to use <a href="http://jruby.org/" target="_blank">JRuby</a> to execute the script.  I&#8217;m not going
to go into all of the details about wiring that up, as the <a href="http://jruby.org/" target="_blank">JRuby</a> tutorials cover this pretty well.  Instead, I am going to focus on how to extract the
required <a href="https://rubygems.org/" target="_blank">Ruby Gems</a> that we included in the JAR and make sure that they are available to our Ruby script(s) when <a href="http://jruby.org/" target="_blank">JRuby</a> executes them.  To accomplish this,
I decided to make use of the <a href="http://spring.io" target="_blank">Spring Framework</a>'s <code>PathMatchingResourcePatternResolver</code> to auto-discover the included <a href="https://rubygems.org/" target="_blank">Ruby Gems</a> and add them to <a href="http://jruby.org/" target="_blank">JRuby</a>'s load path:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">import java.util.HashSet;
import java.util.Set;
import java.util.regex.Matcher;
import java.util.regex.Pattern;


import org.jruby.embed.ScriptingContainer;
import org.springframework.core.io.Resource;
import org.springframework.core.io.support.PathMatchingResourcePatternResolver;

...

final String pluginName = "test-plugin";

final PathMatchingResourcePatternResolver patternResolver = new PathMatchingResourcePatternResolver();

final Resource[] dependencyGemResources  = patternResolver.getResources(String.format("classpath*:/%s/gems/**/*.rb", pluginName));

final Pattern dependencyGemPattern = Pattern.compile(String.format("^classpath:\\/%s\\/gems\\/([a-zA-Z\\-\\.0-9_]+)/.*$", pluginName));

final ScriptingContainer container = new ScriptingContainer();

final Set&lt;String&gt; loadPaths = new HashSet&lt;String&gt;();

// Add the JRuby-provided Ruby 2.0 modules to the load path
loadPaths.add("classpath:/META-INF/jruby.home/lib/ruby/2.0");

// Add any required dependency Gems for this plugin to the load path.
for(final Resource resource : dependencyGemResources) {
    final Matcher matcher = dependencyGemPattern.matcher(resource.getURI().toString().replaceAll("^jar:file:\\/.*\\.jar!(.*)$", "classpath:$1"));
    if(matcher.find()) {
        final String resourceName = String.format("classpath:/%s/gems/%s", pluginName, matcher.group(1));
        if(!loadPaths.contains(resourceName)) {
            loadPaths.add(resourceName);
        }
    }
}

container.setLoadPaths(loadPaths);</code></pre>
</div>
</div>
<div class="paragraph">
<p>The snippet of Java code above makes use of the <code>PathMatchingResourcePatternResolver</code> from the <a href="http://spring.io" target="_blank">Spring Framework</a> to scan the classpath and find all <code>.rb</code> files under the
<code>/&lt;plugin name&gt;/gems</code> path.  From this list, the URI of each (which is relative to the JAR file) is converted into a classpath-friendly string that <a href="http://jruby.org/" target="_blank">JRuby</a>
understands and then added to the list of paths for <a href="http://jruby.org/" target="_blank">JRuby</a> to load prior to execution of the script.  At this point, if a Ruby script is executed via the
<code>ScriptingContainer</code> with the properly configured load paths, any references to required modules that are packaged in the plugin&#8217;s JAR file will be found and
the script will execute just as if it were run via Ruby.</p>
</div></p>

    <div class="g-plusone" data-size="medium" data-href="http://jdpgrailsdev.github.io/blog/blog2014/09/23/spring_jruby_autodetect_deps.html"></div>
    <script type="IN/Share" data-url="http://jdpgrailsdev.github.io/blog/2014/09/23/spring_jruby_autodetect_deps.html" data-counter="right"></script>
    <div class="fb-like" data-href="http://jdpgrailsdev.github.io/blog/2014/09/23/spring_jruby_autodetect_deps.html" data-layout="button_count" data-action="like" data-show-faces="false" data-share="true"></div>

    <div id="disqus_thread"></div>
    <script type="text/javascript">
        var disqus_shortname = 'jdpgrailsdevblog';
        var disqus_identifier = '2014/09/23/spring_jruby_autodetect_deps.html';
        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

    <hr>

            </div>
            <div id="push"></div>
        </div>

        <div id="footer">
              <div class="container">
                <p class="muted credit">&copy; 2014 | Mixed with <a href="http://getbootstrap.com/">Bootstrap v3.1.1</a> | Baked with <a href="http://jbake.org">JBake v2.3.2</a> | Comments powered by <a href="http://disqus.com">Disqus</a></p>
              </div>
        </div>

        <!-- Le javascript
        ================================================== -->
        <!-- Placed at the end of the document so the pages load faster -->
        <script src="https://code.jquery.com/jquery.js" type="text/javascript"></script>
        <script src="//netdna.bootstrapcdn.com/bootstrap/3.1.1/js/bootstrap.min.js" type="text/javascript"></script>
        <script src="/blog/js/run_prettify.js" type="text/javascript"></script>
        <script src="/blog/js/github_activity.js" type="text/javascript"></script>
        <script type="text/javascript">
            /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
            var disqus_shortname = 'jdpearlin'; // required: replace example with your forum shortname

            /* * * DON'T EDIT BELOW THIS LINE * * */
            (function() {
                var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
                dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
                (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
            })();
        </script>
        <script type="text/javascript">
              window.___gcfg = {lang: 'en'};

              (function() {
                var po = document.createElement('script'); po.type = 'text/javascript'; po.async = true;
                po.src = 'https://apis.google.com/js/plusone.js';
                var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(po, s);
              })();
        </script>
        <script type="text/javascript">
            (function(d, s, id) {
                  var js, fjs = d.getElementsByTagName(s)[0];
                  if (d.getElementById(id)) return;
                  js = d.createElement(s); js.id = id;
                  js.src = "//connect.facebook.net/en_US/all.js#xfbml=1";
                  fjs.parentNode.insertBefore(js, fjs);
            }(document, 'script', 'facebook-jssdk'));
        </script>
        <script src="//platform.linkedin.com/in.js" type="text/javascript"></script>
        <script type="text/javascript">
          (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
          (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
          m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
          })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

          ga('create', 'UA-47885115-1', 'jdpgrailsdev.github.io');
          ga('send', 'pageview');
        </script>
    </body>
</html>
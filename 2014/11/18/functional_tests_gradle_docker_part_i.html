<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8"/>
        <title>The Flowers Are Still Standing</title>
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <meta name="description" content="" />
        <meta name="author" content="Jonathan Pearlin" />
        <meta name="keywords" content="" />
        <meta name="generator" content="JBake" />

        <!-- Le styles -->
        <link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css">
        <link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap-theme.min.css">
        <link href="/blog/css/asciidoctor.css" rel="stylesheet">
        <link href="/blog/css/base.css" rel="stylesheet">
        <link href="//netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.css" rel="stylesheet">
        <link href='http://fonts.googleapis.com/css?family=Droid+Sans' rel='stylesheet' type='text/css'>
        <link href='/blog/css/octicons.min.css' rel='stylesheet' type='text/css'>

        <!-- HTML5 shim, for IE6-8 support of HTML5 elements -->
        <!--[if lt IE 9]>
              <script src="/blog/js/html5shiv.js"></script>
        <![endif]-->

        <!-- Fav and touch icons -->
        <!--
        <link rel="apple-touch-icon-precomposed" sizes="144x144" href="../assets/ico/apple-touch-icon-144-precomposed.png" />
        <link rel="apple-touch-icon-precomposed" sizes="114x114" href="../assets/ico/apple-touch-icon-114-precomposed.png" />
        <link rel="apple-touch-icon-precomposed" sizes="72x72" href="../assets/ico/apple-touch-icon-72-precomposed.png" />
        <link rel="apple-touch-icon-precomposed" href="../assets/ico/apple-touch-icon-57-precomposed.png" />
        -->
        <link rel="shortcut icon" href="/blog/favicon.ico" />
    </head>
    <body>
        <div id="wrap">
            <!-- Fixed navbar -->
            <div class="navbar navbar-default navbar-fixed-top" role="navigation">
            <a href="https://github.com/jdpgrailsdev" target="_blank"><img style="position: absolute; top: 0; right: 0; border: 0;" src="https://camo.githubusercontent.com/a6677b08c955af8400f44c6298f40e7d19cc5b2d/68747470733a2f2f73332e616d617a6f6e6177732e636f6d2f6769746875622f726962626f6e732f666f726b6d655f72696768745f677261795f3664366436642e706e67" alt="Fork me on GitHub" data-canonical-src="https://s3.amazonaws.com/github/ribbons/forkme_right_gray_6d6d6d.png"></a>
                <div class="container">
                    <div class="navbar-header">
                        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                            <span class="icon-bar"></span>
                            <span class="icon-bar"></span>
                            <span class="icon-bar"></span>
                        </button>
                        <a class="navbar-brand" href="/blog/index.html">Jonathan Pearlin's Blog</a>
                    </div>
                    <div class="navbar-collapse collapse">
                        <ul class="nav navbar-nav">
                            <li><a href="/blog/about.html">About</a></li>
                            <li><a href="/blog/resume.html">Résumé</a></li>
                            <li><a href="/blog/friends.html">Friends</a></li>
                            <li class="dropdown">
                                <a data-toggle="dropdown" href="#">Tags<b class="caret"></b></a>
                                <ul class="dropdown-menu" role="menu">
                                    <li><a href="/blog/tags/docker.html">Docker</a></li>
                                    <li><a href="/blog/tags/gradle.html">Gradle</a></li>
                                    <li><a href="/blog/tags/grails.html">Grails</a></li>
                                    <li><a href="/blog/tags/groovy.html">Groovy</a></li>
                                    <li><a href="/blog/tags/java.html">Java</a></li>
                                    <li><a href="/blog/tags/maven.html">Maven</a></li>
                                    <li><a href="/blog/tags/spring.html">Spring</a></li>
                                    <li><a href="/blog/tags/zookeeper.html">ZooKeeper</a></li>
                                </ul>
                            </li>
                            <li><a href="/blog/feed.xml">Feed</a></li>
                        </ul>
                        <ul class="nav navbar-nav navbar-right">
                            <li><a href="https://github.com/jdpgrailsdev" target="_blank"><i class="fa fa-github"></i></a></li>
                            <li><a href="http://www.linkedin.com/pub/jonathan-pearlin/4/946/9a0" style="text-decoration:none;" target="_blank"><i class="fa fa-linkedin-square"></i></a></li>
                        </ul>
                    </div>
                </div>
            </div>
            <div id="activity" class="pull-left">
                <div class="panel panel-primary">
                      <!-- Default panel contents -->
                      <div class="panel-heading"><a target="_blank" href="http://github.com/jdpgrailsdev?tab=activity"><i class="fa fa-github"></i> My Recent GitHub Activity</a></div>
                      <div class="panel-body">
                          <i class='icon-spinner icon-spin icon-large'></i> Loading...
                      </div>
                      <!-- List group -->
                      <ul class="list-group">
                      </ul>
                </div>
            </div>
            <div class="container">
    <div class="page-header">
        <h1>Execute Functional Tests in a Docker Container with Gradle (Part 1)</h1>
    </div>

    <p><em>18 November 2014</em></p>

    <div class="g-plusone" data-size="medium" data-href="http://jdpgrailsdev.github.io/blog/2014/11/18/functional_tests_gradle_docker_part_i.html"></div>
    <script type="IN/Share" data-url="http://jdpgrailsdev.github.io/blog/2014/11/18/functional_tests_gradle_docker_part_i.html" data-counter="right"></script>
    <div class="fb-like" data-href="http://jdpgrailsdev.github.io/blog/2014/11/18/functional_tests_gradle_docker_part_i.html" data-layout="button_count" data-action="like" data-show-faces="false" data-share="true"></div>

    <p><div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>One of the applications that I have been working on recently has a lot of complex SQL queries that cannot be tested very well with traditional unit tests.  To fill this gap, we
decided to write a functional test suite that would perform the following steps:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Persist a bunch of data to the table(s) that are used by the query under test to an actual database instance.</p>
</li>
<li>
<p>Execute the query under test against an actual database instance.</p>
</li>
<li>
<p>Verify the expected results.</p>
</li>
<li>
<p>Clean down the table(s) used in the test to avoid pollution against other tests.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The application(s) under test are <a href="http://projects.spring.io/spring-boot/" target="_blank">Spring Boot</a> applications, which make use of <a href="http://projects.spring.io/spring-data-jpa/" target="_blank">Spring Data JPA</a> for the presistence layer.  Below is an example of one of the repositories:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint java language-java"><code>@Repository
public interface BookRepository extends JpaRepository&lt;Book, Long&gt; {

    List&lt;Book&gt; findByIsbn(final String isbn);

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Writing a functional test for just such a repository is pretty easy using <a href="https://code.google.com/p/spock/" target="_blank">Spock</a> and its built-in <a href="https://code.google.com/p/spock/wiki/SpringExtension" target="_blank">Spring extension</a>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint groovy language-groovy"><code>@ActiveProfiles('test')
@ContextConfiguration(classes=[PersistenceConfiguration], loader=SpringApplicationContextLoader)
class BookRepositoryFunctionalSpec extends Specification {

    @Autowired
    private BookRepository boolRepository

    def cleanup() {
        bookRepository.deleteAll()
    }

    def "test that the correct number of books are found when finding books by ISBN"() {
        setup:
            Book book1 = new Book(title:'A Good Book', author:'Some Guy', isbn:'978-3-16-148410-0')
            Book book2 = new Book(title:'A Good Book, Second Edition', author:'Some Guy', isbn:'978-3-16-148410-1')

            bookRepository.saveAndFlush(book1)
            bookRepository.saveAndFlush(book2)
        when:
            def books = bookRepository.findByIsbn('978-3-16-148410-0')
        then:
            books != null
            books.size() == 1
            books.first() == book1
        when:
            books = bookRepository.findByIsbn('unknown')
        then:
            books != null
            books.size() == 0
    }</code></pre>
</div>
</div>
<div class="paragraph">
<p>The example <a href="https://code.google.com/p/spock/" target="_blank">Spock</a> specification above uses the <code>ActiveProfiles</code> and <code>ContextCongifuration</code> annotations to load the Spring configuration for use by the test.  This configuration contains
all of the beans required by <a href="http://projects.spring.io/spring-data-jpa/" target="_blank">Spring Data JPA</a> to connect to the database (data source, entity manager, etc). With the Spring configuration added to the test, we can now make use of Spring
techniques, such as the auto-wiring of dependencies into the specification.  In the example above, we have auto-wired in the <code>BookRepository</code> that defines the query that we want to test.
The next thing to notice is that the test uses the <code>deleteAll</code> method of the repository instance to remove any data in the table mapped by the <code>Book</code> entity after each test in the
specification.  Finally, we have the test itself, which performs the following steps:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Create a couple of <code>Book</code> entities and persist them to the mapped table using the repository.</p>
</li>
<li>
<p>Execute the finder method from the repository and validate the correct results are found.</p>
</li>
<li>
<p>Execute the finder method again, this time with input that should not produce a result to validate what is returned in that scenario.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Note that this could easily be broken up into two tests or refactored to use <a href="https://code.google.com/p/spock/" target="_blank">Spock</a>'s <code>@Unroll</code> annotation.  Now that I was armed with a way to build out functional tests against the actual database
using <a href="http://projects.spring.io/spring-data-jpa/" target="_blank">Spring Data JPA</a> and <a href="https://code.google.com/p/spock/" target="_blank">Spock</a>, I needed a way to execute the tests.  My first thought was to use <a href="http://gradle.org" target="_blank">Gradle</a> to run the tests.  However, due to a limitation of our build infrastructure (our deployment
server does not have access to our artifact repository), <a href="http://gradle.org" target="_blank">Gradle</a> would not be able to run the tests, as the build script would not have access to the dependencies it needs to execute!  In the part two of
this blog post, I will take a look at how I overcame this issue by executing the test suite inside of a <a href="https://www.docker.com/" target="_blank">Docker</a> container using <a href="http://gradle.org" target="_blank">Gradle</a>.</p>
</div>
</div>
</div></p>

    <div class="g-plusone" data-size="medium" data-href="http://jdpgrailsdev.github.io/blog/blog2014/11/18/functional_tests_gradle_docker_part_i.html"></div>
    <script type="IN/Share" data-url="http://jdpgrailsdev.github.io/blog/2014/11/18/functional_tests_gradle_docker_part_i.html" data-counter="right"></script>
    <div class="fb-like" data-href="http://jdpgrailsdev.github.io/blog/2014/11/18/functional_tests_gradle_docker_part_i.html" data-layout="button_count" data-action="like" data-show-faces="false" data-share="true"></div>

    <div id="disqus_thread"></div>
    <script type="text/javascript">
        var disqus_shortname = 'jdpgrailsdevblog';
        var disqus_identifier = '2014/11/18/functional_tests_gradle_docker_part_i.html';
        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

    <hr>

            </div>
            <div id="push"></div>
        </div>

        <div id="footer">
              <div class="container">
                <p class="muted credit">&copy; 2014 | Mixed with <a href="http://getbootstrap.com/">Bootstrap v3.1.1</a> | Baked with <a href="http://jbake.org">JBake v2.3.0</a> | Comments powered by <a href="http://disqus.com">Disqus</a></p>
              </div>
        </div>

        <!-- Le javascript
        ================================================== -->
        <!-- Placed at the end of the document so the pages load faster -->
        <script src="https://code.jquery.com/jquery.js" type="text/javascript"></script>
        <script src="//netdna.bootstrapcdn.com/bootstrap/3.1.1/js/bootstrap.min.js" type="text/javascript"></script>
        <script src="/blog/js/run_prettify.js" type="text/javascript"></script>
        <script src="/blog/js/github_activity.js" type="text/javascript"></script>
        <script type="text/javascript">
            /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
            var disqus_shortname = 'jdpearlin'; // required: replace example with your forum shortname

            /* * * DON'T EDIT BELOW THIS LINE * * */
            (function() {
                var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
                dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
                (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
            })();
        </script>
        <script type="text/javascript">
              window.___gcfg = {lang: 'en'};

              (function() {
                var po = document.createElement('script'); po.type = 'text/javascript'; po.async = true;
                po.src = 'https://apis.google.com/js/plusone.js';
                var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(po, s);
              })();
        </script>
        <script type="text/javascript">
            (function(d, s, id) {
                  var js, fjs = d.getElementsByTagName(s)[0];
                  if (d.getElementById(id)) return;
                  js = d.createElement(s); js.id = id;
                  js.src = "//connect.facebook.net/en_US/all.js#xfbml=1";
                  fjs.parentNode.insertBefore(js, fjs);
            }(document, 'script', 'facebook-jssdk'));
        </script>
        <script src="//platform.linkedin.com/in.js" type="text/javascript"></script>
        <script type="text/javascript">
          (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
          (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
          m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
          })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

          ga('create', 'UA-47885115-1', 'jdpgrailsdev.github.io');
          ga('send', 'pageview');
        </script>
    </body>
</html>
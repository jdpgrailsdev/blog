<?xml version="1.0"?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
    <channel>
        <title>The Flowers Are Still Standing</title>
        <link>http://jdpgrailsdev.github.io/blog/</link>
        <atom:link href="http://jdpgrailsdev.github.io/blog//feed.xml" rel="self" type="application/rss+xml" />
        <description>Jonathan Pearlin's Blog</description>
        <language>en-us</language>
        <pubDate>Tue, 18 Mar 2014 07:35:22 -0400</pubDate>
        <lastBuildDate>Tue, 18 Mar 2014 07:35:22 -0400</lastBuildDate>
        <image>
            <url>http://jdpgrailsdev.github.io/blog//img/robot_devil.png</url>
            <title>Jonathan Pearlin's Blog</title>
            <link>http://jdpgrailsdev.github.io/blog/</link>
        </image>
        <item>
            <title>Parsing the Grails Spring Beans DSL with Groovy</title>
            <link>http://jdpgrailsdev.github.io/blog//2014/03/18/grails_bean_builder.html</link>
            <pubDate>Tue, 18 Mar 2014 00:00:00 -0400</pubDate>
            <guid isPermaLink="false">/2014/03/18/grails_bean_builder.html</guid>
            <description>
                    &lt;div id=&quot;preamble&quot;&gt;
&lt;div class=&quot;sectionbody&quot;&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;As part of a current project, I recently had the need to determine which of my &lt;a href=&quot;http://grails.org&quot;&gt;Grails&lt;/a&gt; applications made use of certain &lt;a href=&quot;http://spring.io&quot;&gt;Spring&lt;/a&gt; beans in order to prepare for a migration.  While it is possible to
use the normal XML-based configuration in a &lt;a href=&quot;http://grails.org&quot;&gt;Grails&lt;/a&gt; application (which in turn would have made parsing the configuration fairly straight forward), &lt;a href=&quot;http://grails.org&quot;&gt;Grails&lt;/a&gt; applications typically make use of the built-in
&lt;a href=&quot;http://grails.org/doc/latest/guide/spring.html#springdslAdditional&quot;&gt;Spring beans DSL&lt;/a&gt; to declare their &lt;a href=&quot;http://spring.io&quot;&gt;Spring&lt;/a&gt; configuration.  However, because the DSL is represented in &lt;a href=&quot;http://groovy.codehaus.org&quot;&gt;Groovy&lt;/a&gt;, it meant that parsing it
would not be as easy as if it were in XML.  I decided the best approach would be to use the &lt;code&gt;grails.spring.BeanBuilder&lt;/code&gt; outside of a &lt;a href=&quot;http://grails.org&quot;&gt;Grails&lt;/a&gt; application in a &lt;a href=&quot;http://groovy.codehaus.org&quot;&gt;Groovy&lt;/a&gt; script.  I was particularly interested
in finding beans of type &lt;code&gt;org.springframework.remoting.httpinvoker.HttpInvokerProxyFactoryBean&lt;/code&gt; class, which have &lt;code&gt;serviceInterface&lt;/code&gt; and &lt;code&gt;serviceUrl&lt;/code&gt; properties, so I wrote a script that loads and parses the
DSL and then loops over each bean definition for beans that contained those properties:&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;listingblock&quot;&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;pre class=&quot;prettyprint groovy language-groovy&quot;&gt;&lt;code&gt;@Grapes([
    @Grab(group=&apos;org.grails&apos;, module=&apos;grails-spring&apos;, version=&apos;2.3.6&apos;),
    @Grab(group=&apos;org.springframework&apos;, module=&apos;spring-web&apos;, version=&apos;4.0.2.RELEASE&apos;)
])

import grails.spring.BeanBuilder

// The resources.groovy file must have:
//
// beans {
//
// and not
// beans = {
//
// for this script to work!

BeanBuilder beanBuilder = new BeanBuilder()
beanBuilder.setClassLoader(this.class.classLoader)
beanBuilder.loadBeans(&apos;file:./grails-app/conf/spring/resources.groovy&apos;)

beanBuilder.springConfig.beanConfigs.each {
    if(it.value.definition.propertyValues.getPropertyValue(&apos;serviceInterface&apos;)) {
        println &quot;${it.key} -&amp;gt; ${it.value.clazz.name}&quot;
        println &quot;\tserviceUrl = ${it.value.definition.propertyValues.getPropertyValue(&apos;serviceUrl&apos;).value}&quot;
        println &quot;\tserviceInterface = ${it.value.definition.propertyValues.getPropertyValue(&apos;serviceInterface&apos;).value}&quot;
    }
}&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;There are a couple of important things to note in the example above:&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;olist arabic&quot;&gt;
&lt;ol class=&quot;arabic&quot;&gt;
&lt;li&gt;
&lt;p&gt;The &lt;code&gt;grails.spring.BeanBuilder&lt;/code&gt; can be used outside of &lt;a href=&quot;http://grails.org&quot;&gt;Grails&lt;/a&gt; applications by including the &lt;code&gt;org.grails:grails-spring&lt;/code&gt; module.&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;The &lt;code&gt;resources.groovy&lt;/code&gt; file (or any file that contains the proper DSL syntax) must have &lt;code&gt;beans&lt;/code&gt; closure be the top level of the DSL and not be a variable (i.e. beans = { &amp;#8230; ) for the script to parse the file correctly.&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;In the example above, I did not provide a full classpath for all of the possible beans in the file.  This means that you cannot create the application context from the builder without getting ClassNotFoundException errors.&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Command line argument parsing could be added to allow for the script to be run from anywhere and not just the root of the Grails application, as is the case in the example above.&lt;/p&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;All and all, this script was pretty easy to create and can be used as part of a larger process to identify, convert and/or even re-write the &lt;code&gt;resources.groovy&lt;/code&gt; file.  Additionally, this
&lt;a href=&quot;http://spring.io/blog/2014/03/03/groovy-bean-configuration-in-spring-framework-4&quot;&gt;DSL has now been incorporated directly into the Spring Framework&lt;/a&gt;), which means that not only can you now declare &lt;a href=&quot;http://spring.io&quot;&gt;Spring&lt;/a&gt; beans via the &lt;a href=&quot;http://groovy.codehaus.org&quot;&gt;Groovy&lt;/a&gt;
DSL just like in &lt;a href=&quot;http://grails.org&quot;&gt;Grails&lt;/a&gt;, but that you could use the same solution above to inspect that configuration outside of the application if the need should arise.&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
            </description>
        </item>
        <item>
            <title>Grails Tattletale Plugin</title>
            <link>http://jdpgrailsdev.github.io/blog//2014/03/12/grails_tattletale_plugin.html</link>
            <pubDate>Wed, 12 Mar 2014 00:00:00 -0400</pubDate>
            <guid isPermaLink="false">/2014/03/12/grails_tattletale_plugin.html</guid>
            <description>
                    &lt;div id=&quot;preamble&quot;&gt;
&lt;div class=&quot;sectionbody&quot;&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;I am pleased to announce that I have officially released the &lt;a href=&quot;http://grails.org/plugin/tattletale&quot;&gt;Grails Tattletale plugin&lt;/a&gt; to the &lt;a href=&quot;http://grails.org/plugins/&quot;&gt;Grails Plugins portal&lt;/a&gt;.&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;Full documentation can be found &lt;a href=&quot;https://github.com/jdpgrailsdev/grails-tattletale/blob/master/README.md&quot;&gt;here&lt;/a&gt;.&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
            </description>
        </item>
        <item>
            <title>Setting system properties when running Grails tests</title>
            <link>http://jdpgrailsdev.github.io/blog//2014/03/11/grails_test_system_properties.html</link>
            <pubDate>Tue, 11 Mar 2014 00:00:00 -0400</pubDate>
            <guid isPermaLink="false">/2014/03/11/grails_test_system_properties.html</guid>
            <description>
                    &lt;div id=&quot;preamble&quot;&gt;
&lt;div class=&quot;sectionbody&quot;&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;We have a &lt;a href=&quot;http://grails.org&quot;&gt;Grails&lt;/a&gt; application that relies on &lt;a href=&quot;http://zookeeper.apache.org/&quot;&gt;Apache ZooKeeper&lt;/a&gt; for some of its data.  This application makes use of the &lt;a href=&quot;http://curator.apache.org/&quot;&gt;Apache Curator&lt;/a&gt; library to connect to &lt;a href=&quot;http://zookeeper.apache.org/&quot;&gt;Apache ZooKeeper&lt;/a&gt;.  The &lt;a href=&quot;http://curator.apache.org/&quot;&gt;Apache Curator&lt;/a&gt; library also includes
a testing server to make it easy to write unit tests for the classes that need to interact with &lt;a href=&quot;http://zookeeper.apache.org/&quot;&gt;Apache ZooKeeper&lt;/a&gt;.  Our &lt;a href=&quot;http://zookeeper.apache.org/&quot;&gt;Apache ZooKeeper&lt;/a&gt; implementation makes uses of SASL-based authentication to prevent
unwanted access to different parts of the data stored in &lt;a href=&quot;http://zookeeper.apache.org/&quot;&gt;Apache ZooKeeper&lt;/a&gt;.  Unfortunately, the ability to set which configuration file to use when connecting to &lt;a href=&quot;http://zookeeper.apache.org/&quot;&gt;Apache ZooKeeper&lt;/a&gt; is set via JVM system
properties.  This is fine when the application is running, but can make unit testing difficult, as developers have to remember to set the appropriate system properties before executing unit
test.  Luckily, &lt;a href=&quot;http://grails.org&quot;&gt;Grails&lt;/a&gt; has a nice events framework that fires as certain stages in execution are hit.  I decided that it would be trivial to add an event hook that listens for the
start of the test phase and sets the appropriate system properties required to simulate the same access control when interacting with the &lt;a href=&quot;http://curator.apache.org/&quot;&gt;Apache Curator&lt;/a&gt; test server.  I made the following modification
to the &lt;code&gt;scripts/Events.groovy&lt;/code&gt; file in the &lt;a href=&quot;http://grails.org&quot;&gt;Grails&lt;/a&gt; application:&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;listingblock&quot;&gt;
&lt;div class=&quot;title&quot;&gt;scripts/Events.groovy&lt;/div&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;pre class=&quot;prettyprint groovy language-groovy&quot;&gt;&lt;code&gt;eventTestPhaseStart = { args -&amp;gt;
    //Add the required ZooKeeper auth system properties so that tests will pass!
    System.setProperty(&apos;java.security.auth.login.config&apos;, &quot;${System.getProperty(&apos;user.dir&apos;)}/test/unit/jaas_test.config&quot;)
    System.setProperty(&apos;zookeeper.authProvider.1&apos;, &apos;org.apache.zookeeper.server.auth.SASLAuthenticationProvider&apos;)
    grailsConsole.addStatus &quot;Running tests with the following system properties:&quot;
    grailsConsole.addStatus &quot;${System.getProperties()}&quot;
}&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;The above event is fired right before the first test is executed by &lt;a href=&quot;http://grails.org&quot;&gt;Grails&lt;/a&gt; when using the &lt;code&gt;grails test-app&lt;/code&gt; command.  It sets the login configuration file to
one that is packaged within the project and sets the &lt;code&gt;authProvider&lt;/code&gt; to the appropriate type (in our case, SASL).  There are many other events that you can listen
for in order to perform logic upon firing.  You can see more information about &lt;a href=&quot;http://grails.org&quot;&gt;Grails&lt;/a&gt; events in the &lt;a href=&quot;http://grails.org/doc/2.3.x/guide/commandLine.html#events&quot;&gt;documentation&lt;/a&gt; or
by looking through the &lt;a href=&quot;http://gant.codehaus.org/&quot;&gt;Gant&lt;/a&gt; scripts in the &lt;code&gt;scripts&lt;/code&gt; folder of the &lt;a href=&quot;http://grails.org&quot;&gt;Grails&lt;/a&gt; installation.&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
            </description>
        </item>
        <item>
            <title>Integrating JBoss tattletale with Grails</title>
            <link>http://jdpgrailsdev.github.io/blog//2014/03/04/grails_tattletale.html</link>
            <pubDate>Tue, 4 Mar 2014 00:00:00 -0500</pubDate>
            <guid isPermaLink="false">/2014/03/04/grails_tattletale.html</guid>
            <description>
                    &lt;div id=&quot;preamble&quot;&gt;
&lt;div class=&quot;sectionbody&quot;&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;Prior to version 2.3 of the &lt;a href=&quot;http://grails.org&quot;&gt;Grails&lt;/a&gt; Framework, it was difficult, if not impossible, to use &lt;a href=&quot;http://maven.apache.org/&quot;&gt;Maven&lt;/a&gt; to build a &lt;a href=&quot;http://grails.org&quot;&gt;Grails&lt;/a&gt;-based application or plugin.  Besides losing the obvious benefits of &lt;a href=&quot;http://maven.apache.org/&quot;&gt;Maven&lt;/a&gt;-based builds,
such as dependency management and the rich ecosystem of existing plugins, one of the things that is lacking is an easy way to enforce environmental constraints, such as with the &lt;a href=&quot;http://maven.apache.org/enforcer/maven-enforcer-plugin/&quot;&gt;Maven Enforcer plugin&lt;/a&gt;. The &lt;a href=&quot;http://maven.apache.org/enforcer/maven-enforcer-plugin/&quot;&gt;Maven Enforcer plugin&lt;/a&gt;
includes the ability to &lt;a href=&quot;http://mojo.codehaus.org/extra-enforcer-rules/banDuplicateClasses.html&quot;&gt;fail a build when detecting multiple versions of the same class on the classpath&lt;/a&gt;.  This is particularly handy when an
application depends on libraries that include classes from another library in order to reduce the number of required dependencies (this is particularly common with libraries that are not published to a &lt;a href=&quot;http://maven.apache.org/&quot;&gt;Maven&lt;/a&gt;
repository or some other type of dependency management repository).  Since using the &lt;a href=&quot;http://maven.apache.org/enforcer/maven-enforcer-plugin/&quot;&gt;Maven Enforcer plugin&lt;/a&gt; is not an option in applications using &lt;a href=&quot;http://grails.org&quot;&gt;Grails&lt;/a&gt; &amp;lt;2.3, I decided to look at other alternatives to provide the
duplicate class checking functionality.&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;sect2&quot;&gt;
&lt;h3 id=&quot;_jboss_tattletale&quot;&gt;JBoss tattletale&lt;/h3&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;&lt;a href=&quot;http://www.jboss.org/tattletale&quot;&gt;JBoss tattletale&lt;/a&gt; is a similar project to the &lt;a href=&quot;http://maven.apache.org/enforcer/maven-enforcer-plugin/&quot;&gt;Maven Enforcer plugin&lt;/a&gt; in that it provides many of the same analytics with regards to the classes and dependencies that are part of a Java library/application.  In addition to its
feature set, &lt;a href=&quot;http://www.jboss.org/tattletale&quot;&gt;JBoss tattletale&lt;/a&gt; also has the ability to be embedded/called programmatically, which is a must for integrating it into a &lt;a href=&quot;http://grails.org&quot;&gt;Grails&lt;/a&gt; &lt;a href=&quot;http://gant.codehaus.org/&quot;&gt;Gant&lt;/a&gt; script.  The first step to including a &lt;a href=&quot;http://grails.org&quot;&gt;Grails&lt;/a&gt; command line target
that can perform the &lt;a href=&quot;http://www.jboss.org/tattletale&quot;&gt;JBoss tattletale&lt;/a&gt; analysis is to include the &lt;a href=&quot;http://www.jboss.org/tattletale&quot;&gt;JBoss tattletale&lt;/a&gt; dependency as a &lt;code&gt;build&lt;/code&gt; scoped dependency:&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;listingblock&quot;&gt;
&lt;div class=&quot;title&quot;&gt;BuildConfig.groovy&lt;/div&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;pre class=&quot;prettyprint groovy language-groovy&quot;&gt;&lt;code&gt;grails.project.dependency.resolution = {

    ...

    dependencies {

        // Required to generate the TattleTale report by the TattleTale GANT script.
        build &apos;org.jboss.tattletale:tattletale:1.1.2.Final&apos;

        ...
    }
}&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;This makes the dependency available to the &lt;a href=&quot;http://gant.codehaus.org/&quot;&gt;Gant&lt;/a&gt; script without exporting the dependency when the application or plugin is package (or in the case of a plugin, the dependency is not added to the classpath when it is
consumed by a &lt;a href=&quot;http://grails.org&quot;&gt;Grails&lt;/a&gt; application).  The next step is to write a &lt;a href=&quot;http://gant.codehaus.org/&quot;&gt;Gant&lt;/a&gt; script that performs the &lt;a href=&quot;http://www.jboss.org/tattletale&quot;&gt;JBoss tattletale&lt;/a&gt; analysis.  Below is an example script that I wrote that expands the packaged application, runs the analysis
and then outputs the HTML report to the &lt;code&gt;target/tattletale-report&lt;/code&gt; directory:&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;listingblock&quot;&gt;
&lt;div class=&quot;title&quot;&gt;scripts/TattleTale.groovy&lt;/div&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;pre class=&quot;prettyprint groovy language-groovy&quot;&gt;&lt;code&gt;import org.jboss.tattletale.Main

includeTargets &amp;lt;&amp;lt; grailsScript(&quot;_GrailsArgParsing&quot;)
includeTargets &amp;lt;&amp;lt; grailsScript(&quot;_GrailsSettings&quot;)
includeTargets &amp;lt;&amp;lt; grailsScript(&quot;_GrailsClasspath&quot;)

// Default list of comma separated report names to generate.
DEFAULT_REPORTS=&apos;multiplejars&apos;

// Default list of comma separated JAR files to exclude.  These JARS are from the Grails global dependencies,
// so there is not a lot we can do about resolving duplicate classes from the JAR files.
DEFAULT_EXCLUDES=&apos;commons-beanutils-1.8.3.jar,commons-logging-1.1.1.jar,aspectjrt-1.6.10.jar,grails-plugin-controllers-2.0.3.jar&apos;

/*
 * Target used to generated the TattleTale (http://www.jboss.org/tattletale/) report for the encapsulating Grails application.
 * The application&apos;s archive (WAR file) MUST be built prior to running this script to invoke the TattleTale report.  If
 * the WAR file is present, the following steps are performed:
 *
 *     1) The previous report is deleted.
 *     2) The archive is unzipped to the target directory of the application.
 *     3) The TattleTale report(s) are generated.
 *     4) The expanded archive is deleted.
 *
 * The TattleTale reports that are generated can be configured by running the script with the following option:
 *
 *     grails tattleTale --reports=mulitplelocations,multiplejars
 *
 * The files that are scanned by TattleTale can be configured by adding additional exclusions via an argument:
 *
 *     grails tattleTale --excludes=foo.jar,bar.jar
 *
 * See the TattleTale User&apos;s Guide for information about the available reports (http://docs.jboss.org/tattletale/userguide/1.1/html_single/#maven_report).
 */
target(tattleTale: &quot;Called from build jobs on Hudson to perform a TattleTale analysis on the application&apos;s archive.&quot;) {
    parseArguments()

    def appName = metadata[&apos;app.name&apos;]
    def reports = argsMap.reports ?: DEFAULT_REPORTS
    def excludes = argsMap.excludes ? &quot;${DEFAULT_EXCLUDES},${argsMap.excludes}&quot; : DEFAULT_EXCLUDES
    def archiveFile = &quot;target/${appName}.war&quot;
    def expandedArchiveDir = &quot;target/${appName}&quot;
    def reportDir = &apos;target/tattletale-report&apos;

    if(new File(archiveFile).exists()) {
        ant.delete(dir:reportDir, failonerror:&quot;false&quot;, verbose:&quot;true&quot;)
        grailsConsole.addStatus &quot;************ Unzipping application archive &apos;${archiveFile}&apos;...&quot;
        ant.unzip(src: archiveFile , dest:expandedArchiveDir, overwrite:&quot;true&quot;)
        grailsConsole.addStatus &quot;************ Running TattleTask report for &apos;${appName}&apos;...&quot;
        executeTattleTale(&quot;${expandedArchiveDir}/WEB-INF/lib&quot;, reportDir, reports, excludes)
        grailsConsole.addStatus &quot;************ Removing expanded archive for application &apos;${appName}&apos;...&quot;
        ant.delete(dir:expandedArchiveDir, failonerror:&quot;false&quot;, verbose:&quot;true&quot;)
        grailsConsole.addStatus &quot;************ Duplicate class check for application &apos;${appName}&apos; completed.&quot;
        grailsConsole.addStatus &quot;************ TattleTale report available in &apos;${new File(reportDir).absolutePath}/index.html&apos;...&quot;
    } else {
        grailsConsole.warn &quot;Application archive file ${archiveFile} does NOT exist.  Nothing to report!  Please build the WAR file before running this script.&quot;
    }
}

/**
 * Executes the TattleTale report.
 * @param source The source directory containing JAR files.
 * @param destination The output destination directory for the generated report(s).
 * @param reports The comma separated string containing the names of the reports to generate.
 * @param excludes The comma separated string containing the names of directories or files to exludes
 */
private def executeTattleTale(def source, def destination, def reports, def excludes) {
    def tattleTale = new Main()
    tattleTale.source = source
    tattleTale.destination = destination
    tattleTale.reports = reports
    tattleTale.excludes = excludes
    tattleTale.profiles = &apos;spring30,java6&apos;
    tattleTale.execute()
}

setDefaultTarget(tattleTale)&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;Note that the script above requires the user to first run &lt;code&gt;grails war&lt;/code&gt; or &lt;code&gt;grails package-plugin&lt;/code&gt; prior to running the &lt;code&gt;grails tattletale&lt;/code&gt; target command.  It is also possible to hook into the &lt;a href=&quot;http://grails.org&quot;&gt;Grails&lt;/a&gt; events that get fired to perform the analysis after
compilation has been completed, which would avoid the need to expand the packaged WAR file.  Regardless of how you choose to implement the execution of &lt;a href=&quot;http://www.jboss.org/tattletale&quot;&gt;JBoss tattletale&lt;/a&gt;, the end result is still valuable.&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
            </description>
        </item>
        <item>
            <title>Programmatically building CKEditor source in Grails</title>
            <link>http://jdpgrailsdev.github.io/blog//2014/02/25/grails_gant_ckeditor.html</link>
            <pubDate>Tue, 25 Feb 2014 00:00:00 -0500</pubDate>
            <guid isPermaLink="false">/2014/02/25/grails_gant_ckeditor.html</guid>
            <description>
                    &lt;div id=&quot;preamble&quot;&gt;
&lt;div class=&quot;sectionbody&quot;&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;The &lt;a href=&quot;http://grails.org&quot;&gt;Grails&lt;/a&gt; Framework has some interesting quirks, particular when it comes to dependency management and build/deploy.  With a &lt;a href=&quot;http://grails.org&quot;&gt;Grails&lt;/a&gt; plugin, you can define dependencies in its &lt;code&gt;BuildConfig.groovy&lt;/code&gt; source file or you can place Java JAR files in the &lt;code&gt;lib&lt;/code&gt;
directory of the plugin.  Either will get included in the packaged plugin (and by extension, the packaged WAR of the application that includes the plugin) unless other special steps are taken to preclude them at package time.  This became an issue for me
recently when using the builder provided by &lt;a href=&quot;http://ckeditor.com/&quot;&gt;CKEditor&lt;/a&gt; within a &lt;a href=&quot;http://grails.org&quot;&gt;Grails&lt;/a&gt; plugin to compile from source the &lt;a href=&quot;http://ckeditor.com/&quot;&gt;CKEditor&lt;/a&gt; JavaScript files.  We had originally put the &lt;a href=&quot;http://ckeditor.com/&quot;&gt;CKEditor&lt;/a&gt; builder JAR in the &lt;code&gt;lib&lt;/code&gt; folder of a plugin, as the &lt;a href=&quot;http://ckeditor.com/&quot;&gt;CKEditor&lt;/a&gt; project does not
publish its artifacts to &lt;a href=&quot;http://maven.apache.org/&quot;&gt;Maven&lt;/a&gt;.  This worked fine until we happened to update the version of &lt;a href=&quot;http://code.google.com/p/guava-libraries/&quot;&gt;Guava&lt;/a&gt; that the plugin depended on.  The net result of this was a fun game of classpath roulette, as the builder JAR provided by &lt;a href=&quot;http://ckeditor.com/&quot;&gt;CKEditor&lt;/a&gt; includes copies of
an older version of &lt;a href=&quot;http://code.google.com/p/guava-libraries/&quot;&gt;Guava&lt;/a&gt; inside its JAR (don&amp;#8217;t get me started on this).  I was able to determine this by using JBoss&amp;#8217;s &lt;a href=&quot;http://www.jboss.org/tattletale&quot;&gt;http://www.jboss.org/tattletale&lt;/a&gt; library to check for duplicate classes on the classpath (In a future post, I will talk about how I added
JBoss&amp;#8217;s &lt;a href=&quot;http://www.jboss.org/tattletale&quot;&gt;tattletale&lt;/a&gt; to our &lt;a href=&quot;http://grails.org&quot;&gt;Grails&lt;/a&gt; builds to check for duplicate classes on the classpath, though it less important in &lt;a href=&quot;http://grails.org&quot;&gt;Grails&lt;/a&gt; 2.3+, where you can use &lt;a href=&quot;http://maven.apache.org/&quot;&gt;Maven&lt;/a&gt; POM files and the enforcer plugin to do the same thing).  Because
we had the JAR in the &lt;code&gt;lib&lt;/code&gt; directory, it gets included on the classpath and packaged in the WAR, but does not get conflict resolved with any dependencies included in the &lt;code&gt;BuildConfig.groovy&lt;/code&gt; file.  Obviously, &lt;a href=&quot;https://ant.apache.org/ivy/&quot;&gt;Ivy&lt;/a&gt; only knows about the dependencies declared
in the closures in &lt;code&gt;BuildConfig.groovy&lt;/code&gt;.&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;sect2&quot;&gt;
&lt;h3 id=&quot;_build_scope_to_the_rescue&quot;&gt;Build Scope to the rescue&lt;/h3&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;I decided that the best way to fix this was to make use of the &lt;code&gt;build&lt;/code&gt; dependency scope supported by &lt;a href=&quot;http://grails.org&quot;&gt;Grails&lt;/a&gt;/https://ant.apache.org/ivy/[Ivy], which does not allow the dependency to be included in the packaged artifact.  This first meant pushing
the &lt;a href=&quot;http://ckeditor.com/&quot;&gt;CKEditor&lt;/a&gt; builder JAR file into our &lt;a href=&quot;http://maven.apache.org/&quot;&gt;Maven&lt;/a&gt; repository and then adding the following to the &lt;code&gt;dependencies&lt;/code&gt; block in &lt;code&gt;BuildConfig.groovy&lt;/code&gt;:&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;listingblock&quot;&gt;
&lt;div class=&quot;title&quot;&gt;BuildConfig.groovy&lt;/div&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;pre class=&quot;prettyprint groovy language-groovy&quot;&gt;&lt;code&gt;grails.project.dependency.resolution = {

    ...

    dependencies {
        // Required to build/package ckeditor
        build &apos;com.ckeditor:ckbuilder:1.6.1&apos;

        ...
    }
}&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;The next step was to modify the &lt;a href=&quot;http://gant.codehaus.org/&quot;&gt;Gant&lt;/a&gt; script that we wrote to perform the &lt;a href=&quot;http://ckeditor.com/&quot;&gt;CKEditor&lt;/a&gt; compilation to programmatically invoke the &lt;a href=&quot;http://ckeditor.com/&quot;&gt;CKEditor&lt;/a&gt; builder instead of executing a command:&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;listingblock&quot;&gt;
&lt;div class=&quot;title&quot;&gt;scripts/PackageCkeditor.groovy&lt;/div&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;pre class=&quot;prettyprint groovy language-groovy&quot;&gt;&lt;code&gt;import ckbuilder.ckbuilder

target(packageCkeditor: &quot;Packages the CKEditor for inclusion as a dependency.&quot;) {
    String srcPath  = &apos;web-app/js/ckeditor-source&apos;
    String destPath = &apos;web-app/js/ckeditor&apos;
    String version  = &apos;4.0.0&apos;

    grailsConsole.addStatus &quot;Compiling CKEditor from source...&quot;
    ckbuilder.main([&quot;--build&quot;, &quot;${myPluginDir}/${srcPath}/&quot;, &quot;${myPluginDir}/${destPath}&quot;, &quot;--version=${version}&quot;,
            &quot;--build-config&quot;, &quot;${myPluginDir}/${srcPath}/dev/builder/ddc-build-config.js&quot;, &quot;--overwrite&quot;, &quot;--skip-omitted-in-build-config&quot;] as String[])

    grailsConsole.updateStatus &quot;Moving compiled CKEditor to target directory...&quot;
    ant.move(file: &quot;${myPluginDir}/${destPath}/ckeditor&quot;,
             tofile: &quot;${myPluginDir}/${destPath}&quot;,
             overwrite: true)

    grailsConsole.updateStatus &quot;Removing CKEditor archive artifacts...&quot;
    ant.delete(file: &quot;${myPluginDir}/${destPath}/ckeditor_${version.toLowerCase()}.zip&quot;)
    ant.delete(file: &quot;${myPluginDir}/${destPath}/ckeditor_${version.toLowerCase()}.tar.gz&quot;)

    grailsConsole.updateStatus &quot;CKEditor successfully compiled and ready to deploy.&quot;
}

setDefaultTarget(packageCkeditor)&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;The example above makes use of the &lt;code&gt;main()&lt;/code&gt; method of the &lt;code&gt;ckeditor&lt;/code&gt; class provided by the builder to invoke the &lt;a href=&quot;http://ckeditor.com/&quot;&gt;CKEditor&lt;/a&gt; compilation.  I tested it out and noticed that
none of my console statements after the call to &lt;code&gt;main()&lt;/code&gt; were being executed.  I quickly realized that something in the &lt;a href=&quot;http://ckeditor.com/&quot;&gt;CKEditor&lt;/a&gt; code was executing &lt;code&gt;System.exit()&lt;/code&gt;, which in turn
ended up killing the &lt;a href=&quot;http://grails.org&quot;&gt;Grails&lt;/a&gt; process.&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;sect2&quot;&gt;
&lt;h3 id=&quot;_open_only_in_case_of_emergency&quot;&gt;Open only in case of emergency&lt;/h3&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;To avoid this premature exit, I decided to add a temporary custom &lt;code&gt;SecurityManager&lt;/code&gt; that does not allow exits to happen:&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;listingblock&quot;&gt;
&lt;div class=&quot;title&quot;&gt;scripts/PackageCkeditor.groovy&lt;/div&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;pre class=&quot;prettyprint groovy language-groovy&quot;&gt;&lt;code&gt;import ckbuilder.ckbuilder

target(packageCkeditor: &quot;Packages the CKEditor for inclusion as a dependency.&quot;) {
    String srcPath  = &apos;web-app/js/ckeditor-source&apos;
    String destPath = &apos;web-app/js/ckeditor&apos;
    String version  = &apos;4.0.0&apos;

    grailsConsole.addStatus &quot;Compiling CKEditor from source...&quot;

    /*
     * The CKEditor builder calls System.exit().  Therefore,
     * we need a custom security manager to prevent it from
     * killing the Grails process too.  The code below
     * saves off the current security manager, sets the JVM
     * to use the custom no-exits-allowed manager and then
     * restores it after attempting to build CKEditor.
     */
    def defaultSecurityManager = System.getSecurityManager()
    System.setSecurityManager(new NoExitSecurityManager())

    try {
        ckbuilder.main([&quot;--build&quot;, &quot;${myPluginDir}/${srcPath}/&quot;, &quot;${myPluginDir}/${destPath}&quot;, &quot;--version=${version}&quot;,
            &quot;--build-config&quot;, &quot;${myPluginDir}/${srcPath}/dev/builder/ddc-build-config.js&quot;, &quot;--overwrite&quot;, &quot;--skip-omitted-in-build-config&quot;] as String[])
    } catch (e) {
        if(!(e instanceof SecurityException)) {
            grailsConsole.addStatus(&quot;Failed to execute CKEditor build: ${e.getMessage()}&quot;)
        }
    } finally {
        // Restore the security manager
        System.setSecurityManager(defaultSecurityManager)
    }

    grailsConsole.updateStatus &quot;Moving compiled CKEditor to target directory...&quot;
    ant.move(file: &quot;${myPluginDir}/${destPath}/ckeditor&quot;,
             tofile: &quot;${myPluginDir}/${destPath}&quot;,
             overwrite: true)

    grailsConsole.updateStatus &quot;Removing CKEditor archive artifacts...&quot;
    ant.delete(file: &quot;${myPluginDir}/${destPath}/ckeditor_${version.toLowerCase()}.zip&quot;)
    ant.delete(file: &quot;${myPluginDir}/${destPath}/ckeditor_${version.toLowerCase()}.tar.gz&quot;)

    grailsConsole.updateStatus &quot;CKEditor successfully compiled and ready to deploy.&quot;
}

setDefaultTarget(packageCkeditor)

/**
 * Custom &quot;no exits allowed&quot; security manager implementation.
 */
class NoExitSecurityManager extends SecurityManager {

    @Override
    public void checkExit(int status) {
        throw new SecurityException(&apos;Exit not allowed.&apos;)
    }

    @Override
    public void checkPermission(Permission perm) {
        // Allow all!
    }
}&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;The revamped code above now uses a custom &lt;code&gt;SecurityManager&lt;/code&gt; that does not allow the exit to happen.  While this is not the cleanest approach (I would have liked to have modified the &lt;a href=&quot;http://ckeditor.com/&quot;&gt;CKEditor&lt;/a&gt;
builder code, but they have not open sourced the builder&amp;#8201;&amp;#8212;&amp;#8201;only the editor itself), it gets the job done.  Now, we can use the &lt;a href=&quot;http://ckeditor.com/&quot;&gt;CKEditor&lt;/a&gt; programmatically and let &lt;a href=&quot;https://ant.apache.org/ivy/&quot;&gt;Ivy&lt;/a&gt; manage the dependency
the dependency, ensure that it does not get included in the packaged artifact and still be able to compile the source as part of our builds.&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
            </description>
        </item>
    </channel>
</rss>
